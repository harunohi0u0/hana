<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매매일지 & 가계부</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-color 0.3s ease;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { background-color: #4a90e2; color: white; font-weight: 700; }
        .tag { transition: all 0.2s ease; cursor: pointer; }
        .tag.selected { background-color: #4a90e2; color: white; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        .toggle-group { display: flex; border-radius: 0.75rem; padding: 0.25rem; background-color: #e5e7eb; }
        .toggle-btn { flex: 1; padding: 0.5rem 0; border-radius: 0.5rem; border: none; background-color: transparent; font-weight: 500; transition: all 0.2s ease-in-out; cursor: pointer; }
        .toggle-btn.selected { background-color: white; color: #3b82f6; font-weight: 700; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        .tag.selected .delete-tag-span { color: white; }
        .tag.selected .delete-tag-span:hover { color: #fecaca; }

        .dark body { background-color: #111827; color: #d1d5db; }
        .dark h1, .dark h2, .dark h3 { color: #f9fafb; }
        .dark p, .dark label, .dark span, .dark strong { color: #d1d5db; }
        .dark header p, .dark .text-gray-500, .dark .main-tab-btn { color: #9ca3af; }
        .dark .main-tab-btn.active { color: #60a5fa; border-color: #60a5fa;}
        .dark #auth-info { color: #6b7280; }
        .dark #theme-toggle:hover, .dark #logout-btn:hover { background-color: #374151; }
        .dark nav, .dark form, .dark .bg-white, .dark #journal-container > div:first-child, .dark #ledger-container > div:first-child { background-color: #1f2937; }
        .dark .tab-btn { color: #d1d5db; }
        .dark input, .dark .toggle-group, .dark select { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark input::placeholder { color: #6b7280; }
        .dark .toggle-btn { color: #d1d5db; }
        .dark .toggle-btn.selected { background-color: #4b5563; color: #60a5fa; }
        .dark .tag.selected { background-color: #3b82f6; color: #ffffff; }
        .dark #entry-tags-container .tag.selected { background-color: #16a34a; }
        .dark #psychology-tags-container .tag.selected { background-color: #9333ea; }
        .dark .border-blue-200 { border-color: #1d4ed8; }
        .dark .border-green-200 { border-color: #15803d; }
        .dark .border-purple-200 { border-color: #7e22ce; }
        .dark .bg-blue-50 { background-color: #374151; border-color: #4b5563; }
        .dark .text-blue-800 { color: #d1d5db; }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .text-gray-700 { color: #f3f4f6; }
        .dark .text-gray-600 { color: #d1d5db; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .bg-green-100 { background-color: rgba(16, 185, 129, 0.1); }
        .dark .text-green-800 { color: #34d399; }
        .dark .bg-purple-100 { background-color: rgba(139, 92, 246, 0.1); }
        .dark .text-purple-800 { color: #a78bfa; }
        .dark .border-gray-200 { border-color: #4b5563; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .hover\:bg-gray-100:hover { background-color: #374151; }
        .dark .bg-gray-300 { background-color: #6b7280; }
        .dark .hover\:bg-gray-400:hover { background-color: #9ca3af; }
        .dark #ledger-category-summary > div:hover { background-color: #374151; }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">나의 매매일지 & 가계부 📝</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">당신의 모든 기록을 통해 성장하세요!</p>
            <button id="login-btn" class="bg-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center justify-center">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Google 계정으로 로그인
            </button>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 hidden">
        
        <header class="mb-6 relative flex items-center justify-center">
            <div class="text-center px-16 sm:px-20">
                <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">나의 기록 관리</h1>
                <p class="text-center text-gray-500">매매일지 & 가계부</p>
                <div id="auth-info" class="text-center text-xs mt-2"></div>
            </div>
            <div class="absolute top-0 right-0 flex items-center h-full space-x-2">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i id="sun-icon" data-lucide="sun" class="h-6 w-6"></i><i id="moon-icon" data-lucide="moon" class="h-6 w-6"></i></button>
                <button id="logout-btn" title="로그아웃" class="text-sm font-semibold hover:text-red-500 transition-colors p-2 rounded-md hover:bg-gray-200"><i data-lucide="log-out" class="h-5 w-5"></i></button>
            </div>
        </header>

        <div class="border-b-2 border-gray-200 dark:border-gray-700 mb-8">
            <nav class="-mb-0.5 flex justify-center space-x-6">
                <button data-main-tab="journal-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600 active"><i data-lucide="book-marked" class="w-5 h-5"></i>매매일지</button>
                <button data-main-tab="ledger-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600"><i data-lucide="piggy-bank" class="w-5 h-5"></i>가계부</button>
            </nav>
        </div>

        <div id="journal-container">
            <nav class="flex justify-center bg-white rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2">
                <button data-tab="form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="plus-circle" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>일지 작성</button>
                <button data-tab="list-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="book-open" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>내 일지</button>
                <button data-tab="stats-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="bar-chart-2" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>성과 분석</button>
            </nav>

            <main id="journal-main-content">
                <div id="form-view">
                    <form id="journal-form" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                        <input type="hidden" id="journal-id">
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-blue-200 pb-2 flex items-center"><i data-lucide="clipboard-list" class="mr-3 text-blue-500"></i>기본 정보</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="sm:col-span-2"><label for="ticker" class="block text-sm font-medium text-gray-700 mb-1">종목 이름</label><input type="text" id="ticker" placeholder="예: 삼성전자, BTCUSDT" required class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder-gray-400 text-gray-800"></div>
                                <div><label for="date" class="block text-sm font-medium text-gray-700 mb-1">날짜</label><input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent text-gray-800"></div>
                                <div><span class="block text-sm font-medium text-gray-700 mb-2">포지션</span><div class="toggle-group text-gray-600" data-group="position"><button type="button" data-value="long" class="toggle-btn">🟢 롱</button><button type="button" data-value="short" class="toggle-btn">🔴 숏</button></div></div>
                                <div class="sm:col-span-2"><span class="block text-sm font-medium text-gray-700 mb-2">매매 전략</span><div class="toggle-group text-gray-600" data-group="strategy"><button type="button" data-value="단타" class="toggle-btn">단타</button><button type="button" data-value="스윙" class="toggle-btn">스윙</button><button type="button" data-value="장기" class="toggle-btn">장기</button></div></div>
                                <div class="sm:col-span-2"><span class="block text-sm font-medium text-gray-700 mb-2">입력 통화</span><div class="toggle-group text-gray-600 w-full" data-group="form-currency"><button type="button" id="form-currency-krw-btn" class="toggle-btn selected">원 (₩)</button><button type="button" id="form-currency-usd-btn" class="toggle-btn">달러 ($)</button></div></div>
                                <div><label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">수량</label><input type="text" inputmode="numeric" id="quantity" placeholder="예: 100" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder-gray-400 text-gray-800"></div>
                                <div><label for="entry-price" class="block text-sm font-medium text-gray-700 mb-1">매입가</label><input type="text" inputmode="decimal" id="entry-price" placeholder="예: 10,000" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder-gray-400 text-gray-800"></div>
                                <div><label for="stop-loss" class="block text-sm font-medium text-gray-700 mb-1">손절가</label><input type="text" inputmode="decimal" id="stop-loss" placeholder="예: 9,500" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder-gray-400 text-gray-800"></div>
                                <div><label for="target-price" class="block text-sm font-medium text-gray-700 mb-1">목표가</label><input type="text" inputmode="decimal" id="target-price" placeholder="예: 11,000" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder-gray-400 text-gray-800"></div>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-green-200 pb-2 flex items-center"><i data-lucide="siren" class="mr-3 text-green-500"></i>진입 근거</h2>
                            <div id="entry-tags-container" class="flex flex-wrap gap-2 mb-2"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-entry-tag" placeholder="새로운 태그 추가 (예: 정배열 돌파)" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-green-400 focus:border-transparent placeholder-gray-400 text-gray-800"><button type="button" id="add-entry-tag-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">추가</button></div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-purple-200 pb-2 flex items-center"><i data-lucide="brain-circuit" class="mr-3 text-purple-500"></i>심리 상태</h2>
                            <div id="psychology-tags-container" class="flex flex-wrap gap-2 mb-2"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-psychology-tag" placeholder="새로운 태그 추가 (예: FOMO)" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-purple-400 focus:border-transparent placeholder-gray-400 text-gray-800"><button type="button" id="add-psychology-tag-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">추가</button></div>
                        </div>
                        <div class="flex justify-end space-x-4"><button type="button" id="clear-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">새로 작성</button><button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>일지 저장</button></div>
                    </form>
                </div>

                <div id="list-view" class="hidden">
                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-6 flex flex-wrap items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="list-exchange-rate" class="font-medium text-sm text-gray-600">환율 (USD/KRW):</label>
                            <input type="text" inputmode="numeric" id="list-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white rounded-lg text-center text-gray-800">
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm p-4 rounded-xl mb-6 flex items-center gap-3">
                        <i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i>
                        <p>각 일지 우측 상단의 <i data-lucide="log-out" class="inline-block w-4 h-4 mx-1"></i>(청산), <i data-lucide="edit" class="inline-block w-4 h-4 mx-1"></i>(수정), <i data-lucide="trash-2" class="inline-block w-4 h-4 mx-1"></i>(삭제) 아이콘을 눌러 관리할 수 있습니다.</p>
                    </div>
                    <div id="journal-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                
                <div id="stats-view" class="hidden space-y-8">
                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-6 flex flex-col sm:flex-row items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="stats-exchange-rate" class="font-medium text-sm text-gray-600">환율 (USD/KRW):</label>
                            <input type="text" inputmode="numeric" id="stats-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white rounded-lg text-center text-gray-800">
                        </div>
                        <div class="toggle-group text-gray-600 w-full sm:w-auto" data-group="stats-currency">
                            <button id="stats-currency-krw-btn" class="toggle-btn selected">원 (₩)</button>
                            <button id="stats-currency-usd-btn" class="toggle-btn">달러 ($)</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <h3 class="text-xl font-bold mb-3 text-gray-700">총 승률</h3>
                            <p id="total-win-rate" class="text-4xl font-bold text-blue-500">N/A</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <h3 class="text-xl font-bold mb-3 text-gray-700">평균 손익비</h3>
                            <p id="average-pl-ratio" class="text-4xl font-bold text-green-500">N/A</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-1"><h3 class="text-xl font-bold mb-4">총 손익 구성</h3><div class="chart-container"><canvas id="pnl-composition-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-2"><h3 class="text-xl font-bold mb-4">월별 손익 추세</h3><div class="chart-container"><canvas id="monthly-pnl-chart"></canvas></div><div id="monthly-pnl-summary" class="mt-4 text-sm text-center"></div></div>
                    </div>
                    <div class="grid grid-cols-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">분기별 손익 추세</h3><div class="chart-container"><canvas id="quarterly-pnl-chart"></canvas></div><div id="quarterly-pnl-summary" class="mt-4 text-sm text-center"></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">진입 근거별 승률</h3><div class="chart-container"><canvas id="entry-win-rate-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">심리 상태별 승률</h3><div class="chart-container"><canvas id="psychology-win-rate-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">매매 전략별 승률</h3><div class="chart-container"><canvas id="strategy-win-rate-chart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">롱/숏 포지션 승률</h3><div class="chart-container"><canvas id="position-win-rate-chart"></canvas></div></div>
                    </div>
                </div>
            </main>
        </div>

        <div id="ledger-container" class="hidden">
            <nav class="flex justify-center bg-white rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2">
                <button data-ledger-tab="ledger-form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="plus-circle" class="inline-block w-5 h-5 mr-2"></i>내역 입력</button>
                <button data-ledger-tab="ledger-list-view" class="tab-btn text-gray-600 w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="list" class="inline-block w-5 h-5 mr-2"></i>상세 내역</button>
                <button data-ledger-tab="ledger-stats-view" class="tab-btn text-gray-600 w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="pie-chart" class="inline-block w-5 h-5 mr-2"></i>통계 분석</button>
            </nav>

            <main id="ledger-main-content">
                <div id="ledger-form-view">
                    <form id="ledger-form" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                        <input type="hidden" id="ledger-id">
                        <div>
                            <h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="edit-3" class="mr-3 text-blue-500"></i>가계부 내역 입력</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="sm:col-span-2">
                                    <div class="toggle-group text-gray-600" data-group="ledger-type">
                                        <button type="button" data-value="expense" class="toggle-btn selected">💸 지출</button>
                                        <button type="button" data-value="income" class="toggle-btn">💰 수입</button>
                                    </div>
                                </div>
                                <div><label for="ledger-date" class="block text-sm font-medium text-gray-700 mb-1">날짜</label><input type="date" id="ledger-date" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div><label for="ledger-amount" class="block text-sm font-medium text-gray-700 mb-1">금액</label><input type="text" inputmode="numeric" id="ledger-amount" placeholder="금액 입력" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div class="sm:col-span-2" id="ledger-category-section">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">카테고리</label>
                                    <div id="ledger-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <input type="text" id="new-ledger-category" placeholder="새로운 카테고리 추가 (예: 식비)" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white">
                                        <button type="button" id="add-ledger-category-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">카테고리 추가</button>
                                    </div>
                                </div>
                                <div class="sm:col-span-2"><label for="ledger-memo" class="block text-sm font-medium text-gray-700 mb-1">메모 (선택)</label><input type="text" id="ledger-memo" placeholder="메모 내용" class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="clear-ledger-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">새로 작성</button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>내역 저장</button>
                        </div>
                    </form>
                </div>

                <div id="ledger-list-view" class="hidden space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-wrap items-center justify-center gap-4">
                        <select id="ledger-list-filter-type" class="p-2 border border-gray-300 rounded-lg">
                            <option value="month">월별</option>
                            <option value="quarter">분기별</option>
                            <option value="year">연도별</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <button id="ledger-list-prev-btn" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-left"></i></button>
                            <span id="ledger-list-period-display" class="font-bold text-lg w-40 text-center"></span>
                            <button id="ledger-list-next-btn" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">카테고리별 지출</h3>
                            <div id="ledger-category-summary" class="space-y-2"></div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">상세 내역: <span id="ledger-detail-title">카테고리를 선택하세요</span></h3>
                            <div id="ledger-entry-details" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="ledger-stats-view" class="hidden space-y-8">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <h3 class="text-lg font-bold mb-2 text-green-500">총 수입</h3>
                            <p id="ledger-total-income" class="text-3xl font-bold">₩0</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <h3 class="text-lg font-bold mb-2 text-red-500">총 지출</h3>
                            <p id="ledger-total-expense" class="text-3xl font-bold">₩0</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                            <h3 class="text-lg font-bold mb-2 text-blue-500">합계</h3>
                            <p id="ledger-balance" class="text-3xl font-bold">₩0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-3">
                            <h3 class="text-xl font-bold mb-4">월별 수입/지출 추이 (연간)</h3>
                            <div class="chart-container"><canvas id="ledger-monthly-pnl-chart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-2">
                            <h3 class="text-xl font-bold mb-4">카테고리별 지출 구성 (연간)</h3>
                            <div class="chart-container"><canvas id="ledger-category-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <h2 class="text-2xl font-bold mb-6">청산 기록</h2>
            <form id="exit-form"><input type="hidden" id="exit-journal-id">
                <div class="space-y-4">
                    <div><label for="exit-date" class="block text-sm font-medium text-gray-700">청산 날짜</label><input type="date" id="exit-date" required class="mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg text-gray-800"></div>
                    <div><label for="exit-price" class="block text-sm font-medium text-gray-700">청산가</label><input type="text" inputmode="decimal" id="exit-price" required class="number-input mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg text-gray-800"></div>
                    <div><label for="exit-quantity" class="block text-sm font-medium text-gray-700">청산 수량</label><input type="text" inputmode="numeric" id="exit-quantity" required class="number-input mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg text-gray-800"><p class="text-xs text-gray-500 mt-1">남은 수량: <span id="remaining-quantity"></span></p></div>
                </div>
                <div class="mt-8 flex justify-end space-x-3"><button type="button" id="close-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">청산 추가</button></div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm modal-content transform scale-95">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">확인</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button type="button" id="confirm-ok-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">확인</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"><p id="toast-message"></p></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDZm5AazCafB0Sb2gd0llv9e3GAhE-nKBw",
          authDomain: "sakurazima-mai-0u0.firebaseapp.com",
          projectId: "sakurazima-mai-0u0",
          storageBucket: "sakurazima-mai-0u0.appspot.com",
          messagingSenderId: "697666115735",
          appId: "1:697666115735:web:7380a588822f771dc071d2",
          measurementId: "G-TZQ9GVFWV5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const Timestamp = firebase.firestore.Timestamp;

        let currentUser = null;
        let charts = {};
        let confirmCallback = null;
        
        // Trading Journal State
        let unsubscribeJournals = null;
        let unsubscribeTags = null;
        let localJournals = [];
        let localTags = { entry: [], psychology: [] };
        let statsCurrency = 'KRW';
        let exchangeRate = 1380;
        
        // Household Ledger State
        let unsubscribeLedger = null;
        let unsubscribeLedgerCategories = null;
        let localLedgerEntries = [];
        let localLedgerCategories = [];
        let ledgerListDate = new Date();

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // ================== Authentication ==================
        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(error => showToast("로그인 실패: " + error.message, "error")));
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('auth-info').textContent = `${user.displayName}님 환영합니다!`;
                initializeAppFunctionality();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeJournals) unsubscribeJournals();
                if (unsubscribeTags) unsubscribeTags();
                if (unsubscribeLedger) unsubscribeLedger();
                if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};
            }
            lucide.createIcons();
        });

        async function initializeAppFunctionality() {
            if (!currentUser) return;
            const userId = currentUser.uid;

            // Init Journal
            await initializeJournalDefaults(userId);
            attachJournalListeners(userId);
            resetForm();

            // Init Ledger
            await initializeLedgerDefaults(userId);
            attachLedgerListeners(userId);
            resetLedgerForm();
        }

        // ================== Main Tab Switching Logic ==================
        document.querySelectorAll('.main-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.mainTab;
                document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('journal-container').classList.toggle('hidden', targetId !== 'journal-container');
                document.getElementById('ledger-container').classList.toggle('hidden', targetId !== 'ledger-container');
                
                if (targetId === 'ledger-container' && currentUser) {
                     renderLedgerListView();
                     renderLedgerStatsView();
                }
                 if (targetId === 'journal-container' && currentUser) {
                    renderJournalStats(localJournals);
                }
            });
        });
        
        // =======================================================
        // ================== TRADING JOURNAL LOGIC ==============
        // =======================================================
        
        const journalForm = document.getElementById('journal-form');
        const journalList = document.getElementById('journal-list');

        async function initializeJournalDefaults(userId) {
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            const tagsDocSnap = await tagsDocRef.get();
            if (!tagsDocSnap.exists) {
                await tagsDocRef.set({
                    entry: ['정배열 돌파', '낙주 매매'],
                    psychology: ['FOMO', '확신']
                });
            }
        }

        function attachJournalListeners(userId) {
            if (unsubscribeJournals) unsubscribeJournals();
            const journalsQuery = db.collection("users").doc(userId).collection("journals").orderBy("date", "desc");
            unsubscribeJournals = journalsQuery.onSnapshot((snapshot) => {
                localJournals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                renderJournals(localJournals);
                renderJournalStats(localJournals);
            }, (error) => console.error("Error fetching journals:", error));

            if (unsubscribeTags) unsubscribeTags();
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            unsubscribeTags = tagsDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    localTags = doc.data();
                    renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
                    renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
                }
            }, (error) => console.error("Error fetching tags:", error));
        }
        
        function switchJournalView(tabId) {
            document.querySelectorAll('#journal-container [data-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            ['form-view', 'list-view', 'stats-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== tabId));
            lucide.createIcons();
            if(tabId === 'stats-view' && currentUser) {
                renderJournalStats(localJournals);
            }
        }
        document.querySelectorAll('#journal-container [data-tab]').forEach(b => b.addEventListener('click', () => switchJournalView(b.dataset.tab)));
        
        journalForm.addEventListener('submit', async (e) => { e.preventDefault(); /* ...Journal form logic... */ });
        // ... (All other trading journal functions: renderJournals, getJournalById, renderJournalTags, handleDeleteJournal, etc.)
        // Note: The original long block of trading journal JS code is assumed to be here for brevity.
        // A placeholder for the trading journal functions.
        function renderJournals(journals) { /* ... implementation ... */ }
        function renderJournalStats(journals) { /* ... implementation ... */ }
        function renderJournalTags(tags, containerId, type) { /* ... implementation ... */ }
        function resetForm() { /* ... implementation ... */ }

        // =======================================================
        // ================== HOUSEHOLD LEDGER LOGIC =============
        // =======================================================

        async function initializeLedgerDefaults(userId) {
            const categoriesDocRef = db.collection("users").doc(userId).collection("ledgerData").doc("categories");
            const docSnap = await categoriesDocRef.get();
            if (!docSnap.exists) {
                await categoriesDocRef.set({
                    list: ['식비', '교통비', '공과금', '구독료', '자기개발비', '오락/여가', '선물']
                });
            }
        }

        function attachLedgerListeners(userId) {
            if (unsubscribeLedger) unsubscribeLedger();
            const ledgerQuery = db.collection("users").doc(userId).collection("ledgerEntries").orderBy("date", "desc");
            unsubscribeLedger = ledgerQuery.onSnapshot((snapshot) => {
                localLedgerEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                renderLedgerListView();
                renderLedgerStatsView();
            }, (error) => console.error("Error fetching ledger entries:", error));

            if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
            const categoriesDocRef = db.collection("users").doc(userId).collection("ledgerData").doc("categories");
            unsubscribeLedgerCategories = categoriesDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    localLedgerCategories = doc.data().list || [];
                    renderLedgerCategoryTags(localLedgerCategories);
                }
            }, (error) => console.error("Error fetching ledger categories:", error));
        }

        function switchLedgerView(tabId) {
            document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.ledgerTab === tabId));
            ['ledger-form-view', 'ledger-list-view', 'ledger-stats-view'].forEach(viewId => document.getElementById(viewId).classList.toggle('hidden', viewId !== tabId));
            if(tabId === 'ledger-list-view') renderLedgerListView();
            if(tabId === 'ledger-stats-view') renderLedgerStatsView();
            lucide.createIcons();
        }
        document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.addEventListener('click', () => switchLedgerView(btn.dataset.ledgerTab)));

        function renderLedgerCategoryTags(categories) {
            const container = document.getElementById('ledger-category-tags-container');
            container.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag bg-gray-200 text-gray-700 rounded-full text-sm inline-flex items-center';
                button.dataset.tag = cat;
                
                const textSpan = document.createElement('span');
                textSpan.className = 'pl-3 pr-2 py-1';
                textSpan.textContent = cat;
                
                const deleteSpan = document.createElement('span');
                deleteSpan.className = 'delete-tag-span pr-2 text-gray-500 hover:text-red-500 transition-colors';
                deleteSpan.innerHTML = `<i data-lucide="x" class="w-3 h-3 pointer-events-none"></i>`;

                button.appendChild(textSpan);
                button.appendChild(deleteSpan);

                button.addEventListener('click', () => {
                    container.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                    button.classList.add('selected');
                });
                deleteSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteLedgerCategory(cat);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
        }

        document.getElementById('add-ledger-category-btn').addEventListener('click', () => {
            const input = document.getElementById('new-ledger-category');
            const newCategory = input.value.trim();
            if (newCategory && !localLedgerCategories.includes(newCategory)) {
                const updatedCategories = [...localLedgerCategories, newCategory];
                db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories")
                  .set({ list: updatedCategories })
                  .then(() => {
                      showToast(`'${newCategory}' 카테고리가 추가되었습니다.`);
                      input.value = '';
                  })
                  .catch(e => showToast("카테고리 추가 실패", "error"));
            } else if (localLedgerCategories.includes(newCategory)) {
                showToast("이미 존재하는 카테고리입니다.", "error");
            }
        });
        
        function handleDeleteLedgerCategory(category) {
            const isCategoryInUse = localLedgerEntries.some(entry => entry.category === category);
            if (isCategoryInUse) {
                showToast("사용 중인 카테고리는 삭제할 수 없습니다. 관련 내역을 먼저 삭제해주세요.", "error");
                return;
            }
            showConfirmModal(`'${category}' 카테고리를 삭제하시겠습니까?`, () => {
                const updatedCategories = localLedgerCategories.filter(c => c !== category);
                db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories")
                  .set({ list: updatedCategories })
                  .then(() => showToast(`'${category}' 카테고리가 삭제되었습니다.`))
                  .catch(e => showToast("카테고리 삭제 실패", "error"));
            }, '삭제');
        }

        document.getElementById('ledger-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const typeBtn = document.querySelector('[data-group="ledger-type"] .toggle-btn.selected');
            const selectedCategoryTag = document.querySelector('#ledger-category-tags-container .tag.selected');
            const amount = parseFloat(unformatNumber(document.getElementById('ledger-amount').value));

            if(typeBtn.dataset.value === 'expense' && !selectedCategoryTag) {
                showToast("지출 카테고리를 선택해주세요.", "error");
                return;
            }
            if(isNaN(amount) || amount <= 0) {
                showToast("올바른 금액을 입력해주세요.", "error");
                return;
            }

            const entryData = {
                type: typeBtn.dataset.value,
                date: Timestamp.fromDate(new Date(document.getElementById('ledger-date').value)),
                amount: amount,
                category: typeBtn.dataset.value === 'expense' ? selectedCategoryTag.dataset.tag : null,
                memo: document.getElementById('ledger-memo').value.trim()
            };

            try {
                await db.collection("users").doc(currentUser.uid).collection("ledgerEntries").add(entryData);
                showToast("내역이 저장되었습니다.");
                resetLedgerForm();
            } catch (error) {
                showToast("저장에 실패했습니다.", "error");
                console.error("Error saving ledger entry: ", error);
            }
        });
        
        function resetLedgerForm() {
            document.getElementById('ledger-form').reset();
            document.getElementById('ledger-date').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('#ledger-category-tags-container .tag.selected').forEach(t => t.classList.remove('selected'));
        }
        document.getElementById('clear-ledger-form-btn').addEventListener('click', resetLedgerForm);

        function renderLedgerListView() { /* ... implementation ... */ }
        function renderLedgerStatsView() { /* ... implementation ... */ }
        
        // ================== Global Event Listeners & Helpers ==================
        
        const unformatNumber = (value) => value.toString().replace(/,/g, '');
        const formatNumber = (value) => { /* ... implementation ... */ };
        function showToast(message, type = 'success') { /* ... implementation ... */ }
        function showConfirmModal(message, callback, type = '삭제') { /* ... implementation ... */ }
        
        document.querySelectorAll('.number-input').forEach(input => {
            input.addEventListener('input', (e) => { e.target.value = formatNumber(e.target.value); });
        });
        document.addEventListener('click', function(event) {
            const button = event.target.closest('.toggle-btn');
            if (button) {
                const group = button.closest('.toggle-group');
                if (group) {
                    group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    // Handle ledger type toggle to show/hide category
                    if (group.dataset.group === 'ledger-type') {
                        document.getElementById('ledger-category-section').style.display = button.dataset.value === 'expense' ? 'block' : 'none';
                    }
                }
            }
        });
        
        window.addEventListener('DOMContentLoaded', () => {
            setTheme(document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            lucide.createIcons();
            switchJournalView('form-view');
            switchLedgerView('ledger-form-view');
        });
        
        function setTheme(theme) { /* ... implementation ... */ }
    </script>
</body>
</html>
