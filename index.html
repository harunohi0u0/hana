<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ & ê°€ê³„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&family=Jua&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Noto Sans KR', sans-serif;
            --font-cute: 'Jua', sans-serif;
        }

        body {
            font-family: var(--font-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Titles use Jua font for that PancakeSwap feel */
        h1, h2, h3, .brand-font {
            font-family: var(--font-cute);
        }

        /* PancakeSwap-like Card Styles */
        .ps-card {
            border-radius: 24px;
            border: 1px solid #e7e3eb;
            box-shadow: 0px 2px 0px 0px #e7e3eb;
            background-color: #ffffff;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Dark Mode Colors (Deep & Complete) */
        .dark body {
            background-color: #08060B; /* Deepest Background */
            color: #F4EEFF;
        }
        .dark .ps-card, .dark .bg-white {
            background-color: #27262C; /* Card Background */
            border-color: #383241;
            box-shadow: 0px 2px 0px 0px #383241;
            color: #F4EEFF;
        }
        
        /* Inputs in Dark Mode */
        .dark input, .dark select, .dark textarea {
            background-color: #372F47; /* Dark Input Bg */
            border-color: #383241;
            color: #F4EEFF;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #9A8FB8;
        }

        /* Text Contrast Fixes for Dark Mode */
        .dark .text-gray-600, .dark .text-gray-500, .dark .text-gray-700 {
            color: #b8add2; /* Soft Lavender for secondary text */
        }
        .dark .text-gray-800, .dark .text-gray-900 {
            color: #F4EEFF; /* White for primary text */
        }
        .dark .bg-gray-50, .dark .bg-gray-100 {
            background-color: #1b1822; /* Very dark contrast block */
        }
        .dark .border-gray-200, .dark .border-gray-300 {
            border-color: #383241;
        }

        /* Tab Navigation (Pancake Style) */
        .main-tab-nav {
            background-color: #EFF4F5;
            border-radius: 16px;
            padding: 4px;
        }
        .dark .main-tab-nav {
            background-color: #372F47;
        }
        .main-tab-btn {
            border-radius: 12px;
            transition: all 0.2s ease;
            font-family: var(--font-cute);
        }
        .main-tab-btn.active {
            background-color: #1FC7D4; /* Pancake Cyan */
            color: white;
            box-shadow: 0px 2px 0px 0px #16939e;
        }
        .dark .main-tab-btn.active {
             background-color: #1FC7D4;
             color: #08060B;
        }
        .main-tab-btn:not(.active):hover {
            background-color: rgba(31, 199, 212, 0.1);
        }

        /* Journal Specific Styles (Restoring V1 Cleanliness) */
        .journal-card-v1 {
            border-left-width: 4px;
            /* V1 styling restored */
        }
        .dark .journal-card-v1 {
            border-top: 1px solid #383241;
            border-right: 1px solid #383241;
            border-bottom: 1px solid #383241;
        }

        /* Utility */
        .toggle-group { display: flex; border-radius: 16px; padding: 2px; background-color: #EFF4F5; }
        .dark .toggle-group { background-color: #372F47; }
        .toggle-btn { flex: 1; padding: 8px 0; border-radius: 14px; border: none; font-weight: 600; transition: all 0.2s; color: #7A6EAA; }
        .dark .toggle-btn { color: #b8add2; }
        .toggle-btn.selected { background-color: #1FC7D4; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .dark .toggle-btn.selected { color: #08060B; }

        .tag { border-radius: 12px; transition: all 0.2s; font-weight: 600; font-size: 0.85rem; }
        .tag.selected { background-color: #7645D9; color: white; } /* Pancake Purple */
        
        .modal-backdrop { background-color: rgba(24, 21, 36, 0.8); backdrop-filter: blur(6px); }
        
        /* Custom Scrollbar for dark mode */
        .dark ::-webkit-scrollbar-track { background: #08060B; }
        .dark ::-webkit-scrollbar-thumb { background: #372F47; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #1FC7D4; }

    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-[#EFF4F5] min-h-screen pb-10">

    <!-- Login View -->
    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center p-10 ps-card max-w-md w-full">
            <div class="text-6xl mb-6">ğŸ¥</div>
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ë§¤ë§¤ì¼ì§€ & ê°€ê³„ë¶€</h1>
            <p class="text-lg text-[#7A6EAA] dark:text-[#b8add2] mb-8 font-medium">ê¸°ë¡ìœ¼ë¡œ ì„±ì¥í•˜ëŠ” ë‹¬ì½¤í•œ ìŠµê´€</p>
            <button id="login-btn" class="w-full bg-[#1FC7D4] text-white font-bold py-4 px-6 rounded-2xl shadow-sm hover:opacity-80 transition-all flex items-center justify-center text-lg">
                <svg class="w-6 h-6 mr-3 bg-white rounded-full p-1" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6 hidden">
        
        <header class="mb-8 relative flex items-center justify-center pt-4">
            <div class="text-center px-4">
                <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-2 text-[#280D5F] dark:text-[#F4EEFF]">ë‚˜ì˜ ê¸°ë¡ ê´€ë¦¬ ğŸ°</h1>
                <div id="auth-info" class="text-center text-sm font-bold text-[#7A6EAA] dark:text-[#9A8FB8] bg-white dark:bg-[#27262C] px-4 py-1 rounded-full inline-block border border-[#e7e3eb] dark:border-[#383241]"></div>
            </div>
            <div class="absolute top-4 right-0 flex items-center space-x-2 bg-white dark:bg-[#27262C] p-2 rounded-2xl shadow-sm border border-[#e7e3eb] dark:border-[#383241]">
                <button id="theme-toggle" class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-[#372F47] transition-colors text-[#FFB237]"><i id="sun-icon" data-lucide="sun" class="h-5 w-5"></i><i id="moon-icon" data-lucide="moon" class="h-5 w-5"></i></button>
                <div class="w-px h-4 bg-gray-300 dark:bg-gray-600"></div>
                <button id="logout-btn" title="ë¡œê·¸ì•„ì›ƒ" class="text-[#ED4B9E] hover:opacity-70 transition-colors p-2 rounded-xl"><i data-lucide="log-out" class="h-5 w-5"></i></button>
            </div>
        </header>

        <div class="flex justify-center mb-8">
            <nav class="main-tab-nav inline-flex space-x-1">
                <button data-main-tab="journal-container" class="main-tab-btn py-3 px-8 text-lg text-[#7A6EAA] dark:text-[#b8add2]">
                    ğŸ“ˆ ë§¤ë§¤ì¼ì§€
                </button>
                <button data-main-tab="ledger-container" class="main-tab-btn py-3 px-8 text-lg text-[#7A6EAA] dark:text-[#b8add2]">
                    ğŸ¥ ê°€ê³„ë¶€
                </button>
            </nav>
        </div>

        <!-- ë§¤ë§¤ì¼ì§€ ì»¨í…Œì´ë„ˆ (V1 ìŠ¤íƒ€ì¼ ë³µì›) -->
        <div id="journal-container">
            <nav class="flex justify-center bg-white dark:bg-[#27262C] rounded-2xl border border-[#e7e3eb] dark:border-[#383241] p-2 mb-8 space-x-2">
                <button data-tab="form-view" class="tab-btn text-[#7A6EAA] dark:text-[#b8add2] active w-full md:w-auto px-6 py-3 font-bold rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47]"><i data-lucide="plus-circle" class="inline-block w-4 h-4 mr-2"></i>ì¼ì§€ ì‘ì„±</button>
                <button data-tab="list-view" class="tab-btn text-[#7A6EAA] dark:text-[#b8add2] w-full md:w-auto px-6 py-3 font-bold rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47]"><i data-lucide="book-open" class="inline-block w-4 h-4 mr-2"></i>ë‚´ ì¼ì§€</button>
                <button data-tab="stats-view" class="tab-btn text-[#7A6EAA] dark:text-[#b8add2] w-full md:w-auto px-6 py-3 font-bold rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47]"><i data-lucide="bar-chart-2" class="inline-block w-4 h-4 mr-2"></i>ì„±ê³¼ ë¶„ì„</button>
            </nav>
            <main id="journal-main-content">
                <!-- ì¼ì§€ ì‘ì„± í¼ (V1 Layout Restored) -->
                <div id="form-view">
                    <form id="journal-form" class="ps-card p-6 md:p-8 space-y-6 md:space-y-8">
                        <input type="hidden" id="journal-id">
                        
                        <div class="space-y-6">
                            <h2 class="text-xl font-bold mb-4 border-b-2 border-blue-200 dark:border-blue-900 pb-2 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><i data-lucide="clipboard-list" class="mr-3 text-[#1FC7D4]"></i>ê¸°ë³¸ ì •ë³´</h2>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="sm:col-span-2 space-y-3">
                                    <span class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ìì‚° ìœ í˜•</span>
                                    <div class="toggle-group" data-group="asset-type"><button type="button" data-value="spot" class="toggle-btn selected">í˜„ë¬¼</button><button type="button" data-value="futures" class="toggle-btn">ì„ ë¬¼</button></div>
                                </div>

                                <div class="sm:col-span-2 space-y-3">
                                    <label for="ticker" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ì¢…ëª© ì´ë¦„</label>
                                    <input type="text" id="ticker" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì, NG" required class="w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47] text-base">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label for="date" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">ë‚ ì§œ</label><input type="date" id="date" required class="w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                                
                                <div><span class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">í¬ì§€ì…˜</span>
                                    <div class="toggle-group" data-group="position"><button type="button" data-value="long" class="toggle-btn selected">ğŸŸ¢ ë¡±</button><button type="button" data-value="short" class="toggle-btn">ğŸ”´ ìˆ</button></div>
                                </div>
                                
                                <div><span class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">ë§¤ë§¤ ì „ëµ</span>
                                    <div class="toggle-group" data-group="strategy"><button type="button" data-value="ë‹¨íƒ€" class="toggle-btn selected">ë‹¨íƒ€</button><button type="button" data-value="ìŠ¤ìœ™" class="toggle-btn">ìŠ¤ìœ™</button><button type="button" data-value="ì¥ê¸°" class="toggle-btn">ì¥ê¸°</button></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                <div id="spot-fields" class="space-y-3">
                                    <label for="quantity" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ìˆ˜ëŸ‰ / ê³„ì•½ ìˆ˜</label>
                                    <input type="text" inputmode="numeric" id="quantity" placeholder="ì˜ˆ: 100" class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]">
                                </div>

                                <div id="futures-contracts-field" class="hidden space-y-3">
                                    <label for="contracts" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ê³„ì•½ ìˆ˜</label>
                                    <input type="text" inputmode="numeric" id="contracts" placeholder="ì˜ˆ: 1" class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]">
                                </div>
                                
                                <div class="space-y-3">
                                    <span class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ì…ë ¥ í†µí™”</span>
                                    <div class="toggle-group" data-group="form-currency"><button type="button" id="form-currency-krw-btn" class="toggle-btn">ì› (â‚©)</button><button type="button" id="form-currency-usd-btn" class="toggle-btn selected">ë‹¬ëŸ¬ ($)</button></div>
                                </div>

                                <div><label for="entry-price" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ì§„ì…ê°€</label><input type="text" inputmode="decimal" id="entry-price" placeholder="0" required class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                                <div><label for="target-price" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ëª©í‘œê°€</label><input type="text" inputmode="decimal" id="target-price" placeholder="0" required class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                                <div class="sm:col-span-2"><label for="stop-loss" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ì†ì ˆê°€</label><input type="text" inputmode="decimal" id="stop-loss" placeholder="0" required class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                            </div>
                            
                            <div id="futures-fields" class="hidden sm:col-span-2 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                    <div class="sm:col-span-3 bg-[#EFF4F5] dark:bg-[#1b1822] p-4 rounded-xl border border-[#e7e3eb] dark:border-[#383241]">
                                        <h3 class="text-base font-semibold mb-3 flex justify-between items-center text-[#280D5F] dark:text-[#F4EEFF]">
                                            ì„ ë¬¼ ì¢…ëª© ì •ë³´ ê´€ë¦¬ (í‹±ê°€ì¹˜/ë‹¨ìœ„)
                                            <button type="button" id="delete-futures-info-btn" class="text-[#ED4B9E] px-3 py-1 rounded-lg hover:bg-[#ED4B9E] hover:text-white transition text-xs font-bold border border-[#ED4B9E] disabled:opacity-50">ì‚­ì œ</button>
                                        </h3>
                                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                                            <select id="futures-info-select" class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-white dark:bg-[#372F47] text-base"></select>
                                            <button type="button" id="save-futures-info-btn" class="bg-[#1FC7D4] text-white px-4 py-2 rounded-xl font-bold hover:opacity-80 transition text-sm">ì •ë³´ ì €ì¥</button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label for="tick-value" class="block text-sm font-medium text-[#7A6EAA] dark:text-[#b8add2] mb-1">í‹±ê°€ì¹˜ ($)</label><input type="text" inputmode="decimal" id="tick-value" placeholder="ì˜ˆ: 1" class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-white dark:bg-[#372F47]"></div>
                                            <div><label for="tick-size" class="block text-sm font-medium text-[#7A6EAA] dark:text-[#b8add2] mb-1">í‹±ë‹¨ìœ„</label><input type="text" inputmode="decimal" id="tick-size" placeholder="ì˜ˆ: 0.001" class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-white dark:bg-[#372F47]"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-[#e7e3eb] dark:border-[#383241]">
                            <h2 class="text-xl font-bold border-b-2 border-yellow-200 dark:border-yellow-900 pb-2 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><i data-lucide="cloud-sun" class="mr-3 text-[#FFB237]"></i>í™˜ê²½ íƒœê·¸</h2>
                            <div id="environment-tags-container" class="flex flex-wrap gap-2 mb-2 environment-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-environment-tag" placeholder="ìƒˆë¡œìš´ íƒœê·¸ ì¶”ê°€" class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><button type="button" class="add-environment-tag-btn bg-[#FFB237] text-white px-6 py-3 rounded-xl font-bold hover:opacity-80 transition">ì¶”ê°€</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-[#e7e3eb] dark:border-[#383241]">
                            <h2 class="text-xl font-bold border-b-2 border-green-200 dark:border-green-900 pb-2 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><i data-lucide="siren" class="mr-3 text-[#31D0AA]"></i>ì§„ì… ê·¼ê±°</h2>
                            <div id="entry-tags-container" class="flex flex-wrap gap-2 mb-2 entry-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-entry-tag" placeholder="ìƒˆë¡œìš´ íƒœê·¸ ì¶”ê°€" class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><button type="button" class="add-entry-tag-btn bg-[#31D0AA] text-white px-6 py-3 rounded-xl font-bold hover:opacity-80 transition">ì¶”ê°€</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-[#e7e3eb] dark:border-[#383241]">
                            <h2 class="text-xl font-bold border-b-2 border-purple-200 dark:border-purple-900 pb-2 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><i data-lucide="brain-circuit" class="mr-3 text-[#7645D9]"></i>ì‹¬ë¦¬ ìƒíƒœ</h2>
                            <div id="psychology-tags-container" class="flex flex-wrap gap-2 mb-2 psychology-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-psychology-tag" placeholder="ìƒˆë¡œìš´ íƒœê·¸ ì¶”ê°€" class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><button type="button" class="add-psychology-tag-btn bg-[#7645D9] text-white px-6 py-3 rounded-xl font-bold hover:opacity-80 transition">ì¶”ê°€</button></div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6 border-t border-[#e7e3eb] dark:border-[#383241]">
                            <button type="button" id="clear-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-500 transition">ìƒˆë¡œ ì‘ì„±</button>
                            <button type="submit" class="bg-[#1FC7D4] text-white px-6 py-3 rounded-xl font-bold hover:opacity-80 transition flex items-center"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>ì¼ì§€ ì €ì¥</button>
                        </div>
                    </form>
                </div>

                <!-- ì¼ì§€ ëª©ë¡ (V1 Design Restored inside PS-Card container) -->
                <div id="list-view" class="hidden">
                    <div class="ps-card p-4 mb-6 flex flex-wrap items-center justify-center gap-x-6 gap-y-4 bg-white dark:bg-[#27262C]">
                        <div class="flex items-center space-x-2"><label for="list-exchange-rate" class="font-bold text-sm text-[#7A6EAA] dark:text-[#b8add2]">í™˜ìœ¨($):</label><input type="text" inputmode="numeric" id="list-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-[#e7e3eb] dark:border-[#383241] bg-[#F4F4F4] dark:bg-[#372F47] rounded-lg text-center font-bold"></div>
                    </div>
                    <div id="journal-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>

                <!-- í†µê³„ (Keeping updated functionality but reverting style slightly to fit theme) -->
                <div id="stats-view" class="hidden space-y-8">
                     <div class="ps-card p-4 mb-6 flex flex-col sm:flex-row items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2"><label for="stats-exchange-rate" class="font-bold text-sm text-[#7A6EAA] dark:text-[#b8add2]">í™˜ìœ¨:</label><input type="text" inputmode="numeric" id="stats-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 bg-[#F4F4F4] dark:bg-[#372F47] rounded-xl text-center font-bold border border-[#e7e3eb] dark:border-[#383241]"></div>
                        <div class="toggle-group text-gray-600 w-full sm:w-auto" data-group="stats-currency"><button id="stats-currency-krw-btn" class="toggle-btn selected">ì› (â‚©)</button><button id="stats-currency-usd-btn" class="toggle-btn">ë‹¬ëŸ¬ ($)</button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="ps-card p-6 text-center space-y-2 border-b-4 border-[#1FC7D4]">
                            <h3 class="text-lg font-bold text-[#7A6EAA] dark:text-[#b8add2]">ğŸ† ì´ ìŠ¹ë¥ </h3>
                            <p id="total-win-rate" class="text-4xl font-extrabold text-[#1FC7D4]">N/A</p>
                        </div>
                        <div class="ps-card p-6 text-center space-y-2 border-b-4 border-[#31D0AA]">
                            <h3 class="text-lg font-bold text-[#7A6EAA] dark:text-[#b8add2]">âš–ï¸ í‰ê·  ì†ìµë¹„</h3>
                            <p id="average-pl-ratio" class="text-4xl font-extrabold text-[#31D0AA]">N/A</p>
                        </div>
                        <div class="ps-card p-6 text-center space-y-2 border-b-4 border-[#FFB237]">
                            <h3 class="text-lg font-bold text-[#7A6EAA] dark:text-[#b8add2]">ğŸ’° ì´ ì‹¤í˜„ ì†ìµ</h3>
                            <p id="total-realized-pnl" class="text-3xl font-extrabold text-[#FFB237]">N/A</p>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="ps-card p-6 lg:col-span-1"><h3 class="text-xl font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ“Š ì†ìµ êµ¬ì„±</h3><div class="chart-container"><canvas id="pnl-composition-chart"></canvas></div></div>
                        <div class="ps-card p-6 lg:col-span-2"><h3 class="text-xl font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ“… ì›”ë³„ ì†ìµ</h3><div class="chart-container"><canvas id="monthly-pnl-chart"></canvas></div><div id="monthly-pnl-summary" class="mt-4 text-sm text-center font-medium bg-[#F4F4F4] dark:bg-[#372F47] p-3 rounded-xl"></div></div>
                    </div>
                    <!-- Other charts omitted for brevity but they follow ps-card style -->
                </div>
            </main>
        </div>

        <!-- ê°€ê³„ë¶€ ì»¨í…Œì´ë„ˆ (Cute Style maintained as requested) -->
        <div id="ledger-container" class="hidden">
            <nav class="flex justify-center bg-white dark:bg-[#27262C] rounded-2xl shadow-sm border border-[#e7e3eb] dark:border-[#383241] p-2 mb-8 space-x-2">
                <button data-ledger-tab="ledger-form-view" class="tab-btn text-[#7A6EAA] dark:text-[#b8add2] active w-full md:w-auto px-6 py-3 font-bold rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47]"><i data-lucide="plus-circle" class="inline-block w-4 h-4 mr-2"></i>ë‚´ì—­ ì…ë ¥</button>
                <button data-ledger-tab="ledger-analysis-view" class="tab-btn text-[#7A6EAA] dark:text-[#b8add2] w-full md:w-auto px-6 py-3 font-bold rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47]"><i data-lucide="pie-chart" class="inline-block w-4 h-4 mr-2"></i>ë‚´ì—­ ë° í†µê³„</button>
            </nav>
            <main id="ledger-main-content">
                <!-- ê°€ê³„ë¶€ ì…ë ¥ í¼ -->
                <div id="ledger-form-view">
                    <form id="ledger-form" class="ps-card p-6 md:p-8 shadow-lg space-y-8">
                        <input type="hidden" id="ledger-id">
                        
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold mb-4 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><span class="bg-[#EFF4F5] dark:bg-[#372F47] text-[#7645D9] p-2 rounded-lg mr-3">âœï¸</span>ë‚´ì—­ ì…ë ¥</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-6">
                                <div class="sm:col-span-2 space-y-2">
                                    <span class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF]">ìœ í˜• ì„ íƒ</span>
                                    <div class="toggle-group" data-group="ledger-type"><button type="button" data-value="expense" class="toggle-btn selected">ğŸ’¸ ì§€ì¶œ</button><button type="button" data-value="income" class="toggle-btn">ğŸ’° ìˆ˜ì…</button></div>
                                </div>

                                <div><label for="ledger-date" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">ë‚ ì§œ</label><input type="date" id="ledger-date" required class="w-full p-4 border border-[#e7e3eb] dark:border-[#383241] rounded-2xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                                <div><label for="ledger-amount" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">ê¸ˆì•¡</label><input type="text" inputmode="numeric" id="ledger-amount" placeholder="0" required class="number-input w-full p-4 border border-[#e7e3eb] dark:border-[#383241] rounded-2xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                            </div>
                                
                            <div class="sm:col-span-2 space-y-4 pt-6 border-t border-[#e7e3eb] dark:border-[#383241]" id="ledger-expense-category-section">
                                <h3 class="text-lg font-bold mb-2 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ›’ ì§€ì¶œ ì¹´í…Œê³ ë¦¬</h3>
                                <div id="ledger-expense-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex gap-2"><input type="text" id="new-ledger-expense-category" placeholder="ì§ì ‘ ì…ë ¥..." class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><button type="button" id="add-ledger-expense-category-btn" class="bg-[#ED4B9E] text-white px-5 py-3 rounded-xl font-bold hover:opacity-80 transition shadow-sm">ì¶”ê°€</button></div>
                            </div>

                            <div class="sm:col-span-2 hidden space-y-4 pt-6 border-t border-[#e7e3eb] dark:border-[#383241]" id="ledger-income-category-section">
                                <h3 class="text-lg font-bold mb-2 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ’µ ìˆ˜ì… ì¹´í…Œê³ ë¦¬</h3>
                                <div id="ledger-income-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex gap-2"><input type="text" id="new-ledger-income-category" placeholder="ì§ì ‘ ì…ë ¥..." class="flex-grow p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><button type="button" id="add-ledger-income-category-btn" class="bg-[#31D0AA] text-white px-5 py-3 rounded-xl font-bold hover:opacity-80 transition shadow-sm">ì¶”ê°€</button></div>
                            </div>

                            <div class="sm:col-span-2 pt-4"><label for="ledger-memo" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-2">ë©”ëª¨</label><input type="text" id="ledger-memo" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full p-4 border border-[#e7e3eb] dark:border-[#383241] rounded-2xl bg-[#F4F4F4] dark:bg-[#372F47]"></div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-6 border-t border-[#e7e3eb] dark:border-[#383241]">
                            <button type="button" id="clear-ledger-form-btn" class="bg-[#EFF4F5] dark:bg-[#372F47] text-[#7A6EAA] dark:text-[#b8add2] px-6 py-4 rounded-xl font-bold hover:opacity-80 transition">ì´ˆê¸°í™”</button>
                            <button type="submit" class="bg-[#1FC7D4] text-white px-8 py-4 rounded-xl font-bold hover:shadow-lg hover:scale-105 transition transform flex items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i>ì €ì¥í•˜ê¸°</button>
                        </div>
                    </form>
                </div>

                <!-- ê°€ê³„ë¶€ í†µí•© ë¶„ì„ ë·° -->
                <div id="ledger-analysis-view" class="hidden space-y-6">
                    <!-- ë‚ ì§œ í•„í„° -->
                    <div class="ps-card p-4 flex flex-wrap items-center justify-center gap-4 bg-white dark:bg-[#27262C]">
                        <select id="ledger-analysis-filter-type" class="p-2 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47] font-bold text-[#280D5F] dark:text-[#F4EEFF] focus:ring-2 focus:ring-[#1FC7D4]"><option value="month">ì›”ë³„ ë³´ê¸°</option><option value="quarter">ë¶„ê¸°ë³„ ë³´ê¸°</option><option value="year">ì—°ë„ë³„ ë³´ê¸°</option></select>
                        <div class="flex items-center gap-4 bg-[#F4F4F4] dark:bg-[#372F47] px-4 py-2 rounded-2xl border border-[#e7e3eb] dark:border-[#383241]">
                            <button id="ledger-analysis-prev-btn" class="p-2 rounded-full hover:bg-white dark:hover:bg-[#4d4461] transition"><i data-lucide="chevron-left" class="w-5 h-5 text-[#280D5F] dark:text-[#F4EEFF]"></i></button>
                            <span id="ledger-analysis-period-display" class="font-extrabold text-xl w-40 text-center text-[#280D5F] dark:text-[#F4EEFF]"></span>
                            <button id="ledger-analysis-next-btn" class="p-2 rounded-full hover:bg-white dark:hover:bg-[#4d4461] transition"><i data-lucide="chevron-right" class="w-5 h-5 text-[#280D5F] dark:text-[#F4EEFF]"></i></button>
                        </div>
                    </div>
                    
                    <!-- ìš”ì•½ ì¹´ë“œ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="ps-card p-6 text-center border-l-4 border-[#31D0AA]">
                            <h3 class="text-sm font-bold mb-2 text-[#31D0AA]">ì´ë²ˆ ë‹¬ ìˆ˜ì… ğŸ’°</h3>
                            <p id="ledger-total-income" class="text-3xl font-extrabold text-[#280D5F] dark:text-[#F4EEFF]">â‚©0</p>
                        </div>
                        <div class="ps-card p-6 text-center border-l-4 border-[#ED4B9E]">
                            <h3 class="text-sm font-bold mb-2 text-[#ED4B9E]">ì´ë²ˆ ë‹¬ ì§€ì¶œ ğŸ’¸</h3>
                            <p id="ledger-total-expense" class="text-3xl font-extrabold text-[#280D5F] dark:text-[#F4EEFF]">â‚©0</p>
                        </div>
                        <div class="ps-card p-6 text-center border-l-4 border-[#1FC7D4]">
                            <h3 class="text-sm font-bold mb-2 text-[#1FC7D4]">ë‚¨ì€ ëˆ (í•©ê³„) ğŸ·</h3>
                            <p id="ledger-balance" class="text-3xl font-extrabold text-[#280D5F] dark:text-[#F4EEFF]">â‚©0</p>
                        </div>
                    </div>

                    <!-- ì°¨íŠ¸ -->
                    <div class="ps-card p-6">
                         <h3 id="ledger-trend-chart-title" class="text-lg font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ“Š íë¦„ í•œëˆˆì— ë³´ê¸°</h3>
                         <div class="chart-container" style="height: 250px;"><canvas id="ledger-monthly-pnl-chart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="ps-card p-6">
                            <h3 id="ledger-expense-chart-title" class="text-lg font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ° ì–´ë””ì— ì¼ì„ê¹Œ?</h3>
                            <div class="chart-container" style="height: 250px;"><canvas id="ledger-expense-chart"></canvas></div>
                        </div>
                        <div class="ps-card p-6">
                            <h3 id="ledger-income-chart-title" class="text-lg font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ’ ì–´ë””ì„œ ë²Œì—ˆì„ê¹Œ?</h3>
                            <div class="chart-container" style="height: 250px;"><canvas id="ledger-income-chart"></canvas></div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 ps-card p-6">
                            <h3 class="text-lg font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF]">ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½</h3>
                            <div class="space-y-6">
                                <div><h4 class="text-sm font-bold text-[#ED4B9E] mb-2">ì§€ì¶œ Top</h4><div id="ledger-category-summary" class="space-y-2"></div></div>
                                <div class="border-t border-[#e7e3eb] dark:border-[#383241] pt-4"><h4 class="text-sm font-bold text-[#31D0AA] mb-2">ìˆ˜ì… Top</h4><div id="ledger-income-summary" class="space-y-2"></div></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 ps-card p-6">
                            <h3 class="text-lg font-bold mb-4 text-[#280D5F] dark:text-[#F4EEFF] flex items-center gap-2"><span class="bg-[#EFF4F5] dark:bg-[#372F47] text-[#1FC7D4] p-1.5 rounded-lg text-sm">ğŸ“„</span><span id="ledger-detail-title">ì „ì²´ ë‚´ì—­</span></h3>
                            <div id="ledger-entry-details" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="ps-card p-8 modal-content w-full max-w-md bg-white dark:bg-[#27262C]"><h2 class="text-2xl font-bold mb-6 text-[#280D5F] dark:text-[#F4EEFF]">ğŸšª ì²­ì‚° ê¸°ë¡</h2><form id="exit-form"><input type="hidden" id="exit-journal-id"><div class="space-y-4"><div><label class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ë‚ ì§œ</label><input type="date" id="exit-date" required class="w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div><div><label class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ì²­ì‚°ê°€</label><input type="text" inputmode="decimal" id="exit-price" required class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"></div><div><label id="exit-quantity-label" class="block text-sm font-bold text-[#280D5F] dark:text-[#F4EEFF] mb-1">ìˆ˜ëŸ‰</label><input type="text" inputmode="numeric" id="exit-quantity" required class="number-input w-full p-3 border border-[#e7e3eb] dark:border-[#383241] rounded-xl bg-[#F4F4F4] dark:bg-[#372F47]"><p class="text-xs text-[#7A6EAA] mt-1 text-right">ë‚¨ì€ ìˆ˜ëŸ‰: <span id="remaining-quantity" class="font-bold"></span></p></div></div><div class="mt-8 flex justify-end gap-2"><button type="button" id="close-modal-btn" class="bg-[#EFF4F5] text-[#7A6EAA] px-4 py-2 rounded-xl font-bold hover:bg-gray-200">ì·¨ì†Œ</button><button type="submit" class="bg-[#1FC7D4] text-white px-6 py-2 rounded-xl font-bold hover:opacity-80">ì €ì¥</button></div></form></div></div>
    
    <div id="memo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="ps-card p-8 modal-content w-full max-w-xl bg-white dark:bg-[#27262C]"><h2 class="text-2xl font-bold mb-4 flex items-center text-[#280D5F] dark:text-[#F4EEFF]"><span class="mr-2">ğŸ“</span> ë§¤ë§¤ ë³µê¸°</h2><form id="memo-form"><input type="hidden" id="memo-journal-id"><textarea id="memo-content" rows="8" class="w-full p-4 border border-[#e7e3eb] dark:border-[#383241] bg-[#F4F4F4] dark:bg-[#372F47] rounded-2xl resize-none text-base focus:ring-2 focus:ring-[#1FC7D4]" placeholder="ë‹¹ì‹œì˜ ê°ì •ê³¼ ê·¼ê±°ë¥¼ ìì„¸íˆ ê¸°ë¡í•´ë³´ì„¸ìš”."></textarea><div class="mt-6 flex justify-end gap-2"><button type="button" id="close-memo-modal-btn" class="bg-[#EFF4F5] text-[#7A6EAA] px-4 py-2 rounded-xl font-bold hover:bg-gray-200">ë‹«ê¸°</button><button type="submit" class="bg-[#1FC7D4] text-white px-6 py-2 rounded-xl font-bold hover:opacity-80">ì €ì¥</button></div></form></div></div>

    <div id="tag-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="ps-card p-8 modal-content w-full max-w-xl bg-white dark:bg-[#27262C]"><h2 class="text-2xl font-bold mb-6 text-[#280D5F] dark:text-[#F4EEFF]">ğŸ·ï¸ íƒœê·¸ ìˆ˜ì •</h2><form id="tag-edit-form"><input type="hidden" id="tag-edit-journal-id"><div class="space-y-6"><div id="tag-edit-environment-container"><h3 class="text-sm font-bold mb-2 text-[#FFB237]">í™˜ê²½ íƒœê·¸</h3><div id="tag-edit-environment-tags" class="flex flex-wrap gap-2"></div></div><div id="tag-edit-entry-container"><h3 class="text-sm font-bold mb-2 text-[#31D0AA]">ì§„ì… ê·¼ê±°</h3><div id="tag-edit-entry-tags" class="flex flex-wrap gap-2"></div></div><div id="tag-edit-psychology-container"><h3 class="text-sm font-bold mb-2 text-[#7645D9]">ì‹¬ë¦¬ ìƒíƒœ</h3><div id="tag-edit-psychology-tags" class="flex flex-wrap gap-2"></div></div></div><div class="mt-8 flex justify-end gap-2"><button type="button" id="close-tag-edit-modal-btn" class="bg-[#EFF4F5] text-[#7A6EAA] px-4 py-2 rounded-xl font-bold hover:bg-gray-200">ì·¨ì†Œ</button><button type="submit" class="bg-[#1FC7D4] text-white px-6 py-2 rounded-xl font-bold hover:opacity-80">ì™„ë£Œ</button></div></form></div></div>
    
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="ps-card p-8 modal-content w-full max-w-sm text-center bg-white dark:bg-[#27262C]"><div class="text-4xl mb-4">ğŸ¤”</div><h2 id="confirm-title" class="text-xl font-bold mb-2 text-[#280D5F] dark:text-[#F4EEFF]">í™•ì¸í•´ì£¼ì„¸ìš”</h2><p id="confirm-message" class="text-[#7A6EAA] dark:text-[#b8add2] mb-8"></p><div class="flex justify-center gap-3"><button type="button" id="confirm-cancel-btn" class="bg-[#EFF4F5] text-[#7A6EAA] px-6 py-3 rounded-xl font-bold hover:bg-gray-200">ì·¨ì†Œ</button><button type="button" id="confirm-ok-btn" class="bg-[#ED4B9E] text-white px-6 py-3 rounded-xl font-bold hover:opacity-80 shadow-md">í™•ì¸</button></div></div></div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-[#27262C] text-white px-8 py-4 rounded-full shadow-2xl translate-y-20 opacity-0 transition-all duration-300 font-bold z-50 flex items-center"><span class="mr-2">ğŸ””</span><p id="toast-message"></p></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDZm5AazCafB0Sb2gd0llv9e3GAhE-nKBw",
          authDomain: "sakurazima-mai-0u0.firebaseapp.com",
          projectId: "sakurazima-mai-0u0",
          storageBucket: "sakurazima-mai-0u0.appspot.com",
          messagingSenderId: "697666115735",
          appId: "1:697666115735:web:7380a588822f771dc071d2",
          measurementId: "G-TZQ9GVFWV5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const Timestamp = firebase.firestore.Timestamp;

        let currentUser = null;
        let charts = {};
        let confirmCallback = null;
        
        let unsubscribeJournals = null, unsubscribeTags = null;
        let localJournals = [], localTags = { environment: [], entry: [], psychology: [] }; 
        let localFuturesInfo = {}; 
        let unsubscribeFuturesInfo = null;
        let statsCurrency = 'KRW', exchangeRate = 1380;
        
        let unsubscribeLedger = null, unsubscribeLedgerCategories = null;
        let localLedgerEntries = [];
        let localLedgerCategories = { expense: [], income: [] };
        let ledgerAnalysisDate = new Date();

        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(error => showToast("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message, "error")));
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('auth-info').textContent = `${user.displayName}ë‹˜ì˜ ê¸°ë¡ì¥`;
                initializeAppFunctionality();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeJournals) unsubscribeJournals();
                if (unsubscribeTags) unsubscribeTags();
                if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
                if (unsubscribeLedger) unsubscribeLedger();
                if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
                Object.values(charts).forEach(chart => { if(chart) chart.destroy(); });
                charts = {};
            }
            lucide.createIcons();
        });

        async function initializeAppFunctionality() {
            if (!currentUser) return;
            const userId = currentUser.uid;

            await initializeJournalDefaults(userId);
            await initializeFuturesInfoDefaults(userId);
            attachJournalListeners(userId);
            resetForm();

            await initializeLedgerDefaults(userId);
            attachLedgerListeners(userId);
            resetLedgerForm();
        }

        document.querySelectorAll('.main-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.mainTab;
                document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('journal-container').classList.toggle('hidden', targetId !== 'journal-container');
                document.getElementById('ledger-container').classList.toggle('hidden', targetId !== 'ledger-container');
                if (targetId === 'ledger-container' && currentUser) { renderLedgerAnalysisView(); }
                else if (targetId === 'journal-container' && currentUser) { renderJournalStats(localJournals); }
            });
        });

        const journalForm = document.getElementById('journal-form');
        const journalList = document.getElementById('journal-list');

        async function initializeJournalDefaults(userId) {
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            const tagsDocSnap = await tagsDocRef.get();
            if (!tagsDocSnap.exists) {
                await tagsDocRef.set({
                    environment: ['ê°œì¥ ì§í›„', 'ì¢…ê°€ ë¶€ê·¼', 'ë³€ë™ì„± í™•ëŒ€', 'FOMC'], 
                    entry: ['ì •ë°°ì—´ ëŒíŒŒ', 'ë‚™ì£¼ ë§¤ë§¤', 'ì±„ë„ í•˜ë‹¨', 'OB', '4H', 'ì—°ì†ì €ì ', 'ì£¼ì¶”ì„¸'],
                    psychology: ['FOMO', 'í™•ì‹ ', 'ë§¤ë§¤ì¤‘ë…', 'ë‘ë ¤ì›€', 'ì‚¬í›„ì •ë‹¹í™”', 'ë°°íŒ…']
                });
            }
        }
        
        async function initializeFuturesInfoDefaults(userId) {
            const docRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            const docSnap = await docRef.get();
            if (!docSnap.exists) {
                await docRef.set({
                    'ES': { tickValue: 5.0, tickSize: 0.25 },
                    'NG': { tickValue: 10.0, tickSize: 0.001 },
                    'MGC': { tickValue: 1.0, tickSize: 0.1 }
                });
            }
        }

        function attachJournalListeners(userId) {
            if (unsubscribeJournals) unsubscribeJournals();
            const journalsQuery = db.collection("users").doc(userId).collection("journals").orderBy("date", "desc");
            unsubscribeJournals = journalsQuery.onSnapshot((snapshot) => {
                localJournals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                renderJournals(localJournals);
                renderJournalStats(localJournals);
            }, (error) => console.error("Error fetching journals:", error));

            if (unsubscribeTags) unsubscribeTags();
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            unsubscribeTags = tagsDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    localTags = doc.data();
                    renderJournalTags(localTags.environment, 'environment-tags-container', 'environment');
                    renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
                    renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
                }
            }, (error) => console.error("Error fetching tags:", error));
            
            if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
            const futuresDocRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            unsubscribeFuturesInfo = futuresDocRef.onSnapshot((doc) => {
                localFuturesInfo = doc.exists ? doc.data() : {};
                renderFuturesInfoSelect();
            }, (error) => console.error("Error fetching futures info:", error));
        }

        function switchJournalView(tabId) {
            document.querySelectorAll('#journal-container [data-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            ['form-view', 'list-view', 'stats-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== tabId));
            lucide.createIcons();
            if(tabId === 'stats-view' && currentUser) { renderJournalStats(localJournals); }
        }
        document.querySelectorAll('#journal-container [data-tab]').forEach(b => b.addEventListener('click', () => switchJournalView(b.dataset.tab)));
        
        document.querySelectorAll('[data-group="asset-type"] .toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const isSpot = btn.dataset.value === 'spot';
                document.getElementById('spot-fields').classList.toggle('hidden', !isSpot);
                document.getElementById('futures-contracts-field').classList.toggle('hidden', isSpot);
                document.getElementById('futures-fields').classList.toggle('hidden', isSpot);
                
                const quantityInput = document.getElementById('quantity');
                const contractsInput = document.getElementById('contracts');
                const tickValueInput = document.getElementById('tick-value');
                const tickSizeInput = document.getElementById('tick-size');
                
                quantityInput.required = isSpot;
                contractsInput.required = !isSpot;
                tickValueInput.required = !isSpot;
                tickSizeInput.required = !isSpot;

                if (!isSpot) {
                     const currentTicker = document.getElementById('ticker').value.trim().toUpperCase();
                     if (localFuturesInfo[currentTicker]) {
                        contractsInput.value = contractsInput.value || 1; 
                        document.getElementById('futures-info-select').value = currentTicker;
                        tickValueInput.value = formatNumber(localFuturesInfo[currentTicker].tickValue);
                        tickSizeInput.value = formatNumber(localFuturesInfo[currentTicker].tickSize);
                        document.getElementById('delete-futures-info-btn').disabled = false;
                     } else {
                        contractsInput.value = '';
                        document.getElementById('futures-info-select').value = '';
                        tickValueInput.value = '';
                        tickSizeInput.value = '';
                        document.getElementById('delete-futures-info-btn').disabled = true;
                     }
                     quantityInput.value = '';
                     quantityInput.classList.add('hidden');
                } else { 
                     document.getElementById('futures-info-select').value = '';
                     tickValueInput.value = '';
                     tickSizeInput.value = '';
                     document.getElementById('delete-futures-info-btn').disabled = true;
                     contractsInput.value = '';
                     quantityInput.classList.remove('hidden');
                }
            });
        });
        
        function renderFuturesInfoSelect() {
            const select = document.getElementById('futures-info-select');
            const tickerInput = document.getElementById('ticker');
            const deleteBtn = document.getElementById('delete-futures-info-btn');
            const contractsInput = document.getElementById('contracts');
            const tickValueInput = document.getElementById('tick-value');
            const tickSizeInput = document.getElementById('tick-size');
            
            deleteBtn.disabled = true; 
            select.innerHTML = '<option value="">- ì¢…ëª© ì„ íƒ -</option>';
            const currentTicker = tickerInput.value.trim().toUpperCase();

            Object.entries(localFuturesInfo).sort((a,b) => a[0].localeCompare(b[0])).forEach(([ticker, info]) => {
                const option = document.createElement('option');
                option.value = ticker;
                option.textContent = `${ticker} (ê°€ì¹˜: ${formatNumber(info.tickValue)}, ë‹¨ìœ„: ${formatNumber(info.tickSize)})`;
                select.appendChild(option);
                
                if (ticker === currentTicker && !document.getElementById('futures-fields').classList.contains('hidden')) {
                    select.value = ticker;
                    deleteBtn.disabled = false;
                }
            });
            
            select.onchange = (e) => {
                const selectedTicker = e.target.value;
                const info = localFuturesInfo[selectedTicker];
                deleteBtn.disabled = !selectedTicker;

                if (info) {
                    tickerInput.value = selectedTicker;
                    tickValueInput.value = formatNumber(info.tickValue);
                    tickSizeInput.value = formatNumber(info.tickSize);
                    contractsInput.value = contractsInput.value || 1; 
                    showToast(`'${selectedTicker}' ì •ë³´ ë¶ˆëŸ¬ì˜´!`);
                } else {
                    tickValueInput.value = '';
                    tickSizeInput.value = '';
                }
            };
            
            tickerInput.oninput = () => {
                const newTicker = tickerInput.value.trim().toUpperCase();
                const isFutures = !document.getElementById('futures-fields').classList.contains('hidden');
                deleteBtn.disabled = !localFuturesInfo[newTicker];
                if (isFutures && localFuturesInfo[newTicker]) {
                    select.value = newTicker;
                    tickValueInput.value = formatNumber(localFuturesInfo[newTicker].tickValue);
                    tickSizeInput.value = formatNumber(localFuturesInfo[newTicker].tickSize);
                } else if (isFutures) { select.value = ''; }
            }
        }
        
        document.getElementById('save-futures-info-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const tickValue = parseFloat(unformatNumber(document.getElementById('tick-value').value));
            const tickSize = parseFloat(unformatNumber(document.getElementById('tick-size').value));

            if (!ticker || isNaN(tickValue) || tickValue <= 0 || isNaN(tickSize) || tickSize <= 0) {
                showToast("ì¢…ëª© ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error"); return;
            }

            const currentInfo = localFuturesInfo[ticker];
            const message = currentInfo ? `'${ticker}' ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í• ê¹Œìš”?` : `'${ticker}' ì •ë³´ë¥¼ ì €ì¥í• ê¹Œìš”?`;

            showConfirmModal(message, async () => {
                try {
                    const updatedInfo = { ...localFuturesInfo, [ticker]: { tickValue, tickSize } };
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    showToast(`'${ticker}' ì •ë³´ ì €ì¥ ì™„ë£Œ!`);
                    document.getElementById('delete-futures-info-btn').disabled = false;
                } catch(e) { showToast("ì €ì¥ ì‹¤íŒ¨ ã… ã… ", "error"); }
            }, 'ì €ì¥');
        });
        
        document.getElementById('delete-futures-info-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('futures-info-select').value;
            if (!ticker) return;
            showConfirmModal(`'${ticker}' ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?`, async () => {
                try {
                    const updatedInfo = { ...localFuturesInfo };
                    delete updatedInfo[ticker];
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    showToast("ì‚­ì œ ì™„ë£Œ!");
                    document.getElementById('futures-info-select').value = '';
                    document.getElementById('tick-value').value = '';
                    document.getElementById('tick-size').value = '';
                } catch(e) { showToast("ì‚­ì œ ì‹¤íŒ¨", "error"); }
            }, 'ì‚­ì œ');
        });


        function calculatePnl(journal, exit) {
            const priceDiff = journal.position === 'long' ? (exit.price - journal.entryPrice) : (journal.entryPrice - exit.price);
            const exitQuantity = exit.quantity;

            if (journal.assetType === 'futures') {
                if (!journal.tickSize || !journal.tickValue) return 0;
                return (priceDiff / journal.tickSize) * journal.tickValue * exitQuantity;
            } else { 
                return priceDiff * exitQuantity;
            }
        }

        // --- Render Journals (Reverted to V1 Logic with new Theme) ---
        function renderJournals(journals) {
            journalList.innerHTML = '';
            if (journals.length === 0) {
                journalList.innerHTML = `<div class="col-span-full text-center text-[#7A6EAA] dark:text-[#b8add2] p-12 ps-card"><i data-lucide="ghost" class="mx-auto w-16 h-16 mb-4 opacity-50"></i><p class="text-xl font-medium">ì•„ì§ ì‘ì„±ëœ ì¼ì§€ê°€ ì—†ì–´ìš”.</p><p class="text-sm mt-2">ì˜¤ëŠ˜ì˜ ë§¤ë§¤ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</p></div>`;
                lucide.createIcons(); return;
            }

            journals.forEach(journal => {
                const isSpot = journal.assetType === 'spot';
                const totalAmount = isSpot ? journal.quantity : (journal.contracts || 0); 
                const exitedAmount = journal.exits ? journal.exits.reduce((sum, exit) => sum + exit.quantity, 0) : 0;
                const isClosed = (totalAmount - exitedAmount) <= 1e-9;
                
                let totalPnl = 0;
                if (journal.exits && journal.exits.length > 0) {
                     totalPnl = journal.exits.reduce((sum, exit) => sum + calculatePnl(journal, exit), 0);
                }
                const totalPnlInKRW = journal.currency === 'USD' ? totalPnl * exchangeRate : totalPnl;
                const pnlClass = totalPnlInKRW > 0 ? 'text-[#31D0AA]' : totalPnlInKRW < 0 ? 'text-[#ED4B9E]' : 'text-gray-500';
                
                const borderColor = isClosed ? (totalPnlInKRW > 0 ? 'border-[#31D0AA]' : 'border-[#ED4B9E]') : 'border-[#FFB237]';
                
                // Using V1-like card structure but with ps-card background
                const card = document.createElement('div');
                card.className = `ps-card journal-card-v1 bg-white dark:bg-[#27262C] p-5 shadow-sm ${borderColor} flex flex-col justify-between`;
                
                let holdingPeriodDays = 0;
                if (journal.exits && journal.exits.length > 0) {
                    const lastExitDate = new Date(Math.max(...journal.exits.map(e => (e.date.toDate ? e.date.toDate() : new Date(e.date)).getTime())));
                    const entryDate = journal.date;
                    const diffTime = Math.abs(lastExitDate - entryDate);
                    holdingPeriodDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                }
                
                let dateDisplay = journal.date.toLocaleDateString();
                if (holdingPeriodDays > 0) {
                    dateDisplay += ` <span class="text-sm font-normal text-gray-500 dark:text-[#b8add2]">(${holdingPeriodDays}ì¼)</span>`;
                }

                // Quick Edit ë²„íŠ¼ ë° ì•„ì´ì½˜
                const memoIndicator = journal.memo ? `<i data-lucide="message-square" class="w-4 h-4 text-[#1FC7D4] quick-edit-btn"></i>` : `<i data-lucide="message-square" class="w-4 h-4 text-gray-400 dark:text-gray-600 hover:text-[#1FC7D4] quick-edit-btn"></i>`;
                const tagEditIcon = `<i data-lucide="tags" class="w-4 h-4 text-gray-400 dark:text-gray-600 hover:text-[#7645D9] quick-edit-btn"></i>`;

                const exitsHtml = journal.exits && journal.exits.length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-[#e7e3eb] dark:border-[#383241] space-y-1 text-xs">
                        <h5 class="font-semibold mb-1 text-gray-500 dark:text-[#b8add2]">ì²­ì‚° ë‚´ì—­</h5>
                        ${journal.exits.map(exit => {
                            const exitPnl = calculatePnl(journal, exit);
                            const exitPnlClass = exitPnl > 0 ? 'text-[#31D0AA]' : exitPnl < 0 ? 'text-[#ED4B9E]' : 'text-gray-500';
                            const exitDate = exit.date.toDate ? exit.date.toDate() : new Date(exit.date);
                            const amountLabel = isSpot ? 'ì£¼' : 'ê³„ì•½';
                            return `<div class="flex justify-between items-center p-1 rounded"><span>${exitDate.toLocaleDateString()} @ ${formatPrice(exit.price, journal.currency)} (${formatNumber(exit.quantity)} ${amountLabel})</span><span class="${exitPnlClass} font-medium">${formatPrice(exitPnl, journal.currency)}</span></div>`
                        }).join('')}
                    </div>` : '';
                
                const amountLabel = isSpot ? 'ìˆ˜ëŸ‰' : 'ê³„ì•½';
                const futuresInfoHtml = !isSpot ? 
                    `<p class="text-xs text-gray-400 dark:text-gray-500 mt-1"><strong>í‹±ê°€ì¹˜/ë‹¨ìœ„:</strong> ${formatPrice(journal.tickValue, journal.currency)} / ${formatNumber(journal.tickSize)}</p>` : '';
                
                // Tags
                const renderTags = (tags, maxCount, baseClass, textColor) => {
                    const visibleTags = (tags || []).slice(0, maxCount);
                    const hiddenTags = (tags || []).slice(maxCount);
                    let tagHtml = `<div class="flex flex-wrap gap-1">`;
                    tagHtml += visibleTags.map(tag => `<span class="${baseClass} ${textColor} text-xs font-bold px-2 py-0.5 rounded-lg">${tag}</span>`).join('');
                    if (hiddenTags.length > 0) tagHtml += `<span class="text-xs font-bold text-gray-400 dark:text-[#b8add2] px-2 py-0.5">+${hiddenTags.length}</span>`;
                    tagHtml += `</div>`;
                    return tagHtml;
                };

                const environmentTagHtml = renderTags(journal.environmentTags, 4, 'bg-yellow-100 dark:bg-yellow-900/40', 'text-yellow-800 dark:text-yellow-400');
                const entryTagHtml = renderTags(journal.entryTags, 4, 'bg-green-100 dark:bg-green-900/40', 'text-green-800 dark:text-green-400');
                const psyTagHtml = renderTags(journal.psychologyTags, 4, 'bg-purple-100 dark:bg-purple-900/40', 'text-purple-800 dark:text-purple-400');

                card.innerHTML = `
                    <div> <div class="flex justify-between items-start mb-3 border-b border-[#e7e3eb] dark:border-[#383241] pb-2">
                            <div>
                                <p class="font-bold text-lg text-[#280D5F] dark:text-[#F4EEFF]">${dateDisplay}</p>
                                <div class="flex items-center space-x-2">
                                    <p class="font-extrabold text-xl text-[#280D5F] dark:text-white">${journal.ticker} <span class="text-xs font-medium text-gray-400 align-top">${isSpot ? 'í˜„ë¬¼' : 'ì„ ë¬¼'}</span></p>
                                    <span class="text-base font-bold ${journal.position === 'long' ? 'text-[#31D0AA]' : 'text-[#ED4B9E]'}">${journal.position === 'long' ? 'ğŸŸ¢ Long' : 'ğŸ”´ Short'}</span>
                                    <span class="text-sm text-gray-500 dark:text-[#b8add2] ml-1">${journal.strategy}</span>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                 ${!isClosed ? `<button class="p-2 hover:bg-[#EFF4F5] dark:hover:bg-[#372F47] rounded-full exit-btn" data-id="${journal.id}" title="ì²­ì‚° ê¸°ë¡"><i data-lucide="log-out" class="w-5 h-5 text-[#1FC7D4]"></i></button>` : ''}
                                <button class="p-2 hover:bg-[#EFF4F5] dark:hover:bg-[#372F47] rounded-full edit-btn" data-id="${journal.id}" title="ì „ì²´ ìˆ˜ì •"><i data-lucide="edit" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i></button>
                                <button class="p-2 hover:bg-[#EFF4F5] dark:hover:bg-[#372F47] rounded-full delete-btn" data-id="${journal.id}" title="ì‚­ì œ"><i data-lucide="trash-2" class="w-5 h-5 text-[#ED4B9E]"></i></button>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm text-[#280D5F] dark:text-[#F4EEFF] mb-4">
                            <p><strong>ì§„ì…:</strong> ${formatPrice(journal.entryPrice, journal.currency)} / <strong>${amountLabel}:</strong> ${formatNumber(totalAmount)}</p>
                            <p><strong>ëª©í‘œ/ì†ì ˆ:</strong> ${formatPrice(journal.targetPrice, journal.currency)} / ${formatPrice(journal.stopLoss, journal.currency)}</p>
                            ${futuresInfoHtml}
                            ${journal.exits && journal.exits.length > 0 ? `<p class="font-extrabold text-xl pt-2 ${pnlClass}"><strong>ì´ ì‹¤í˜„ ì†ìµ:</strong> ${formatDualCurrency(totalPnlInKRW, journal.currency)}</p>` : ''}
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            ${journal.environmentTags && journal.environmentTags.length ? `<div><h4 class="font-semibold text-xs text-gray-500 dark:text-[#b8add2] mb-1">í™˜ê²½</h4>${environmentTagHtml}</div>` : ''}
                            ${journal.entryTags && journal.entryTags.length ? `<div><h4 class="font-semibold text-xs text-gray-500 dark:text-[#b8add2] mb-1">ì§„ì…</h4>${entryTagHtml}</div>` : ''}
                            ${journal.psychologyTags && journal.psychologyTags.length ? `<div><h4 class="font-semibold text-xs text-gray-500 dark:text-[#b8add2] mb-1">ì‹¬ë¦¬</h4>${psyTagHtml}</div>` : ''}
                        </div>
                        
                        ${exitsHtml}
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-[#e7e3eb] dark:border-[#383241] mt-auto">
                        <button class="flex items-center text-sm font-semibold gap-2 memo-btn text-[#7A6EAA] dark:text-[#b8add2] hover:text-[#1FC7D4]" data-id="${journal.id}" title="ë©”ëª¨">
                            ${memoIndicator}
                            <span>${journal.memo ? 'ë©”ëª¨ ì½ê¸°' : 'ë©”ëª¨ ì“°ê¸°'}</span>
                        </button>
                        <button class="flex items-center text-sm font-semibold gap-2 tag-edit-btn text-[#7A6EAA] dark:text-[#b8add2] hover:text-[#7645D9]" data-id="${journal.id}" title="íƒœê·¸ ìˆ˜ì •">
                            ${tagEditIcon}
                            <span>íƒœê·¸</span>
                        </button>
                    </div>
                `;
                journalList.appendChild(card);
            });
            lucide.createIcons();
            addJournalListEventListeners();
        }

        async function handleOpenTagEditModal(e) {
            const journalId = e.currentTarget.dataset.id;
            const journal = await getJournalById(journalId);
            if (journal) {
                document.getElementById('tag-edit-journal-id').value = journalId;
                renderTagEditOptions('tag-edit-environment-tags', 'environment', journal.environmentTags || []); 
                renderTagEditOptions('tag-edit-entry-tags', 'entry', journal.entryTags || []);
                renderTagEditOptions('tag-edit-psychology-tags', 'psychology', journal.psychologyTags || []);
                openModal('tag-edit-modal');
            }
        }
        
        function renderTagEditOptions(containerId, type, selectedTags) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const availableTags = localTags[type] || [];
            let baseColor = type === 'environment' ? 'bg-[#FFB237]' : type === 'entry' ? 'bg-[#31D0AA]' : 'bg-[#7645D9]';

            availableTags.forEach(tag => {
                const isSelected = selectedTags.includes(tag);
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.tag = tag;
                button.className = `tag text-sm inline-flex items-center px-3 py-1.5 font-bold transition-all ${
                    isSelected ? `${baseColor} text-white shadow-md transform scale-105` : 'bg-[#EFF4F5] text-[#7A6EAA] hover:bg-[#E0E0E0] dark:bg-[#372F47] dark:text-[#b8add2]'
                }`;
                button.textContent = tag;
                button.addEventListener('click', () => {
                   button.classList.toggle(baseColor); button.classList.toggle('text-white');
                   button.classList.toggle('bg-[#EFF4F5]'); button.classList.toggle('text-[#7A6EAA]');
                   if(button.classList.contains('text-white')) button.classList.add('selected');
                   else button.classList.remove('selected');
                });
                container.appendChild(button);
            });
        }
        
        document.getElementById('tag-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const journalId = document.getElementById('tag-edit-journal-id').value;
            const getSelected = (id) => Array.from(document.getElementById(id).children).filter(b => b.classList.contains('text-white')).map(b => b.dataset.tag);
            
            try {
                await db.collection("users").doc(currentUser.uid).collection("journals").doc(journalId).update({
                    environmentTags: getSelected('tag-edit-environment-tags'),
                    entryTags: getSelected('tag-edit-entry-tags'),
                    psychologyTags: getSelected('tag-edit-psychology-tags')
                });
                showToast("íƒœê·¸ ìˆ˜ì • ì™„ë£Œ!");
                closeModal('tag-edit-modal');
            } catch(error) { showToast("ìˆ˜ì • ì‹¤íŒ¨", "error"); }
        });
        
        async function getJournalById(id) {
            const doc = await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).get();
            return doc.exists ? { id: doc.id, ...doc.data(), date: doc.data().date.toDate(), quantity: doc.data().quantity || doc.data().contracts || 0, contracts: doc.data().contracts || doc.data().quantity || 0 } : null;
        }

        function addJournalListEventListeners() {
            document.querySelectorAll('#journal-list .delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteJournal));
            document.querySelectorAll('#journal-list .edit-btn').forEach(btn => btn.addEventListener('click', handleEditJournal));
            document.querySelectorAll('#journal-list .exit-btn').forEach(btn => btn.addEventListener('click', handleOpenExitModal));
            document.querySelectorAll('#journal-list .memo-btn').forEach(btn => btn.addEventListener('click', handleOpenMemoModal));
            document.querySelectorAll('#journal-list .tag-edit-btn').forEach(btn => btn.addEventListener('click', handleOpenTagEditModal));
        }
        
        function renderJournalTags(tags, containerId, type) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if(!tags) return;
            tags.forEach(tag => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag bg-[#EFF4F5] text-[#7A6EAA] rounded-full text-sm inline-flex items-center dark:bg-[#372F47] dark:text-[#b8add2] hover:bg-gray-200 transition px-3 py-1 font-medium';
                button.dataset.tag = tag;
                button.innerHTML = `<span>${tag}</span><span class="delete-tag-span ml-2 text-gray-400 hover:text-[#ED4B9E]"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></span>`;

                button.addEventListener('click', (e) => {
                    e.currentTarget.classList.toggle('selected');
                });
                button.querySelector('.delete-tag-span').addEventListener('click', (e) => {
                    e.stopPropagation(); handleDeleteJournalTag(tag, type);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
        }

        async function handleDeleteJournalTag(tag, type) {
            showConfirmModal(`'${tag}' íƒœê·¸ë¥¼ ì‚­ì œí• ê¹Œìš”?`, async () => {
                const newTags = localTags[type].filter(t => t !== tag);
                await db.collection("users").doc(currentUser.uid).collection("journalTags").doc("all").update({ [type]: newTags });
                showToast("ì‚­ì œ ì™„ë£Œ!");
            }, 'ì‚­ì œ');
        }
        
        async function addJournalTag(type, tag) {
            const currentTags = localTags[type] || [];
            if (!currentTags.includes(tag)) {
                await db.collection("users").doc(currentUser.uid).collection("journalTags").doc("all").update({ [type]: [...currentTags, tag] });
                showToast("íƒœê·¸ ì¶”ê°€ ì™„ë£Œ!");
            }
        }
        
        ['environment', 'entry', 'psychology'].forEach(type => {
            document.querySelector(`.add-${type}-tag-btn`).addEventListener('click', () => {
                const input = document.getElementById(`new-${type}-tag`);
                if(input.value.trim()) { addJournalTag(type, input.value.trim()); input.value = ''; }
            });
        });

        journalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const journalId = document.getElementById('journal-id').value;
            const assetType = document.querySelector('[data-group="asset-type"] .toggle-btn.selected').dataset.value;
            const journalData = {
                assetType,
                ticker: document.getElementById('ticker').value.toUpperCase(),
                date: Timestamp.fromDate(new Date(document.getElementById('date').value)),
                position: document.querySelector('[data-group="position"] .toggle-btn.selected').dataset.value,
                strategy: document.querySelector('[data-group="strategy"] .toggle-btn.selected').dataset.value, 
                currency: document.querySelector('[data-group="form-currency"] .toggle-btn.selected').id.includes('usd') ? 'USD' : 'KRW',
                entryPrice: parseFloat(unformatNumber(document.getElementById('entry-price').value)),
                stopLoss: parseFloat(unformatNumber(document.getElementById('stop-loss').value)), 
                targetPrice: parseFloat(unformatNumber(document.getElementById('target-price').value)),
                environmentTags: Array.from(document.querySelectorAll('#environment-tags-container .tag.selected')).map(b => b.dataset.tag),
                entryTags: Array.from(document.querySelectorAll('#entry-tags-container .tag.selected')).map(b => b.dataset.tag),
                psychologyTags: Array.from(document.querySelectorAll('#psychology-tags-container .tag.selected')).map(b => b.dataset.tag),
            };
            if (assetType === 'spot') {
                journalData.quantity = parseFloat(unformatNumber(document.getElementById('quantity').value));
                delete journalData.contracts; delete journalData.tickValue; delete journalData.tickSize;
            } else {
                journalData.contracts = parseFloat(unformatNumber(document.getElementById('contracts').value));
                journalData.tickValue = parseFloat(unformatNumber(document.getElementById('tick-value').value));
                journalData.tickSize = parseFloat(unformatNumber(document.getElementById('tick-size').value));
                delete journalData.quantity;
            }
            try {
                if (journalId) {
                    const existing = localJournals.find(j => j.id === journalId);
                    journalData.exits = existing.exits || []; journalData.memo = existing.memo || '';
                    await db.collection("users").doc(currentUser.uid).collection("journals").doc(journalId).update(journalData);
                    showToast("ì¼ì§€ ìˆ˜ì • ì™„ë£Œ! ğŸ‰");
                } else {
                    journalData.exits = []; journalData.memo = '';
                    await db.collection("users").doc(currentUser.uid).collection("journals").add(journalData);
                    showToast("ì¼ì§€ ì €ì¥ ì™„ë£Œ! ğŸ‰");
                }
                resetForm(); switchJournalView('list-view');
            } catch (error) { showToast("ì˜¤ë¥˜ ë°œìƒ ã… ã… ", "error"); }
        });
        
        async function handleDeleteJournal(e) {
            const id = e.currentTarget.dataset.id;
            showConfirmModal("ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?", async () => {
                await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).delete();
                showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, 'ì‚­ì œ');
        }

        async function handleEditJournal(e) {
            const journal = await getJournalById(e.currentTarget.dataset.id);
            if (journal) {
                document.getElementById('journal-id').value = journal.id;
                document.getElementById('date').value = journal.date.toISOString().split('T')[0];
                document.getElementById('ticker').value = journal.ticker;
                document.querySelector(`[data-group="asset-type"] .toggle-btn[data-value="${journal.assetType}"]`).click();
                ['position', 'strategy'].forEach(group => document.querySelectorAll(`[data-group="${group}"] .toggle-btn`).forEach(b => b.classList.toggle('selected', b.dataset.value === journal[group])));
                document.querySelectorAll('[data-group="form-currency"] .toggle-btn').forEach(b => b.classList.toggle('selected', (journal.currency === 'USD' && b.id.includes('usd')) || (journal.currency !== 'USD' && b.id.includes('krw'))));
                if (journal.assetType === 'spot') { document.getElementById('quantity').value = formatNumber(journal.quantity); } 
                else {
                    document.getElementById('contracts').value = formatNumber(journal.contracts);
                    document.getElementById('tick-value').value = formatNumber(journal.tickValue);
                    document.getElementById('tick-size').value = formatNumber(journal.tickSize);
                }
                ['entry-price', 'stop-loss', 'target-price'].forEach(id => document.getElementById(id).value = formatNumber(journal[id.replace('-','')]));
                // íƒœê·¸ ì„ íƒ ë³µêµ¬
                const restoreTags = (tags, containerId) => {
                    document.querySelectorAll(`#${containerId} .tag`).forEach(b => b.classList.remove('selected'));
                    (tags || []).forEach(tag => document.querySelector(`#${containerId} .tag[data-tag="${tag}"]`)?.classList.add('selected'));
                };
                restoreTags(journal.environmentTags, 'environment-tags-container');
                restoreTags(journal.entryTags, 'entry-tags-container');
                restoreTags(journal.psychologyTags, 'psychology-tags-container');

                switchJournalView('form-view'); window.scrollTo(0, 0);
            }
        }
        
        async function handleOpenMemoModal(e) {
             const journal = await getJournalById(e.currentTarget.dataset.id);
             if(journal) { document.getElementById('memo-journal-id').value = journal.id; document.getElementById('memo-content').value = journal.memo || ''; openModal('memo-modal'); }
        }
        document.getElementById('memo-form').addEventListener('submit', async(e)=>{ e.preventDefault(); const jId = document.getElementById('memo-journal-id').value; const memo = document.getElementById('memo-content').value.trim(); try { await db.collection("users").doc(currentUser.uid).collection("journals").doc(jId).update({memo}); showToast("ì €ì¥ ì™„ë£Œ!"); closeModal('memo-modal'); } catch(err) { showToast("ì‹¤íŒ¨", "error"); } });
        async function handleOpenExitModal(e) {
            const journal = await getJournalById(e.currentTarget.dataset.id);
            if(journal){
                const isSpot = journal.assetType === 'spot';
                const totalAmount = isSpot ? journal.quantity : journal.contracts;
                const exitedAmount = journal.exits ? journal.exits.reduce((s, ex) => s + ex.quantity, 0) : 0;
                const remaining = totalAmount - exitedAmount;
                document.getElementById('exit-journal-id').value = journal.id;
                document.getElementById('exit-quantity-label').textContent = isSpot ? 'ìˆ˜ëŸ‰' : 'ê³„ì•½ ìˆ˜';
                document.getElementById('remaining-quantity').textContent = formatNumber(remaining);
                document.getElementById('exit-quantity').dataset.max = remaining;
                document.getElementById('exit-quantity').value = formatNumber(remaining);
                document.getElementById('exit-date').value = new Date().toISOString().split('T')[0];
                openModal('exit-modal');
            }
        }
        document.getElementById('exit-form').addEventListener('submit', async(e)=>{ e.preventDefault();
            const jId = document.getElementById('exit-journal-id').value;
            const journal = await getJournalById(jId);
            const price = parseFloat(unformatNumber(document.getElementById('exit-price').value));
            const quantity = parseFloat(unformatNumber(document.getElementById('exit-quantity').value));
            const date = Timestamp.fromDate(new Date(document.getElementById('exit-date').value));
            const maxQ = parseFloat(document.getElementById('exit-quantity').dataset.max);
            if(quantity > maxQ + 1e-9) { showToast("ìˆ˜ëŸ‰ ì´ˆê³¼!", "error"); return; }
            const newExit = { price, quantity, date };
            await db.collection("users").doc(currentUser.uid).collection("journals").doc(jId).update({exits: [...(journal.exits||[]), newExit]});
            showToast("ì²­ì‚° ì™„ë£Œ!"); closeModal('exit-modal');
        });
        
        function renderJournalStats(journals) { 
             const completed = journals.filter(j => {
                const isSpot = j.assetType === 'spot';
                const total = isSpot ? j.quantity : j.contracts;
                const exited = j.exits ? j.exits.reduce((s, e) => s + e.quantity, 0) : 0;
                return j.exits && j.exits.length > 0 && (total - exited <= 1e-9);
            });
            let wins = 0; let totalPnl = 0; const ratios = [];
            completed.forEach(j => {
                const pnl = j.exits.reduce((s, e) => s + calculatePnl(j, e), 0);
                const pnlKrw = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                totalPnl += pnlKrw;
                if(pnl > 0) wins++;
                const reward = Math.abs(j.targetPrice - j.entryPrice);
                const risk = Math.abs(j.entryPrice - j.stopLoss);
                if(risk > 0) ratios.push(reward/risk);
            });
            const rate = completed.length ? (wins/completed.length)*100 : 0;
            const avgRatio = ratios.length ? ratios.reduce((a,b)=>a+b,0)/ratios.length : 0;
            
            document.getElementById('total-win-rate').textContent = `${rate.toFixed(1)}%`;
            document.getElementById('average-pl-ratio').textContent = `${avgRatio.toFixed(2)}`;
            const pnlVal = totalPnl * (statsCurrency === 'USD' ? 1/exchangeRate : 1);
            document.getElementById('total-realized-pnl').textContent = formatPrice(pnlVal, statsCurrency);
            
            renderPnlCompositionChart(completed);
            renderPnlTrendCharts(completed);
        }

        function renderPnlCompositionChart(journals) {
            let profit = 0; let loss = 0;
            journals.forEach(j => {
                const pnl = j.exits.reduce((s, e) => s + calculatePnl(j, e), 0);
                const pnlKrw = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                if(pnlKrw > 0) profit += pnlKrw; else loss += Math.abs(pnlKrw);
            });
            createJournalChart('pnl-composition-chart', 'doughnut', ['ìˆ˜ìµ', 'ì†ì‹¤'], [profit, loss], 'ì†ìµ');
        }
        
        function renderPnlTrendCharts(journals) {
             const monthly = {};
             journals.forEach(j => {
                 const d = j.date; const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                 const pnl = j.exits.reduce((s, e) => s + calculatePnl(j,e), 0);
                 const pnlKrw = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                 monthly[k] = (monthly[k]||0) + pnlKrw;
             });
             const keys = Object.keys(monthly).sort();
             const vals = keys.map(k => monthly[k]);
             createJournalChart('monthly-pnl-chart', 'bar', keys, vals, 'ì›”ë³„ ì†ìµ');
             const summaryEl = document.getElementById('monthly-pnl-summary');
             summaryEl.innerHTML = keys.map((k,i) => `<span>${k}: <strong class="${vals[i]>=0?'text-[#31D0AA]':'text-[#ED4B9E]'}">${formatPrice(vals[i] * (statsCurrency==='USD'?1/exchangeRate:1), statsCurrency)}</strong></span>`).join(' &nbsp;|&nbsp; ');
        }

        function createJournalChart(canvasId, type, labels, data, label) {
            const colors = ['#1FC7D4', '#ED4B9E', '#FFB237', '#7645D9'];
            if (charts[canvasId]) charts[canvasId].destroy();
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            const pnlMult = statsCurrency === 'USD' ? 1/exchangeRate : 1;
            const chartData = data.map(d => d * pnlMult);
            
            charts[canvasId] = new Chart(ctx, { 
                type, 
                data: { labels, datasets: [{ label, data: chartData, backgroundColor: type==='doughnut'?colors:chartData.map(d=>d>=0?'#31D0AA':'#ED4B9E'), borderRadius: 4 }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: type==='doughnut' } }, 
                    scales: { y: { beginAtZero: true, grid: { color: document.documentElement.classList.contains('dark')?'#383241':'#E7E3EB' } }, x: { grid: { display: false } } } 
                } 
            });
        }


        // ================== HOUSEHOLD LEDGER LOGIC ==================

        async function initializeLedgerDefaults(userId) {
            const categoriesDocRef = db.collection("users").doc(userId).collection("ledgerData").doc("categories");
            const docSnap = await categoriesDocRef.get();
            if (!docSnap.exists) {
                await categoriesDocRef.set({
                    expense: ['ì‹ë¹„ ğŸ”', 'êµí†µë¹„ ğŸšŒ', 'ì‡¼í•‘ ğŸ›ï¸', 'êµ¬ë…ë£Œ ğŸ“º', 'ì¹´í˜ â˜•', 'ì·¨ë¯¸ ğŸ¨'],
                    income: ['ì›”ê¸‰ ğŸ’¸', 'ìš©ëˆ ğŸ§§', 'ë¶€ìˆ˜ì… ğŸš€']
                });
            }
        }

        function attachLedgerListeners(userId) {
            if (unsubscribeLedger) unsubscribeLedger();
            unsubscribeLedger = db.collection("users").doc(userId).collection("ledgerEntries").orderBy("date", "desc")
                .onSnapshot((snapshot) => {
                    localLedgerEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                    renderLedgerAnalysisView(); 
                });

            if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
            unsubscribeLedgerCategories = db.collection("users").doc(userId).collection("ledgerData").doc("categories")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        localLedgerCategories = { expense: data.expense || [], income: data.income || [] };
                    }
                    renderLedgerCategoryTags(localLedgerCategories.expense, 'expense');
                    renderLedgerCategoryTags(localLedgerCategories.income, 'income');
                });
        }
        
        function switchLedgerView(tabId) {
            document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.ledgerTab === tabId));
            ['ledger-form-view', 'ledger-analysis-view'].forEach(viewId => document.getElementById(viewId).classList.toggle('hidden', viewId !== tabId));
            if(tabId === 'ledger-analysis-view') renderLedgerAnalysisView();
            lucide.createIcons();
        }
        document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.addEventListener('click', () => switchLedgerView(btn.dataset.ledgerTab)));

        function renderLedgerCategoryTags(categories, type) {
            const container = document.getElementById(`ledger-${type}-category-tags-container`);
            container.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag bg-[#EFF4F5] text-[#7A6EAA] rounded-full text-sm inline-flex items-center px-4 py-2 font-bold hover:bg-gray-200 transition dark:bg-[#372F47] dark:text-[#b8add2]';
                button.dataset.tag = cat;
                button.innerHTML = `<span>${cat}</span><span class="delete-tag-span ml-2 text-gray-400 hover:text-[#ED4B9E]"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></span>`;
                button.addEventListener('click', () => {
                    container.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
                    button.classList.add('selected');
                });
                button.querySelector('.delete-tag-span').addEventListener('click', (e) => {
                    e.stopPropagation(); handleDeleteLedgerCategory(cat, type);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
        }
        
        async function addLedgerCategory(type) {
            const input = document.getElementById(`new-ledger-${type}-category`);
            const newCategory = input.value.trim();
            if (newCategory) {
                const updated = [...localLedgerCategories[type], newCategory];
                await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").update({ [type]: updated });
                showToast("ì¶”ê°€ ì™„ë£Œ!"); input.value = '';
            }
        }
        document.getElementById('add-ledger-expense-category-btn').addEventListener('click', () => addLedgerCategory('expense'));
        document.getElementById('add-ledger-income-category-btn').addEventListener('click', () => addLedgerCategory('income'));
        
        async function handleDeleteLedgerCategory(category, type) {
             showConfirmModal(`'${category}' ì‚­ì œí• ê¹Œìš”?`, async () => {
                const updated = localLedgerCategories[type].filter(c => c !== category);
                await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").update({ [type]: updated });
                showToast("ì‚­ì œ ì™„ë£Œ!");
             }, 'ì‚­ì œ');
        }

        document.getElementById('ledger-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('ledger-id').value;
            const type = document.querySelector('[data-group="ledger-type"] .toggle-btn.selected').dataset.value;
            const selectedCategoryTag = document.querySelector(`#ledger-${type}-category-tags-container .tag.selected`);
            const amount = parseFloat(unformatNumber(document.getElementById('ledger-amount').value));

            if(!selectedCategoryTag) { showToast("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!", "error"); return; }
            
            const entryData = {
                type, date: Timestamp.fromDate(new Date(document.getElementById('ledger-date').value)),
                amount, category: selectedCategoryTag.dataset.tag,
                memo: document.getElementById('ledger-memo').value.trim()
            };

            try {
                if (id) await db.collection("users").doc(currentUser.uid).collection("ledgerEntries").doc(id).update(entryData);
                else await db.collection("users").doc(currentUser.uid).collection("ledgerEntries").add(entryData);
                showToast("ë‚´ì—­ ì €ì¥ ì™„ë£Œ! ğŸ‰");
                resetLedgerForm(); switchLedgerView('ledger-analysis-view');
            } catch (error) { showToast("ì €ì¥ ì‹¤íŒ¨", "error"); }
        });
        
        function resetLedgerForm() {
            document.getElementById('ledger-form').reset();
            document.getElementById('ledger-id').value = '';
            document.getElementById('ledger-date').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('#ledger-form .tag.selected').forEach(t => t.classList.remove('selected'));
            document.querySelector('#ledger-form .toggle-btn[data-value="expense"]').click();
        }
        document.getElementById('clear-ledger-form-btn').addEventListener('click', resetLedgerForm);

        function renderLedgerAnalysisView() {
            const filterType = document.getElementById('ledger-analysis-filter-type').value;
            const { start, end, displayString } = getPeriod(ledgerAnalysisDate, filterType);
            document.getElementById('ledger-analysis-period-display').textContent = displayString;
            
            const filteredEntries = localLedgerEntries.filter(e => e.date >= start && e.date <= end);
            
            let totalIncome = 0, totalExpense = 0;
            const expenseByCategory = {}, incomeByCategory = {};
            
            filteredEntries.forEach(e => {
                const category = e.category || 'ê¸°íƒ€';
                if (e.type === 'income') {
                    totalIncome += e.amount;
                    incomeByCategory[category] = (incomeByCategory[category] || 0) + e.amount;
                } else {
                    totalExpense += e.amount;
                    expenseByCategory[category] = (expenseByCategory[category] || 0) + e.amount;
                }
            });
            
            document.getElementById('ledger-total-income').textContent = formatPrice(totalIncome, 'KRW');
            document.getElementById('ledger-total-expense').textContent = formatPrice(totalExpense, 'KRW');
            const balance = totalIncome - totalExpense;
            const balanceEl = document.getElementById('ledger-balance');
            balanceEl.textContent = formatPrice(balance, 'KRW');
            balanceEl.className = `text-3xl font-extrabold ${balance >= 0 ? 'text-[#1FC7D4]' : 'text-[#ED4B9E]'}`;

            renderLedgerCharts(filterType, start, end, displayString, filteredEntries, expenseByCategory, incomeByCategory);

            const renderSummaryList = (data, containerId, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]);
                if(sorted.length === 0) container.innerHTML = `<p class="text-xs text-[#7A6EAA] dark:text-[#b8add2]">ë‚´ì—­ ì—†ìŒ</p>`;
                
                sorted.forEach(([cat, amount]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 rounded-xl hover:bg-[#EFF4F5] dark:hover:bg-[#372F47] cursor-pointer transition';
                    const colorClass = type === 'income' ? 'text-[#31D0AA]' : 'text-[#ED4B9E]';
                    div.innerHTML = `<span class="font-bold text-[#7A6EAA] dark:text-[#b8add2]">${cat}</span><span class="font-extrabold ${colorClass}">${formatPrice(amount, 'KRW')}</span>`;
                    div.onclick = () => {
                         document.querySelectorAll('#ledger-category-summary > div, #ledger-income-summary > div').forEach(el => el.classList.remove('selected'));
                         div.classList.add('selected');
                         renderLedgerDetails(cat, type, filteredEntries);
                    };
                    container.appendChild(div);
                });
            };
            renderSummaryList(expenseByCategory, 'ledger-category-summary', 'expense');
            renderSummaryList(incomeByCategory, 'ledger-income-summary', 'income');

            document.getElementById('ledger-detail-title').textContent = 'ì „ì²´ ë‚´ì—­';
            renderLedgerDetails(null, null, filteredEntries);
        }

        function renderLedgerCharts(filterType, start, end, displayString, entries, expenseData, incomeData) {
             let trendLabels, trendIncome, trendExpense;
             if(filterType === 'year') {
                trendLabels = Array.from({length: 12}, (_, i) => `${i + 1}ì›”`);
                const monthly = trendLabels.map(() => ({i:0, e:0}));
                entries.forEach(e => { if(e.type==='income') monthly[e.date.getMonth()].i += e.amount; else monthly[e.date.getMonth()].e += e.amount; });
                trendIncome = monthly.map(d=>d.i); trendExpense = monthly.map(d=>d.e);
             } else {
                 const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                 trendLabels = Array.from({length: days + 1}, (_, i) => {
                     const d = new Date(start); d.setDate(d.getDate() + i);
                     return `${d.getMonth()+1}/${d.getDate()}`;
                 });
                 const daily = {};
                 entries.forEach(e => {
                     const key = `${e.date.getMonth()+1}/${e.date.getDate()}`;
                     if(!daily[key]) daily[key] = {i:0, e:0};
                     if(e.type === 'income') daily[key].i += e.amount; else daily[key].e += e.amount;
                 });
                 trendIncome = trendLabels.map(l => daily[l]?.i || 0);
                 trendExpense = trendLabels.map(l => daily[l]?.e || 0);
             }
             createLedgerChart('ledger-monthly-pnl-chart', 'bar', trendLabels, [{ label: 'ìˆ˜ì…', data: trendIncome, backgroundColor: '#31D0AA', borderRadius:4 }, { label: 'ì§€ì¶œ', data: trendExpense, backgroundColor: '#ED4B9E', borderRadius:4 }]);
             
             const sortAndMap = (data) => {
                 const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
                 return { l: sorted.map(x=>x[0]), d: sorted.map(x=>x[1]) };
             };
             const exp = sortAndMap(expenseData);
             const inc = sortAndMap(incomeData);
             const psColors = ['#ED4B9E', '#FFB237', '#1FC7D4', '#7645D9', '#31D0AA'];
             
             createLedgerChart('ledger-expense-chart', 'doughnut', exp.l, [{ data: exp.d, backgroundColor: psColors, borderWidth: 0 }]);
             createLedgerChart('ledger-income-chart', 'doughnut', inc.l, [{ data: inc.d, backgroundColor: psColors, borderWidth: 0 }]);
        }

        function renderLedgerDetails(category, type, entries) {
            const container = document.getElementById('ledger-entry-details');
            container.innerHTML = '';
            let targetEntries = entries;
            
            if (category) {
                targetEntries = entries.filter(e => e.type === type && (e.category === category));
                document.getElementById('ledger-detail-title').textContent = `${category} ë‚´ì—­`;
            }

            if(targetEntries.length === 0) {
                container.innerHTML = `<div class="text-center p-6 text-[#7A6EAA] dark:text-[#b8add2]">ë‚´ì—­ì´ ì—†ì–´ìš” í……~ ğŸ—‘ï¸</div>`;
                return;
            }

            targetEntries.sort((a,b) => b.date - a.date).forEach(entry => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-[#F4F4F4] dark:bg-[#372F47] rounded-2xl hover:bg-white dark:hover:bg-[#27262C] transition shadow-sm border border-transparent';
                const color = entry.type === 'income' ? 'text-[#31D0AA]' : 'text-[#ED4B9E]';
                const sign = entry.type === 'income' ? '+' : '-';
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-white dark:bg-[#27262C] p-2 rounded-xl shadow-sm text-lg">${entry.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸'}</div>
                        <div>
                            <p class="font-bold text-[#280D5F] dark:text-[#F4EEFF] text-sm">${entry.category || 'ë¯¸ë¶„ë¥˜'}</p>
                            <p class="text-xs text-[#7A6EAA] dark:text-[#b8add2]">${entry.date.toLocaleDateString()} ${entry.memo ? `Â· ${entry.memo}` : ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-extrabold ${color}">${sign} ${formatPrice(entry.amount, 'KRW')}</span>
                        <div class="flex gap-1">
                             <button class="p-1.5 hover:bg-[#EFF4F5] dark:hover:bg-blue-900/30 rounded-lg text-[#7A6EAA] hover:text-[#1FC7D4] transition edit-ledger-btn" data-id="${entry.id}"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                             <button class="p-1.5 hover:bg-[#EFF4F5] dark:hover:bg-red-900/30 rounded-lg text-[#7A6EAA] hover:text-[#ED4B9E] transition delete-ledger-btn" data-id="${entry.id}"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
            document.querySelectorAll('.edit-ledger-btn').forEach(b => b.addEventListener('click', handleEditLedgerEntry));
            document.querySelectorAll('.delete-ledger-btn').forEach(b => b.addEventListener('click', handleDeleteLedgerEntry));
        }

        function handleEditLedgerEntry(e) {
            const id = e.currentTarget.dataset.id;
            const entry = localLedgerEntries.find(item => item.id === id);
            if (entry) {
                switchLedgerView('ledger-form-view');
                document.getElementById('ledger-id').value = entry.id;
                document.getElementById('ledger-date').value = entry.date.toISOString().split('T')[0];
                document.getElementById('ledger-amount').value = formatNumber(entry.amount);
                document.getElementById('ledger-memo').value = entry.memo;
                document.querySelector(`.toggle-btn[data-value="${entry.type}"]`).click();
                if(entry.category) {
                    document.querySelector(`#ledger-${entry.type}-category-tags-container .tag[data-tag="${entry.category}"]`)?.click();
                }
            }
        }
        
        function handleDeleteLedgerEntry(e) {
             const id = e.currentTarget.dataset.id;
             showConfirmModal('ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?', () => {
                 db.collection("users").doc(currentUser.uid).collection("ledgerEntries").doc(id).delete()
                   .then(() => { showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); renderLedgerAnalysisView(); })
                   .catch(() => showToast("ì‚­ì œ ì‹¤íŒ¨", "error"));
             }, 'ì‚­ì œ');
        }

        function updateLedgerAnalysisDate(offset) {
            const filterType = document.getElementById('ledger-analysis-filter-type').value;
            if (filterType === 'month') ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth() + offset);
            else if (filterType === 'quarter') ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth() + offset * 3);
            else ledgerAnalysisDate.setFullYear(ledgerAnalysisDate.getFullYear() + offset);
            renderLedgerAnalysisView();
        }
        document.getElementById('ledger-analysis-prev-btn').addEventListener('click', () => updateLedgerAnalysisDate(-1));
        document.getElementById('ledger-analysis-next-btn').addEventListener('click', () => updateLedgerAnalysisDate(1));
        document.getElementById('ledger-analysis-filter-type').addEventListener('change', () => {
            ledgerAnalysisDate = new Date(); 
            renderLedgerAnalysisView();
        });

        function createLedgerChart(canvasId, type, labels, datasets) {
            if (charts[canvasId]) charts[canvasId].destroy();
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            const isDark = document.documentElement.classList.contains('dark');
            charts[canvasId] = new Chart(ctx, {
                type, data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: type === 'doughnut', position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, color: isDark ? '#b8add2' : '#7A6EAA' } } },
                    scales: (type === 'bar') ? { x: { grid: { display: false }, ticks: { color: isDark ? '#b8add2' : '#7A6EAA' } }, y: { beginAtZero: true, grid: { borderDash: [2, 2], color: isDark ? '#383241' : '#e7e3eb' }, ticks: { color: isDark ? '#b8add2' : '#7A6EAA' } } } : {}
                }
            });
        }
        
        function getPeriod(date, filterType) {
            const year = date.getFullYear(); const month = date.getMonth();
            let start, end, displayString;
            if (filterType === 'month') { displayString = `${year}ë…„ ${month + 1}ì›”`; start = new Date(year, month, 1); end = new Date(year, month + 1, 0, 23, 59, 59); }
            else if (filterType === 'quarter') { const q = Math.floor(month / 3) + 1; displayString = `${year}ë…„ ${q}ë¶„ê¸°`; start = new Date(year, (q - 1) * 3, 1); end = new Date(year, q * 3, 0, 23, 59, 59); }
            else { displayString = `${year}ë…„`; start = new Date(year, 0, 1); end = new Date(year, 11, 31, 23, 59, 59); }
            return { start, end, displayString };
        }
        const unformatNumber = (v) => v ? v.toString().replace(/,/g, '') : '';
        const formatNumber = (v) => { if (v === null || v === undefined || v === '') return ''; return unformatNumber(v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); };
        const formatPrice = (p, c) => { if (isNaN(p) || p === null) return ''; const n = parseFloat(p); return c === 'USD' ? `$${n.toLocaleString('en-US', {maximumFractionDigits: 2})}` : `â‚©${n.toLocaleString('en-US', {maximumFractionDigits: 0})}`; };
        const formatDualCurrency = (krw, cur) => { const usd = krw / exchangeRate; return cur === 'KRW' ? `${formatPrice(krw, 'KRW')} (${formatPrice(usd, 'USD')})` : `${formatPrice(usd, 'USD')} (${formatPrice(krw, 'KRW')})`; }
        
        function openModal(id) { const m = document.getElementById(id); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.firstElementChild.classList.remove('scale-95'); }, 10); if(id==='tag-edit-modal') lucide.createIcons(); }
        function closeModal(id) { const m = document.getElementById(id); m.firstElementChild.classList.add('scale-95'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        document.getElementById('close-modal-btn').addEventListener('click', () => closeModal('exit-modal'));
        document.getElementById('exit-modal').
