<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ & ê°€ê³„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-color 0.3s ease;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { background-color: #4a90e2; color: white; font-weight: 700; }
        .tag { transition: all 0.2s ease; cursor: pointer; }
        .tag.selected { background-color: #4a90e2; color: white; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        .toggle-group { display: flex; border-radius: 0.75rem; padding: 0.25rem; background-color: #e5e7eb; }
        .toggle-btn { flex: 1; padding: 0.5rem 0; border-radius: 0.5rem; border: none; background-color: transparent; font-weight: 500; transition: all 0.2s ease-in-out; cursor: pointer; }
        .toggle-btn.selected { background-color: white; color: #3b82f6; font-weight: 700; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        .tag.selected .delete-tag-span { color: white; }
        .tag.selected .delete-tag-span:hover { color: #fecaca; }

        /* Updated Dark Mode Styles */
        .dark body { background-color: #121212; color: #E0E0E0; }
        .dark h1, .dark h2, .dark h3 { color: #FFFFFF; }
        .dark p, .dark label, .dark span, .dark strong { color: #E0E0E0; }
        .dark header p, .dark .text-gray-500, .dark .main-tab-btn { color: #BDBDBD; }
        .dark .main-tab-btn.active { color: #3b82f6; border-color: #3b82f6;}
        .dark #auth-info { color: #828282; }
        .dark #theme-toggle:hover, .dark #logout-btn:hover { background-color: #2d2d2d; }
        .dark nav, .dark form, .dark .bg-white { background-color: #1E1E1E; }
        .dark .tab-btn { color: #E0E0E0; }
        .dark .tab-btn.active { background-color: #3b82f6; color: white; }
        .dark input, .dark .toggle-group, .dark select, .dark textarea { background-color: #2d2d2d; border-color: #4F4F4F; color: #E0E0E0; }
        .dark input::placeholder { color: #828282; }
        .dark .toggle-btn { color: #BDBDBD; }
        .dark .toggle-btn.selected { background-color: #4F4F4F; color: #FFFFFF; font-weight: 700; box-shadow: none; }
        .dark .tag.selected { background-color: #3b82f6; color: #ffffff; }
        .dark .entry-tags-container .tag.selected { background-color: #16a34a; }
        .dark .psychology-tags-container .tag.selected { background-color: #9333ea; }
        .dark .border-blue-200 { border-color: #3b82f6; }
        .dark .border-green-200 { border-color: #16a34a; }
        .dark .border-purple-200 { border-color: #9333ea; }
        .dark .bg-blue-50 { background-color: #2d2d2d; border-color: #4F4F4F; }
        .dark .text-blue-800 { color: #E0E0E0; }
        .dark .bg-gray-200 { background-color: #333333; }
        .dark .text-gray-700 { color: #E0E0E0; }
        .dark .text-gray-600 { color: #BDBDBD; }
        .dark .text-gray-800 { color: #FFFFFF; }
        .dark .bg-green-100 { background-color: rgba(22, 163, 74, 0.2); }
        .dark .text-green-800 { color: #4ade80; }
        .dark .bg-purple-100 { background-color: rgba(147, 51, 234, 0.2); }
        .dark .text-purple-800 { color: #c084fc; }
        .dark .border-gray-200 { border-color: #4F4F4F; }
        .dark .bg-gray-50 { background-color: #2d2d2d; }
        .dark .hover\:bg-gray-100:hover { background-color: #2d2d2d; }
        .dark .bg-gray-300 { background-color: #4F4F4F; }
        .dark .hover\:bg-gray-400:hover { background-color: #666666; }
        .dark #ledger-category-summary > div:hover, .dark #ledger-income-summary > div:hover { background-color: #2d2d2d; }
        .dark .bg-gray-50 { background-color: #2d2d2d; }
        .dark .bg-gray-50 .text-gray-700 { color: #E0E0E0; }
        .dark .bg-gray-50 .text-gray-500 { color: #BDBDBD; }
        
        /* Category selection highlight */
        #ledger-category-summary > div.selected, #ledger-income-summary > div.selected { background-color: #dbeafe; /* blue-100 */ }
        .dark #ledger-category-summary > div.selected, .dark #ledger-income-summary > div.selected { background-color: #2563eb; /* blue-600 */ }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">ë‚˜ì˜ ë§¤ë§¤ì¼ì§€ & ê°€ê³„ë¶€ ğŸ“</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">ë‹¹ì‹ ì˜ ëª¨ë“  ê¸°ë¡ì„ í†µí•´ ì„±ì¥í•˜ì„¸ìš”!</p>
            <button id="login-btn" class="bg-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center justify-center">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 hidden">
        
        <header class="mb-6 relative flex items-center justify-center">
            <div class="text-center px-16 sm:px-20">
                <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">ë‚˜ì˜ ê¸°ë¡ ê´€ë¦¬</h1>
                <p class="text-center text-gray-500">ë§¤ë§¤ì¼ì§€ & ê°€ê³„ë¶€</p>
                <div id="auth-info" class="text-center text-xs mt-2"></div>
            </div>
            <div class="absolute top-0 right-0 flex items-center h-full space-x-2">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i id="sun-icon" data-lucide="sun" class="h-6 w-6"></i><i id="moon-icon" data-lucide="moon" class="h-6 w-6"></i></button>
                <button id="logout-btn" title="ë¡œê·¸ì•„ì›ƒ" class="text-sm font-semibold hover:text-red-500 transition-colors p-2 rounded-md hover:bg-gray-200"><i data-lucide="log-out" class="h-5 w-5"></i></button>
            </div>
        </header>

        <div class="border-b-2 border-gray-200 dark:border-gray-700 mb-8">
            <nav class="-mb-0.5 flex justify-center space-x-6">
                <button data-main-tab="journal-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600 active"><i data-lucide="book-marked" class="w-5 h-5"></i>ë§¤ë§¤ì¼ì§€</button>
                <button data-main-tab="ledger-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600"><i data-lucide="piggy-bank" class="w-5 h-5"></i>ê°€ê³„ë¶€</button>
            </nav>
        </div>

        <div id="journal-container">
            <nav class="flex justify-center bg-white rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2">
                <button data-tab="form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="plus-circle" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>ì¼ì§€ ì‘ì„±</button>
                <button data-tab="list-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="book-open" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>ë‚´ ì¼ì§€</button>
                <button data-tab="stats-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="bar-chart-2" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>ì„±ê³¼ ë¶„ì„</button>
            </nav>
            <main id="journal-main-content">
                <div id="form-view">
                    <form id="journal-form" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                        <input type="hidden" id="journal-id">
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-blue-200 pb-2 flex items-center"><i data-lucide="clipboard-list" class="mr-3 text-blue-500"></i>ê¸°ë³¸ ì •ë³´</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="sm:col-span-2"><span class="block text-sm font-medium text-gray-700 mb-2">ìì‚° ìœ í˜•</span><div class="toggle-group text-gray-600" data-group="asset-type"><button type="button" data-value="spot" class="toggle-btn selected">í˜„ë¬¼</button><button type="button" data-value="futures" class="toggle-btn">ì„ ë¬¼</button></div></div>
                                <div class="sm:col-span-2"><label for="ticker" class="block text-sm font-medium text-gray-700 mb-1">ì¢…ëª© ì´ë¦„</label><input type="text" id="ticker" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì, ZB" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div><label for="date" class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label><input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div><span class="block text-sm font-medium text-gray-700 mb-2">í¬ì§€ì…˜</span><div class="toggle-group text-gray-600" data-group="position"><button type="button" data-value="long" class="toggle-btn selected">ğŸŸ¢ ë¡±</button><button type="button" data-value="short" class="toggle-btn">ğŸ”´ ìˆ</button></div></div>
                                <div><span class="block text-sm font-medium text-gray-700 mb-2">ë§¤ë§¤ ì „ëµ</span><div class="toggle-group text-gray-600" data-group="strategy"><button type="button" data-value="ë‹¨íƒ€" class="toggle-btn selected">ë‹¨íƒ€</button><button type="button" data-value="ìŠ¤ìœ™" class="toggle-btn">ìŠ¤ìœ™</button><button type="button" data-value="ì¥ê¸°" class="toggle-btn">ì¥ê¸°</button></div></div>
                                <div><span class="block text-sm font-medium text-gray-700 mb-2">ì…ë ¥ í†µí™”</span><div class="toggle-group text-gray-600" data-group="form-currency"><button type="button" id="form-currency-krw-btn" class="toggle-btn">ì› (â‚©)</button><button type="button" id="form-currency-usd-btn" class="toggle-btn selected">ë‹¬ëŸ¬ ($)</button></div></div>
                                
                                <div id="spot-fields">
                                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">ìˆ˜ëŸ‰</label>
                                    <input type="text" inputmode="numeric" id="quantity" placeholder="ì˜ˆ: 100" class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white">
                                </div>
                                
                                <div id="futures-fields" class="hidden sm:col-span-2">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="contracts" class="block text-sm font-medium text-gray-700 mb-1">ê³„ì•½ ìˆ˜</label>
                                            <input type="text" inputmode="numeric" id="contracts" placeholder="ì˜ˆ: 1" class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white">
                                        </div>
                                        <div class="sm:col-span-2">
                                            <p class="text-xs text-gray-500 mt-2">
                                                * ì±„ê¶Œ ì„ ë¬¼($\text{ZB/ZN/ZF}$ ë“±)ì€ $120'16$ ë˜ëŠ” $120'16'5$ í˜•ì‹ìœ¼ë¡œ, ì¼ë°˜ ì„ ë¬¼ì€ $10,000$ í˜•ì‹ìœ¼ë¡œ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”.
                                            </p>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                            <div class="sm:col-span-3 bg-gray-50 dark:bg-[#2d2d2d] p-4 rounded-lg border border-gray-200 dark:border-[#4F4F4F]">
                                                <h3 class="text-base font-semibold mb-2 flex justify-between items-center">
                                                    ì„ ë¬¼ ì¢…ëª© ì •ë³´ ê´€ë¦¬
                                                    <button type="button" id="delete-futures-info-btn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-xs flex items-center disabled:opacity-50 disabled:cursor-not-allowed" title="ì„ íƒëœ ì¢…ëª© ì •ë³´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (ë§¤ë§¤ì¼ì§€ì—ì„œ ì‚¬ìš© ì¤‘ì´ë©´ ì‚­ì œ ë¶ˆê°€)">
                                                        <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i> ì‚­ì œ
                                                    </button>
                                                </h3>
                                                <div class="flex flex-col sm:flex-row gap-2">
                                                    <select id="futures-info-select" class="flex-grow p-2 border border-gray-300 dark:border-[#4F4F4F] rounded-lg bg-white dark:bg-[#1E1E1E]">
                                                        <option value="">- ì¢…ëª© ì„ íƒ (í‹±ê°€ì¹˜/ë‹¨ìœ„ ë¶ˆëŸ¬ì˜¤ê¸°) -</option>
                                                    </select>
                                                    <button type="button" id="save-futures-info-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm">ì •ë³´ ì €ì¥</button>
                                                </div>
                                                <div class="mt-4 grid grid-cols-2 gap-4">
                                                    <div id="tick-value-field">
                                                        <label for="tick-value" class="block text-sm font-medium text-gray-700 mb-1">í‹±ê°€ì¹˜ ($)</label>
                                                        <input type="text" inputmode="decimal" id="tick-value" placeholder="ì˜ˆ: 31.25" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]">
                                                    </div>
                                                    <div id="tick-size-field">
                                                        <label for="tick-size" class="block text-sm font-medium text-gray-700 mb-1">í‹±ë‹¨ìœ„</label>
                                                        <input type="text" inputmode="decimal" id="tick-size" placeholder="ì˜ˆ: 0.03125" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]">
                                                    </div>
                                                    <div id="commission-buy-field">
                                                        <label for="commission-buy" class="block text-sm font-medium text-gray-700 mb-1">ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ ($)</label>
                                                        <input type="text" inputmode="decimal" id="commission-buy" placeholder="ì˜ˆ: 2.50" class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]">
                                                    </div>
                                                    <div id="commission-sell-field">
                                                        <label for="commission-sell" class="block text-sm font-medium text-gray-700 mb-1">ë§¤ë„ ìˆ˜ìˆ˜ë£Œ ($)</label>
                                                        <input type="text" inputmode="decimal" id="commission-sell" placeholder="ì˜ˆ: 2.50" class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="entry-price-wrapper"><label for="entry-price" class="block text-sm font-medium text-gray-700 mb-1" id="entry-price-label">ì§„ì…ê°€</label><input type="text" inputmode="text" id="entry-price" placeholder="ì˜ˆ: 10,000 ë˜ëŠ” 120'16" required class="price-input w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div id="target-price-wrapper"><label for="target-price" class="block text-sm font-medium text-gray-700 mb-1" id="target-price-label">ëª©í‘œê°€</label><input type="text" inputmode="text" id="target-price" placeholder="ì˜ˆ: 11,000 ë˜ëŠ” 121'00" required class="price-input w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div id="stop-loss-wrapper"><label for="stop-loss" class="block text-sm font-medium text-gray-700 mb-1" id="stop-loss-label">ì†ì ˆê°€</label><input type="text" inputmode="text" id="stop-loss" placeholder="ì˜ˆ: 9,500 ë˜ëŠ” 119'00" required class="price-input w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-green-200 pb-2 flex items-center"><i data-lucide="siren" class="mr-3 text-green-500"></i>ì§„ì… ê·¼ê±°</h2>
                            <div id="entry-tags-container" class="flex flex-wrap gap-2 mb-2 entry-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-entry-tag" placeholder="ìƒˆë¡œìš´ íƒœê·¸ ì¶”ê°€" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white"><button type="button" class="add-entry-tag-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">ì¶”ê°€</button></div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-purple-200 pb-2 flex items-center"><i data-lucide="brain-circuit" class="mr-3 text-purple-500"></i>ì‹¬ë¦¬ ìƒíƒœ</h2>
                            <div id="psychology-tags-container" class="flex flex-wrap gap-2 mb-2 psychology-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-psychology-tag" placeholder="ìƒˆë¡œìš´ íƒœê·¸ ì¶”ê°€" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white"><button type="button" class="add-psychology-tag-btn bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">ì¶”ê°€</button></div>
                        </div>
                        <div class="flex justify-end space-x-4"><button type="button" id="clear-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">ìƒˆë¡œ ì‘ì„±</button><button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>ì¼ì§€ ì €ì¥</button></div>
                    </form>
                </div>
                <div id="list-view" class="hidden">
                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-6 flex flex-wrap items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2"><label for="list-exchange-rate" class="font-medium text-sm text-gray-600">í™˜ìœ¨:</label><input type="text" inputmode="numeric" id="list-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white rounded-lg text-center"></div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm p-4 rounded-xl mb-6 flex items-center gap-3"><i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i><p>ì¼ì§€ ìš°ì¸¡ì˜ <i data-lucide="log-out" class="inline-block w-4 h-4 mx-1"></i>(ì²­ì‚°), <i data-lucide="sticky-note" class="inline-block w-4 h-4 mx-1"></i>(ë©”ëª¨), <i data-lucide="edit" class="inline-block w-4 h-4 mx-1"></i>(ìˆ˜ì •), <i data-lucide="trash-2" class="inline-block w-4 h-4 mx-1"></i>(ì‚­ì œ) ì•„ì´ì½˜ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.</p></div>
                    <div id="journal-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                <div id="stats-view" class="hidden space-y-8">
                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-6 flex flex-col sm:flex-row items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2"><label for="stats-exchange-rate" class="font-medium text-sm text-gray-600">í™˜ìœ¨:</label><input type="text" inputmode="numeric" id="stats-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white rounded-lg text-center"></div>
                        <div class="toggle-group text-gray-600 w-full sm:w-auto" data-group="stats-currency"><button id="stats-currency-krw-btn" class="toggle-btn selected">ì› (â‚©)</button><button id="stats-currency-usd-btn" class="toggle-btn">ë‹¬ëŸ¬ ($)</button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-xl font-bold mb-3">ì´ ìŠ¹ë¥ </h3><p id="total-win-rate" class="text-4xl font-bold text-blue-500">N/A</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-xl font-bold mb-3">í‰ê·  ì†ìµë¹„</h3><p id="average-pl-ratio" class="text-4xl font-bold text-green-500">N/A</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-1"><h3 class="text-xl font-bold mb-4">ì´ ì†ìµ êµ¬ì„±</h3><div class="chart-container"><canvas id="pnl-composition-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-2"><h3 class="text-xl font-bold mb-4">ì›”ë³„ ì†ìµ</h3><div class="chart-container"><canvas id="monthly-pnl-chart"></canvas></div><div id="monthly-pnl-summary" class="mt-4 text-sm text-center"></div></div>
                    </div>
                    <div class="grid grid-cols-1"><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">ë¶„ê¸°ë³„ ì†ìµ</h3><div class="chart-container"><canvas id="quarterly-pnl-chart"></canvas></div><div id="quarterly-pnl-summary" class="mt-4 text-sm text-center"></div></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">ì§„ì… ê·¼ê±°ë³„ ìŠ¹ë¥ </h3><div class="chart-container"><canvas id="entry-win-rate-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">ì‹¬ë¦¬ ìƒíƒœë³„ ìŠ¹ë¥ </h3><div class="chart-container"><canvas id="psychology-win-rate-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">ë§¤ë§¤ ì „ëµë³„ ìŠ¹ë¥ </h3><div class="chart-container"><canvas id="strategy-win-rate-chart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1"><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">ë¡±/ìˆ í¬ì§€ì…˜ ìŠ¹ë¥ </h3><div class="chart-container"><canvas id="position-win-rate-chart"></canvas></div></div></div>
                </div>
            </main>
        </div>

        <div id="ledger-container" class="hidden">
            <nav class="flex justify-center bg-white rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2">
                <button data-ledger-tab="ledger-form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="plus-circle" class="inline-block w-5 h-5 mr-2"></i>ë‚´ì—­ ì…ë ¥</button>
                <button data-ledger-tab="ledger-analysis-view" class="tab-btn text-gray-600 w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="pie-chart" class="inline-block w-5 h-5 mr-2"></i>ì†Œë¹„ ë¶„ì„</button>
            </nav>
            <main id="ledger-main-content">
                <div id="ledger-form-view">
                    <form id="ledger-form" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                        <input type="hidden" id="ledger-id">
                        <div>
                            <h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="edit-3" class="mr-3 text-blue-500"></i>ê°€ê³„ë¶€ ë‚´ì—­ ì…ë ¥</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="sm:col-span-2"><div class="toggle-group text-gray-600" data-group="ledger-type"><button type="button" data-value="expense" class="toggle-btn selected">ğŸ’¸ ì§€ì¶œ</button><button type="button" data-value="income" class="toggle-btn">ğŸ’° ìˆ˜ì…</button></div></div>
                                <div><label for="ledger-date" class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label><input type="date" id="ledger-date" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                <div><label for="ledger-amount" class="block text-sm font-medium text-gray-700 mb-1">ê¸ˆì•¡</label><input type="text" inputmode="numeric" id="ledger-amount" placeholder="ê¸ˆì•¡ ì…ë ¥" required class="number-input w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                                
                                <div class="sm:col-span-2" id="ledger-expense-category-section">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ì§€ì¶œ ì¹´í…Œê³ ë¦¬</label>
                                    <div id="ledger-expense-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                    <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-ledger-expense-category" placeholder="ìƒˆë¡œìš´ ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ì¶”ê°€" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white"><button type="button" id="add-ledger-expense-category-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">ì¶”ê°€</button></div>
                                </div>

                                <div class="sm:col-span-2 hidden" id="ledger-income-category-section">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ì… ì¹´í…Œê³ ë¦¬</label>
                                    <div id="ledger-income-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                    <div class="flex flex-col sm:flex-row gap-2"><input type="text" id="new-ledger-income-category" placeholder="ìƒˆë¡œìš´ ìˆ˜ì… ì¹´í…Œê³ ë¦¬ ì¶”ê°€" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white"><button type="button" id="add-ledger-income-category-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">ì¶”ê°€</button></div>
                                </div>

                                <div class="sm:col-span-2"><label for="ledger-memo" class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label><input type="text" id="ledger-memo" placeholder="ë©”ëª¨ ë‚´ìš© (ì„ íƒ)" class="w-full p-2 border border-gray-300 rounded-lg bg-white"></div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4"><button type="button" id="clear-ledger-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">ìƒˆë¡œ ì‘ì„±</button><button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>ë‚´ì—­ ì €ì¥</button></div>
                    </form>
                </div>

                <div id="ledger-analysis-view" class="hidden space-y-8">
                    <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-wrap items-center justify-center gap-4">
                        <select id="ledger-analysis-filter-type" class="p-2 border border-gray-300 rounded-lg"><option value="month">ì›”ë³„</option><option value="quarter">ë¶„ê¸°ë³„</option><option value="year">ì—°ë„ë³„</option></select>
                        <div class="flex items-center gap-2">
                            <button id="ledger-analysis-prev-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                            <span id="ledger-analysis-period-display" class="font-bold text-lg w-40 text-center"></span>
                            <button id="ledger-analysis-next-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2 text-green-500">ê¸°ê°„ ë‚´ ìˆ˜ì…</h3><p id="ledger-total-income" class="text-3xl font-bold">â‚©0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2 text-red-500">ê¸°ê°„ ë‚´ ì§€ì¶œ</h3><p id="ledger-total-expense" class="text-3xl font-bold">â‚©0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2">í•©ê³„</h3><p id="ledger-balance" class="text-3xl font-bold">â‚©0</p></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 id="ledger-expense-chart-title" class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h3><div class="chart-container"><canvas id="ledger-expense-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 id="ledger-income-chart-title" class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì…</h3><div class="chart-container"><canvas id="ledger-income-chart"></canvas></div></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg space-y-4">
                            <div>
                                <h3 class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h3>
                                <div id="ledger-category-summary" class="space-y-2"></div>
                            </div>
                             <div class="border-t pt-4">
                                <h3 class="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì…</h3>
                                <div id="ledger-income-summary" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ìƒì„¸ ë‚´ì—­: <span id="ledger-detail-title">ë‚´ì—­ ì„ íƒ</span></h3>
                            <div id="ledger-entry-details" class="space-y-2"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1"><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 id="ledger-trend-chart-title" class="text-xl font-bold mb-4">ìˆ˜ì…/ì§€ì¶œ ì¶”ì´</h3><div class="chart-container"><canvas id="ledger-monthly-pnl-chart"></canvas></div></div></div>

                </div>
            </main>
        </div>
    </div>
    
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md modal-content transform scale-95"><h2 class="text-2xl font-bold mb-6">ì²­ì‚° ê¸°ë¡</h2><form id="exit-form"><input type="hidden" id="exit-journal-id"><div class="space-y-4"><div><label for="exit-date">ì²­ì‚° ë‚ ì§œ</label><input type="date" id="exit-date" required class="mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg"></div><div><label for="exit-price">ì²­ì‚°ê°€</label><input type="text" inputmode="text" id="exit-price" required class="price-input mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg"></div><div><label for="exit-quantity" id="exit-quantity-label">ì²­ì‚° ìˆ˜ëŸ‰</label><input type="text" inputmode="numeric" id="exit-quantity" required class="number-input mt-1 w-full p-2 border border-gray-300 bg-white rounded-lg"><p class="text-xs text-gray-500 mt-1">ë‚¨ì€ ìˆ˜ëŸ‰: <span id="remaining-quantity"></span></p></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="close-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ì²­ì‚° ì¶”ê°€</button></div></form></div></div>
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm modal-content transform scale-95"><h2 id="confirm-title" class="text-xl font-bold mb-4">í™•ì¸</h2><p id="confirm-message" class="text-gray-600 mb-6"></p><div class="flex justify-end space-x-3"><button type="button" id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button><button type="button" id="confirm-ok-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">í™•ì¸</button></div></div></div>
    
    <div id="memo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0">
        <div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-lg modal-content transform scale-95">
            <h2 class="text-2xl font-bold mb-6">ë§¤ë§¤ ë³µê¸° ë©”ëª¨</h2>
            <form id="memo-form">
                <input type="hidden" id="memo-journal-id">
                <div class="space-y-4">
                    <div>
                        <label for="journal-memo-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ë©”ëª¨ ë‚´ìš©</label>
                        <textarea id="journal-memo-content" rows="10" class="w-full p-3 border border-gray-300 dark:border-[#4F4F4F] rounded-lg bg-white dark:bg-[#2d2d2d] focus:ring-2 focus:ring-blue-500" placeholder="ì´ ë§¤ë§¤ì—ì„œ ëŠë‚€ ì , ê°ì • ìƒíƒœ, ì˜í•œ ì , ê°œì„ í•  ì  ë“±ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="close-memo-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ë©”ëª¨ ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"><p id="toast-message"></p></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDZm5AazCafB0Sb2gd0llv9e3GAhE-nKBw",
          authDomain: "sakurazima-mai-0u0.firebaseapp.com",
          projectId: "sakurazima-mai-0u0",
          storageBucket: "sakurazima-mai-0u0.appspot.com",
          messagingSenderId: "697666115735",
          appId: "1:697666115735:web:7380a588822f771dc071d2",
          measurementId: "G-TZQ9GVFWV5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const Timestamp = firebase.firestore.Timestamp;

        let currentUser = null;
        let charts = {};
        let confirmCallback = null;
        
        // Trading Journal State
        let unsubscribeJournals = null, unsubscribeTags = null;
        let localJournals = [], localTags = { entry: [], psychology: [] };
        let localFuturesInfo = {}; // { ticker: { tickValue: number, tickSize: number } } 
        let unsubscribeFuturesInfo = null;
        let statsCurrency = 'KRW', exchangeRate = 1380;
        
        // Household Ledger State (ìˆ˜ì •ë¨)
        let unsubscribeLedger = null, unsubscribeLedgerCategories = null;
        let localLedgerEntries = [];
        let localLedgerCategories = { expense: [], income: [] };
        let ledgerAnalysisDate = new Date(); // ledgerListDateì™€ ledgerStatsDate í†µí•©

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // ================== Authentication ==================
        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(error => showToast("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message, "error")));
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('auth-info').textContent = ${user.displayName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!;
                initializeAppFunctionality();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeJournals) unsubscribeJournals();
                if (unsubscribeTags) unsubscribeTags();
                if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
                if (unsubscribeLedger) unsubscribeLedger();
                if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
                Object.values(charts).forEach(chart => { if(chart) chart.destroy(); });
                charts = {};
            }
            lucide.createIcons();
        });

        async function initializeAppFunctionality() {
            if (!currentUser) return;
            const userId = currentUser.uid;

            await initializeJournalDefaults(userId);
            await initializeFuturesInfoDefaults(userId);
            attachJournalListeners(userId);
            resetForm();

            await initializeLedgerDefaults(userId);
            attachLedgerListeners(userId);
            resetLedgerForm();
        }

        // ================== Main Tab Switching Logic ==================
        document.querySelectorAll('.main-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.mainTab;
                document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('journal-container').classList.toggle('hidden', targetId !== 'journal-container');
                document.getElementById('ledger-container').classList.toggle('hidden', targetId !== 'ledger-container');
                
                if (targetId === 'ledger-container' && currentUser) {
                     renderLedgerAnalysisView(); // í†µí•© í•¨ìˆ˜ í˜¸ì¶œ
                } else if (targetId === 'journal-container' && currentUser) {
                    renderJournalStats(localJournals);
                }
            });
        });
        
        // =======================================================
        // ================== TRADING JOURNAL LOGIC ==============
        // =======================================================
        
        const journalForm = document.getElementById('journal-form');
        const journalList = document.getElementById('journal-list');

        async function initializeJournalDefaults(userId) {
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            const tagsDocSnap = await tagsDocRef.get();
            if (!tagsDocSnap.exists) {
                await tagsDocRef.set({
                    entry: ['ì •ë°°ì—´ ëŒíŒŒ', 'ë‚™ì£¼ ë§¤ë§¤'],
                    psychology: ['FOMO', 'í™•ì‹ ']
                });
            }
        }
        
        async function initializeFuturesInfoDefaults(userId) {
            const docRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            const docSnap = await docRef.get();
            if (!docSnap.exists) {
                // ì˜ˆì‹œ ë°ì´í„°
                await docRef.set({
                    'ES': { tickValue: 5.0, tickSize: 0.25, commissionBuy: 2.5, commissionSell: 2.5 },
                    'NG': { tickValue: 10.0, tickSize: 0.001, commissionBuy: 2.5, commissionSell: 2.5 },
                    'ZB': { tickValue: 31.25, tickSize: 0.03125, commissionBuy: 2.5, commissionSell: 2.5 }
                });
            }
        }

        function attachJournalListeners(userId) {
            if (unsubscribeJournals) unsubscribeJournals();
            const journalsQuery = db.collection("users").doc(userId).collection("journals").orderBy("date", "desc");
            unsubscribeJournals = journalsQuery.onSnapshot((snapshot) => {
                localJournals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                renderJournals(localJournals);
                renderJournalStats(localJournals);
            }, (error) => console.error("Error fetching journals:", error));

            if (unsubscribeTags) unsubscribeTags();
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            unsubscribeTags = tagsDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    localTags = doc.data();
                    renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
                    renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
                }
            }, (error) => console.error("Error fetching tags:", error));
            
            // ì„ ë¬¼ ì¢…ëª© ì •ë³´ ë¦¬ìŠ¤ë„ˆ
            if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
            const futuresDocRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            unsubscribeFuturesInfo = futuresDocRef.onSnapshot((doc) => {
                localFuturesInfo = doc.exists ? doc.data() : {};
                renderFuturesInfoSelect();
            }, (error) => console.error("Error fetching futures info:", error));
        }
        
        function switchJournalView(tabId) {
            document.querySelectorAll('#journal-container [data-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            ['form-view', 'list-view', 'stats-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== tabId));
            lucide.createIcons();
            if(tabId === 'stats-view' && currentUser) {
                renderJournalStats(localJournals);
            }
        }
        document.querySelectorAll('#journal-container [data-tab]').forEach(b => b.addEventListener('click', () => switchJournalView(b.dataset.tab)));
        
        // Asset type toggle
        document.querySelectorAll('[data-group="asset-type"] .toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const isSpot = btn.dataset.value === 'spot';
                document.getElementById('spot-fields').classList.toggle('hidden', !isSpot);
                document.getElementById('futures-fields').classList.toggle('hidden', isSpot);
                
                document.getElementById('quantity').required = isSpot;
                document.getElementById('contracts').required = !isSpot;
                document.getElementById('tick-value').required = !isSpot;
                document.getElementById('tick-size').required = !isSpot;
                
                if (isSpot) {
                     document.getElementById('futures-info-select').value = '';
                     document.getElementById('tick-value').value = '';
                     document.getElementById('tick-size').value = '';
                     document.getElementById('commission-buy').value = '';
                     document.getElementById('commission-sell').value = '';
                     document.getElementById('delete-futures-info-btn').disabled = true;
                } else {
                     const currentTicker = document.getElementById('ticker').value.trim().toUpperCase();
                     if (localFuturesInfo[currentTicker]) {
                        document.getElementById('futures-info-select').value = currentTicker;
                        document.getElementById('tick-value').value = formatNumber(localFuturesInfo[currentTicker].tickValue);
                        document.getElementById('tick-size').value = formatNumber(localFuturesInfo[currentTicker].tickSize);
                        document.getElementById('commission-buy').value = formatNumber(localFuturesInfo[currentTicker].commissionBuy || 0);
                        document.getElementById('commission-sell').value = formatNumber(localFuturesInfo[currentTicker].commissionSell || 0);
                        document.getElementById('delete-futures-info-btn').disabled = false;
                     } else {
                        document.getElementById('futures-info-select').value = '';
                        document.getElementById('delete-futures-info-btn').disabled = true;
                     }
                }
            });
        });
        
        // ì„ ë¬¼ ì •ë³´ Select ë°•ìŠ¤ ë Œë”ë§ ë° ë¦¬ìŠ¤ë„ˆ (ìˆ˜ì •ë¨)
        function renderFuturesInfoSelect() {
            const select = document.getElementById('futures-info-select');
            const tickerInput = document.getElementById('ticker');
            const deleteBtn = document.getElementById('delete-futures-info-btn');
            
            deleteBtn.disabled = true; 
            
            select.innerHTML = '<option value="">- ì¢…ëª© ì„ íƒ (í‹±ê°€ì¹˜/ë‹¨ìœ„ ë¶ˆëŸ¬ì˜¤ê¸°) -</option>';
            
            const currentTicker = tickerInput.value.trim().toUpperCase();

            Object.entries(localFuturesInfo).sort((a,b) => a[0].localeCompare(b[0])).forEach(([ticker, info]) => {
                const option = document.createElement('option');
                option.value = ticker;
                // ìˆ˜ìˆ˜ë£Œ í‘œì‹œ ì¶”ê°€
                option.textContent = ${ticker} (ê°€ì¹˜: ${formatNumber(info.tickValue)}, ë‹¨ìœ„: ${formatNumber(info.tickSize)}, ìˆ˜ìˆ˜ë£Œ: ${formatNumber(info.commissionBuy || 0)}/${formatNumber(info.commissionSell || 0)});
                select.appendChild(option);
                
                if (ticker === currentTicker && !document.getElementById('futures-fields').classList.contains('hidden')) {
                    select.value = ticker;
                    deleteBtn.disabled = false;
                }
            });
            
            // ì¢…ëª© ì„ íƒ ë³€ê²½ ì‹œ í•„ë“œ ì—…ë°ì´íŠ¸
            select.onchange = (e) => {
                const selectedTicker = e.target.value;
                const info = localFuturesInfo[selectedTicker];
                
                deleteBtn.disabled = !selectedTicker;

                if (info) {
                    tickerInput.value = selectedTicker;
                    document.getElementById('tick-value').value = formatNumber(info.tickValue);
                    document.getElementById('tick-size').value = formatNumber(info.tickSize);
                    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì±„ìš°ê¸°
                    document.getElementById('commission-buy').value = formatNumber(info.commissionBuy || 0);
                    document.getElementById('commission-sell').value = formatNumber(info.commissionSell || 0);
                    showToast(ì¢…ëª© '${selectedTicker}' ì •ë³´ê°€ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.);
                } else {
                    document.getElementById('tick-value').value = '';
                    document.getElementById('tick-size').value = '';
                    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ë¹„ìš°ê¸°
                    document.getElementById('commission-buy').value = '';
                    document.getElementById('commission-sell').value = '';
                }
            };
            
            // ì¢…ëª© ì…ë ¥ í•„ë“œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ select ì˜µì…˜ ë³€ê²½ ë° í•„ë“œ ìë™ ì±„ìš°ê¸°
            tickerInput.oninput = () => {
                const newTicker = tickerInput.value.trim().toUpperCase();
                const isFutures = !document.getElementById('futures-fields').classList.contains('hidden');
                
                deleteBtn.disabled = !localFuturesInfo[newTicker];

                if (isFutures && localFuturesInfo[newTicker]) {
                    select.value = newTicker;
                    document.getElementById('tick-value').value = formatNumber(localFuturesInfo[newTicker].tickValue);
                    document.getElementById('tick-size').value = formatNumber(localFuturesInfo[newTicker].tickSize);
                    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì±„ìš°ê¸°
                    document.getElementById('commission-buy').value = formatNumber(localFuturesInfo[newTicker].commissionBuy || 0);
                    document.getElementById('commission-sell').value = formatNumber(localFuturesInfo[newTicker].commissionSell || 0);
                } else if (isFutures) {
                     select.value = '';
                }
            }
        }
        
        // ì„ ë¬¼ ì •ë³´ ì €ì¥ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (ìˆ˜ì •ë¨)
        document.getElementById('save-futures-info-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const tickValueInput = document.getElementById('tick-value');
            const tickSizeInput = document.getElementById('tick-size');
            
            const tickValue = parseFloat(unformatNumber(tickValueInput.value));
            const tickSize = parseFloat(unformatNumber(tickSizeInput.value));
            // ìˆ˜ìˆ˜ë£Œ ê°’ ì½ê¸°
            const commissionBuy = parseFloat(unformatNumber(document.getElementById('commission-buy').value)) || 0;
            const commissionSell = parseFloat(unformatNumber(document.getElementById('commission-sell').value)) || 0;

            if (!ticker || isNaN(tickValue) || tickValue <= 0 || isNaN(tickSize) || tickSize <= 0) {
                showToast("ì¢…ëª© ì´ë¦„, í‹±ê°€ì¹˜, í‹±ë‹¨ìœ„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                return;
            }

            const currentInfo = localFuturesInfo[ticker];
            const isUpdating = currentInfo;
            const message = isUpdating ? '${ticker}' ì¢…ëª© ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? : '${ticker}' ì¢…ëª© ì •ë³´ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?;
            const action = isUpdating ? 'ì—…ë°ì´íŠ¸' : 'ì €ì¥';

            showConfirmModal(message, async () => {
                try {
                    const updatedInfo = {
                        ...localFuturesInfo,
                        // ìˆ˜ìˆ˜ë£Œ ì •ë³´ ì¶”ê°€
                        [ticker]: { tickValue, tickSize, commissionBuy, commissionSell }
                    };
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    
                    showToast(ì„ ë¬¼ ì¢…ëª© ì •ë³´ê°€ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤.);
                    tickValueInput.value = formatNumber(tickValue);
                    tickSizeInput.value = formatNumber(tickSize);
                    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
                    document.getElementById('commission-buy').value = formatNumber(commissionBuy);
                    document.getElementById('commission-sell').value = formatNumber(commissionSell);
                    document.getElementById('futures-info-select').value = ticker; 
                    document.getElementById('delete-futures-info-btn').disabled = false;
                } catch(e) {
                    showToast(ì •ë³´ ${action} ì‹¤íŒ¨: ${e.message}, "error");
                }
            }, action);
        });
        
        // ì„ ë¬¼ ì¢…ëª© ì •ë³´ ì‚­ì œ ë¦¬ìŠ¤ë„ˆ (ìˆ˜ì •ë¨)
        async function handleDeleteFuturesInfo() {
            const ticker = document.getElementById('futures-info-select').value;

            if (!ticker) {
                showToast("ì‚­ì œí•  ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
                return;
            }

            const isUsedInJournal = localJournals.some(journal => 
                journal.assetType === 'futures' && 
                journal.ticker.toUpperCase() === ticker.toUpperCase()
            );

            if (isUsedInJournal) {
                showToast('${ticker}' ì¢…ëª©ì€ í˜„ì¬ ë§¤ë§¤ì¼ì§€(${localJournals.filter(j => j.assetType === 'futures' && j.ticker.toUpperCase() === ticker.toUpperCase()).length}ê°œ)ì— ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤., "error");
                return;
            }

            showConfirmModal(ì„ ë¬¼ ì¢…ëª© '${ticker}'ì˜ ì €ì¥ëœ í‹±ê°€ì¹˜/í‹±ë‹¨ìœ„ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?, async () => {
                try {
                    const updatedInfo = { ...localFuturesInfo };
                    delete updatedInfo[ticker];
                    
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    
                    showToast(ì„ ë¬¼ ì¢…ëª© '${ticker}' ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.);
                    document.getElementById('futures-info-select').value = '';
                    document.getElementById('delete-futures-info-btn').disabled = true;
                    document.getElementById('tick-value').value = '';
                    document.getElementById('tick-size').value = '';
                    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ë¹„ìš°ê¸°
                    document.getElementById('commission-buy').value = '';
                    document.getElementById('commission-sell').value = '';
                } catch(e) {
                    showToast(ì‚­ì œ ì‹¤íŒ¨: ${e.message}, "error");
                }
            }, 'ì‚­ì œ');
        }

        // PnL ê³„ì‚° (ìˆ˜ì •ë¨ - ìˆ˜ìˆ˜ë£Œ ë°˜ì˜)
        function calculatePnl(journal, exit) {
            const priceDiff = journal.position === 'long' ? (exit.price - journal.entryPrice) : (journal.entryPrice - exit.price);
            if (journal.assetType === 'futures') {
                if (!journal.tickSize || !journal.tickValue) return 0;
                
                // Gross PnL
                const grossPnl = (priceDiff / journal.tickSize) * journal.tickValue * exit.quantity;
                
                // Apply commissions (per contract * exit quantity)
                const commissionBuy = (journal.commissionBuy || 0) * exit.quantity;
                const commissionSell = (journal.commissionSell || 0) * exit.quantity;
                
                // Net PnL = Gross PnL - (Buy Commission + Sell Commission)
                return grossPnl - commissionBuy - commissionSell;

            } else { // spot
                // ì°¸ê³ : í˜„ë¬¼ ìˆ˜ìˆ˜ë£ŒëŠ” ìš”ì²­ì‚¬í•­ì— ì—†ì–´ ë¯¸ë°˜ì˜
                return priceDiff * exit.quantity;
            }
        }
        
        // Bond Price ë³€í™˜ í•¨ìˆ˜ (ìˆ˜ì •ë¨): 120'16'5 (8ths of 32nd) í˜•ì‹ ì§€ì›
        const bondPriceToDecimal = (bondPrice) => {
            const price = bondPrice.toString().replace(/,/g, '');
            if (!price) return null;
            
            const parts = price.split("'");
            
            if (parts.length === 1) { // No ' (e.g., 10000)
                return parseFloat(parts[0]);
            } 
            
            const whole = parseFloat(parts[0]);
            if (isNaN(whole)) return null;

            if (parts.length === 2) { // 32nds (e.g., 120'16)
                const fraction_32nds = parseFloat(parts[1]);
                if (isNaN(fraction_32nds)) return null;
                // 32nds ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
                return whole + (fraction_32nds / 32.0);
            } 
            
            if (parts.length === 3) { // 32nds + 8ths of 32nd (e.g., 120'16'5)
                const fraction_32nds = parseFloat(parts[1]);
                const fraction_8ths = parseFloat(parts[2]);
                
                if (isNaN(fraction_32nds) || isNaN(fraction_8ths)) return null;
                
                // 120'16'5 = 120 + 16/32 + 5/256
                return whole + (fraction_32nds / 32.0) + (fraction_8ths / 256.0);
            }
            
            // 'ê°€ 3ê°œ ì´ìƒì´ë©´ íŒŒì‹± ì‹¤íŒ¨
            if (parts.length > 3) return null;

            return parseFloat(price); // Fallback
        }

        // ì†Œìˆ˜ì  ê°€ê²©ì„ ì±„ê¶Œ ê°€ê²© (X'Y'Z)ìœ¼ë¡œ ë³€í™˜ (ìˆ˜ì •ë¨)
        const decimalToBondPrice = (decimalPrice) => {
            if (isNaN(decimalPrice) || decimalPrice === null) return '';
            const whole = Math.floor(decimalPrice);
            const remainder = decimalPrice - whole;

            // 1/256 ë‹¨ìœ„ë¡œ ê³„ì‚°
            const total_256ths = Math.round(remainder * 256);
            
            if (total_256ths === 0) {
                return ${whole}'00; // 120.0 -> 120'00
            }
            
            // 1/32 = 8/256
            const fraction_32nds = Math.floor(total_256ths / 8);
            const fraction_8ths = total_256ths % 8;

            if (fraction_8ths === 0) {
                // 32ndsë¡œ ë”± ë–¨ì–´ì§ (ì˜ˆ: 120.5 -> 120'16)
                return ${whole}'${String(fraction_32nds).padStart(2, '0')};
            } else {
                // 8ths of 32nd (ì˜ˆ: 120.51953125 -> 120'16'5)
                return ${whole}'${String(fraction_32nds).padStart(2, '0')}'${fraction_8ths};
            }
        }

        function renderJournals(journals) {
            journalList.innerHTML = '';

            if (journals.length === 0) { [cite: 243]
                journalList.innerHTML = <div class="bg-white col-span-full text-center text-gray-500 p-10 rounded-2xl shadow-md"><i data-lucide="folder-x" class="mx-auto w-16 h-16 text-gray-400 mb-4"></i><p class="text-xl">ì‘ì„±ëœ ë§¤ë§¤ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>;
                lucide.createIcons(); return; [cite: 244]
            }

            journals.forEach(journal => {
                const isSpot = journal.assetType === 'spot';
                const totalAmount = isSpot ? journal.quantity : journal.contracts;
                const exitedAmount = journal.exits ? journal.exits.reduce((sum, exit) => sum + exit.quantity, 0) : 0;
                const isClosed = (totalAmount - exitedAmount) <= 1e-9; [cite: 245]
                
                let totalPnl = 0;
                if (journal.exits && journal.exits.length > 0) {
                     totalPnl = journal.exits.reduce((sum, exit) => sum + calculatePnl(journal, exit), 0);
                } [cite: 246]
                const totalPnlInKRW = journal.currency === 'USD' ? totalPnl * exchangeRate : totalPnl; // ì˜¤íƒ€ ìˆ˜ì •: pnl -> totalPnl
                const pnlClass = totalPnlInKRW > 0 ? 'text-green-500' : totalPnlInKRW < 0 ? 'text-red-500' : 'text-gray-500';
                
                const borderColor = isClosed ? (totalPnlInKRW > 0 ? 'border-green-500' : 'border-red-500') : 'border-yellow-500'; [cite: 247]
                const card = document.createElement('div'); [cite: 248]
                card.className = bg-white p-5 rounded-xl shadow-md border-l-4 ${borderColor};
                
                // ========== [UI ê°œì„  1] 'ë³´ìœ  ê¸°ê°„' Key-Value ìŠ¤íƒ€ì¼ ì ìš© ========== [cite: 249]
                let holdingPeriodHtml = '';
                if (isClosed && journal.exits.length > 0) { [cite: 250]
                    const lastExitDate = new Date(Math.max(...journal.exits.map(e => (e.date.toDate ? e.date.toDate() : new Date(e.date)).getTime())));
                    const entryDate = journal.date; [cite: 251]
                    const diffTime = Math.abs(lastExitDate - entryDate);
                    const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24))); [cite: 252]
                    // Key-Value ìŠ¤íƒ€ì¼ì„ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì ìš©í•©ë‹ˆë‹¤.
                    holdingPeriodHtml = <p class="text-sm">
                                            <strong class="text-gray-500 dark:text-gray-400 font-medium">ë³´ìœ  ê¸°ê°„:</strong>
                                            <span class="text-gray-800 dark:text-gray-200 font-semibold">${diffDays}ì¼</span>
                                         </p>; [cite: 253, 254]
                } [cite: 255]
                
                // â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜…
                // 2ë…„, 5ë…„ë¬¼ í‹±ë‹¨ìœ„(0.0078125) ì¶”ê°€
                const isBond = journal.assetType === 'futures' && (
                    Math.abs(journal.tickSize - 0.03125) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.00390625) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.015625) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.0078125) < 1e-9
                );
                
                const formatPriceDisplayForJournal = (price) => isBond ? decimalToBondPrice(price) : formatPrice(price, journal.currency); [cite: 256]
                
                const exitsHtml = journal.exits && journal.exits.length > 0 ? 
                    <div class="mt-3 pt-3 border-t border-gray-200 space-y-1 text-xs">
                        <h5 class="font-semibold mb-1">ì²­ì‚° ë‚´ì—­</h5>
                        ${journal.exits.map(exit => {
                            const exitPnl = calculatePnl(journal, exit); [cite: 258]
                            const exitPnlClass = exitPnl > 0 ? 'text-green-500' : exitPnl < 0 ? 'text-red-500' : 'text-gray-500';
                            const exitDate = exit.date.toDate ? exit.date.toDate() : new Date(exit.date);
                            const amountLabel = isSpot ? 'ì£¼' : 'ê³„ì•½'; [cite: 259]
                            return <div class="flex justify-between items-center p-1 rounded bg-gray-50 dark:bg-[#2d2d2d]"><span>${exitDate.toLocaleDateString()} @ ${formatPriceDisplayForJournal(exit.price)} (${formatNumber(exit.quantity)} ${amountLabel})</span><span class="${exitPnlClass} font-medium">${formatPrice(exitPnl, journal.currency)}</span></div>
                        }).join('')}
                    </div> : ''; [cite: 257, 260]
                
                const amountLabel = isSpot ? 'ìˆ˜ëŸ‰' : 'ê³„ì•½'; [cite: 261]
                
                // ========== [UI ê°œì„  2] ì¹´ë“œ HTML êµ¬ì¡° ì „ì²´ ë³€ê²½ ==========
                card.innerHTML = 
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-lg">${journal.date.toLocaleDateString()}</p> [cite: 262]
                            <p class="font-semibold text-md text-gray-800">${journal.ticker} <span class="text-xs font-medium text-gray-400 align-top">${isSpot ? 'í˜„ë¬¼' : 'ì„ ë¬¼'}</span></p> [cite: 263]
                            <span class="text-sm font-bold ${journal.position === 'long' ? 'text-green-500' : 'text-red-500'}">${journal.position === 'long' ? 'ğŸŸ¢ ë¡±' : 'ğŸ”´ ìˆ'}</span> [cite: 264]
                            <span class="text-sm text-gray-500 ml-2">${journal.strategy}</span>
                        </div>
                        <div class="flex space-x-2">
                            ${!isClosed ? <button class="p-2 hover:bg-gray-100 dark:hover:bg-[#2d2d2d] rounded-full exit-btn" data-id="${journal.id}" title="ì²­ì‚°"><i data-lucide="log-out" class="w-5 h-5 text-blue-500"></i></button> : ''} [cite: 265, 266]
                            <button class="p-2 hover:bg-gray-100 dark:hover:bg-[#2d2d2d] rounded-full memo-btn" data-id="${journal.id}" title="ë©”ëª¨"><i data-lucide="sticky-note" class="w-5 h-5 text-purple-500"></i></button>
                            <button class="p-2 hover:bg-gray-100 dark:hover:bg-[#2d2d2d] rounded-full edit-btn" data-id="${journal.id}" title="ìˆ˜ì •"><i data-lucide="edit" class="w-5 h-5 text-gray-500"></i></button>
                            <button class="p-2 hover:bg-gray-100 dark:hover:bg-[#2d2d2d] rounded-full delete-btn" data-id="${journal.id}" title="ì‚­ì œ"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button> [cite: 267]
                        </div>
                    </div>

                    <div class="space-y-2 text-sm mb-3">
                        <p>
                            <strong class="text-gray-500 dark:text-gray-400 font-medium w-14 inline-block">ì§„ì…:</strong>
                            <span class="text-gray-900 dark:text-gray-100 font-semibold">${formatPriceDisplayForJournal(journal.entryPrice)}</span> [cite: 268]
                            <strong class="text-gray-500 dark:text-gray-400 font-medium ml-3 sm:ml-4">${amountLabel}:</strong>
                            <span class="text-gray-900 dark:text-gray-100 font-semibold">${formatNumber(totalAmount)}</span>
                        </p> [cite: 269]
                        <p>
                            <strong class="text-gray-500 dark:text-gray-400 font-medium w-14 inline-block">ëª©í‘œ:</strong>
                            <span class="text-gray-900 dark:text-gray-100 font-semibold">${formatPriceDisplayForJournal(journal.targetPrice)}</span>
                        </p> [cite: 270]
                        <p>
                            <strong class="text-gray-500 dark:text-gray-400 font-medium w-14 inline-block">ì†ì ˆ:</strong>
                            <span class="text-gray-900 dark:text-gray-100 font-semibold">${formatPriceDisplayForJournal(journal.stopLoss)}</span>
                        </p> [cite: 271]
                        
                        [cite: 272]
                        ${ !isSpot ? <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 pt-2 border-t border-dashed border-gray-200 dark:border-gray-700 space-y-1">
                                        <p><strong>í‹±ê°€ì¹˜/ë‹¨ìœ„:</strong> ${formatPrice(journal.tickValue, journal.currency)} / ${formatNumber(journal.tickSize)}</p>
                                        <p><strong>ìˆ˜ìˆ˜ë£Œ(ë§¤ìˆ˜/ë§¤ë„):</strong> ${formatPrice(journal.commissionBuy || 0, journal.currency)} / ${formatPrice(journal.commissionSell || 0, journal.currency)}</p>
                                     </div> : '' } [cite: 273, 274]
                        
                        ${holdingPeriodHtml} [cite: 275]
                        
                        ${journal.exits && journal.exits.length > 0 ? 
                            <p class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                <strong class="text-gray-500 dark:text-gray-400 font-medium">ì´ ì‹¤í˜„ ì†ìµ:</strong> [cite: 276]
                                <span class="font-bold text-lg ml-2 ${pnlClass}">${formatDualCurrency(totalPnlInKRW, journal.currency)}</span>
                            </p> : ''} [cite: 277]
                    </div>

                    <hr class="my-3 border-gray-200 dark:border-gray-700">
                    
                    <div><h4 class="font-semibold text-xs text-gray-500 mb-1">ì§„ì… ê·¼ê±°</h4><div class="flex flex-wrap gap-1">${(journal.entryTags || []).map(tag => <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${tag}</span>).join('')}</div></div> [cite: 278]
                    <div class="mt-2"><h4 class="font-semibold text-xs text-gray-500 mb-1">ì‹¬ë¦¬ ìƒíƒœ</h4><div class="flex flex-wrap gap-1">${(journal.psychologyTags || []).map(tag => <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${tag}</span>).join('')}</div></div>
                    ${exitsHtml};
                // ========== [UI ê°œì„  2] ì¢…ë£Œ ========== [cite: 279]
                
                journalList.appendChild(card);
            }); [cite: 280]
            lucide.createIcons();
            addJournalListEventListeners();

        async function getJournalById(id) {
            const docRef = db.collection("users").doc(currentUser.uid).collection("journals").doc(id);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                return { id: docSnap.id, ...data, date: data.date.toDate() };
            }
            return null;
        }

        function addJournalListEventListeners() {
            document.querySelectorAll('#journal-list .delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteJournal));
            document.querySelectorAll('#journal-list .edit-btn').forEach(btn => btn.addEventListener('click', handleEditJournal));
            document.querySelectorAll('#journal-list .exit-btn').forEach(btn => btn.addEventListener('click', handleOpenExitModal));
            document.querySelectorAll('#journal-list .memo-btn').forEach(btn => btn.addEventListener('click', handleOpenMemoModal)); // ì‹ ê·œ ë¦¬ìŠ¤ë„ˆ
        }
        
        function renderJournalTags(tags, containerId, type) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if(!tags) return;
            tags.forEach(tag => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag bg-gray-200 text-gray-700 rounded-full text-sm inline-flex items-center';
                button.dataset.tag = tag;
                
                button.innerHTML = <span class="pl-3 pr-2 py-1">${tag}</span><span class="delete-tag-span pr-2 text-gray-500 hover:text-red-500"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></span>;

                button.addEventListener('click', (e) => e.currentTarget.classList.toggle('selected'));
                button.querySelector('.delete-tag-span').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteJournalTag(tag, type);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
        }

        async function handleDeleteJournalTag(tag, type) {
            const isTagInUse = localJournals.some(journal => (type === 'entry' ? journal.entryTags : journal.psychologyTags)?.includes(tag));
            if (isTagInUse) {
                showToast("ì‚¬ìš© ì¤‘ì¸ íƒœê·¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }
            showConfirmModal('${tag}' íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?, async () => {
                const newTags = localTags[type].filter(t => t !== tag);
                try {
                    await db.collection("users").doc(currentUser.uid).collection("journalTags").doc("all").update({ [type]: newTags });
                    showToast('${tag}' íƒœê·¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.);
                } catch(e) { showToast("íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨.", "error"); }
            }, 'ì‚­ì œ');
        }
        
        async function addJournalTag(type, tag) {
            const tagsDocRef = db.collection("users").doc(currentUser.uid).collection("journalTags").doc("all");
            const currentTags = localTags[type] || [];
            if (!currentTags.includes(tag)) {
                await tagsDocRef.update({ [type]: [...currentTags, tag] });
                showToast('${tag}' íƒœê·¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.);
            } else { showToast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì…ë‹ˆë‹¤.", "error"); }
        }
        document.querySelector('.add-entry-tag-btn').addEventListener('click', () => {
            const input = document.getElementById('new-entry-tag');
            if (input.value.trim()) { addJournalTag('entry', input.value.trim()); input.value = ''; }
        });
        document.querySelector('.add-psychology-tag-btn').addEventListener('click', () => {
            const input = document.getElementById('new-psychology-tag');
            if (input.value.trim()) { addJournalTag('psychology', input.value.trim()); input.value = ''; }
        });

        journalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const journalId = document.getElementById('journal-id').value;
            const assetType = document.querySelector('[data-group="asset-type"] .toggle-btn.selected').dataset.value;
            
            const getPriceValue = (id) => {
                const value = document.getElementById(id).value;
                if (value.includes("'")) return bondPriceToDecimal(value);
                return parseFloat(unformatNumber(value));
            };
            
            const entryPrice = getPriceValue('entry-price');
            const targetPrice = getPriceValue('target-price');
            const stopLoss = getPriceValue('stop-loss');
            
            if (isNaN(entryPrice) || isNaN(targetPrice) || isNaN(stopLoss) || entryPrice === null || targetPrice === null || stopLoss === null) {
                showToast("ì§„ì…ê°€, ëª©í‘œê°€, ì†ì ˆê°€ë¥¼ ì˜¬ë°”ë¥¸ í˜•ì‹(ì˜ˆ: 10,000 ë˜ëŠ” 120'16)ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                return;
            }
            
            const journalData = {
                assetType: assetType,
                ticker: document.getElementById('ticker').value.toUpperCase(),
                date: Timestamp.fromDate(new Date(document.getElementById('date').value)),
                position: document.querySelector('[data-group="position"] .toggle-btn.selected').dataset.value,
                strategy: document.querySelector('[data-group="strategy"] .toggle-btn.selected').dataset.value, 
                currency: document.querySelector('[data-group="form-currency"] .toggle-btn.selected').id.includes('usd') ? 'USD' : 'KRW',
                entryPrice: entryPrice,
                stopLoss: stopLoss, 
                targetPrice: targetPrice,
                entryTags: Array.from(document.querySelectorAll('.entry-tags-container .tag.selected')).map(b => b.dataset.tag),
                psychologyTags: Array.from(document.querySelectorAll('.psychology-tags-container .tag.selected')).map(b => b.dataset.tag),
            };

            if (assetType === 'spot') {
                journalData.quantity = parseFloat(unformatNumber(document.getElementById('quantity').value));
            } else { // futures (ìˆ˜ì •ë¨)
                journalData.contracts = parseFloat(unformatNumber(document.getElementById('contracts').value));
                journalData.tickValue = parseFloat(unformatNumber(document.getElementById('tick-value').value));
                journalData.tickSize = parseFloat(unformatNumber(document.getElementById('tick-size').value));
                // ìˆ˜ìˆ˜ë£Œ ì •ë³´ ì €ì¥
                journalData.commissionBuy = parseFloat(unformatNumber(document.getElementById('commission-buy').value)) || 0;
                journalData.commissionSell = parseFloat(unformatNumber(document.getElementById('commission-sell').value)) || 0;
            }
            
            try {
                if (journalId) {
                    await db.collection("users").doc(currentUser.uid).collection("journals").doc(journalId).update(journalData);
                    showToast("ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    journalData.exits = [];
                    journalData.memo = ''; // ë©”ëª¨ í•„ë“œ ì´ˆê¸°í™”
                    await db.collection("users").doc(currentUser.uid).collection("journals").add(journalData);
                    showToast("ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                resetForm();
                switchJournalView('list-view');
            } catch (error) { showToast("ì €ì¥ ì‹¤íŒ¨: " + error.message, "error"); }
        });
        
        async function handleDeleteJournal(e) {
            const id = e.currentTarget.dataset.id;
            showConfirmModal("ì •ë§ë¡œ ì´ ì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
                await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).delete();
                showToast("ì¼ì§€ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
            }, 'ì‚­ì œ');
        }

        async function handleEditJournal(e) {
            const journal = await getJournalById(e.currentTarget.dataset.id);
            if (journal) { [cite: 315]
                document.getElementById('journal-id').value = journal.id;
                document.getElementById('date').value = journal.date.toISOString().split('T')[0]; [cite: 316]
                document.getElementById('ticker').value = journal.ticker;
                
                document.querySelector([data-group="asset-type"] .toggle-btn[data-value="${journal.assetType}"]).click();

                ['position', 'strategy'].forEach(group => document.querySelectorAll([data-group="${group}"] .toggle-btn).forEach(b => b.classList.toggle('selected', b.dataset.value === journal[group])));
                document.querySelectorAll('[data-group="form-currency"] .toggle-btn').forEach(b => b.classList.toggle('selected', (journal.currency === 'USD' && b.id.includes('usd')) || (journal.currency !== 'USD' && b.id.includes('krw')))); [cite: 317]
                
                // â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜…
                // 2ë…„, 5ë…„ë¬¼ í‹±ë‹¨ìœ„(0.0078125) ì¶”ê°€
                const isBond = journal.assetType === 'futures' && (
                    Math.abs(journal.tickSize - 0.03125) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.00390625) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.015625) < 1e-9 || 
                    Math.abs(journal.tickSize - 0.0078125) < 1e-9
                );
                
                document.getElementById('entry-price').value = formatPriceDisplay(journal.entryPrice, isBond);
                document.getElementById('target-price').value = formatPriceDisplay(journal.targetPrice, isBond); [cite: 319]
                document.getElementById('stop-loss').value = formatPriceDisplay(journal.stopLoss, isBond);

                if (journal.assetType === 'spot') {
                    document.getElementById('quantity').value = formatNumber(journal.quantity);
                } else { // futures (ìˆ˜ì •ë¨) [cite: 320]
                    document.getElementById('contracts').value = formatNumber(journal.contracts);
                    document.getElementById('tick-value').value = formatNumber(journal.tickValue); [cite: 321]
                    document.getElementById('tick-size').value = formatNumber(journal.tickSize);
                    // ìˆ˜ìˆ˜ë£Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
                    document.getElementById('commission-buy').value = formatNumber(journal.commissionBuy || 0);
                    document.getElementById('commission-sell').value = formatNumber(journal.commissionSell || 0); [cite: 322]
                    
                    const selectEl = document.getElementById('futures-info-select');
                    const ticker = journal.ticker.toUpperCase();
                    if(localFuturesInfo[ticker]) { [cite: 323]
                        selectEl.value = ticker;
                        document.getElementById('delete-futures-info-btn').disabled = false; [cite: 324]
                    } else {
                        selectEl.value = '';
                        document.getElementById('delete-futures-info-btn').disabled = true; [cite: 325]
                    }
                }

                ['entryTags', 'psychologyTags'].forEach(type => {
                    const containerClass = .${type.replace('Tags', '-tags-container')};
                    document.querySelectorAll(${containerClass} .tag).forEach(b => b.classList.remove('selected'));
                    (journal[type] || []).forEach(tag => document.querySelector(${containerClass} .tag[data-tag="${tag}"])?.classList.add('selected')); [cite: 326]
                });

                switchJournalView('form-view'); window.scrollTo(0, 0); [cite: 327]
            }
        }

        async function handleOpenExitModal(e) {
            const journal = await getJournalById(e.currentTarget.dataset.id);
            if(journal){
                const isSpot = journal.assetType === 'spot';
                const totalAmount = isSpot ? journal.quantity : journal.contracts;
                const exitedAmount = journal.exits ? journal.exits.reduce((s, ex) => s + ex.quantity, 0) : 0;
                const remaining = totalAmount - exitedAmount;
                
                document.getElementById('exit-journal-id').value = journal.id;
                document.getElementById('exit-quantity-label').textContent = isSpot ? 'ì²­ì‚° ìˆ˜ëŸ‰' : 'ì²­ì‚° ê³„ì•½ ìˆ˜';
                document.getElementById('remaining-quantity').textContent = formatNumber(remaining);
                document.getElementById('exit-quantity').dataset.max = remaining;
                document.getElementById('exit-quantity').value = formatNumber(remaining);
                document.getElementById('exit-date').value = new Date().toISOString().split('T')[0];
                openModal('exit-modal');
            }
        }
        
        // ì‹ ê·œ: ë©”ëª¨ ëª¨ë‹¬ ì—´ê¸°
        async function handleOpenMemoModal(e) {
            const journalId = e.currentTarget.dataset.id;
            const journal = await getJournalById(journalId);
            if (journal) {
                document.getElementById('memo-journal-id').value = journal.id;
                document.getElementById('journal-memo-content').value = journal.memo || ''; // ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
                openModal('memo-modal');
            }
        }

        // ì‹ ê·œ: ë©”ëª¨ ì €ì¥ í¼ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('memo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const journalId = document.getElementById('memo-journal-id').value;
            const memoContent = document.getElementById('journal-memo-content').value;

            if (!journalId) return;

            try {
                await db.collection("users").doc(currentUser.uid).collection("journals").doc(journalId).update({
                    memo: memoContent
                });
                showToast("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeModal('memo-modal');
            } catch (error) {
                showToast("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨: " + error.message, "error");
            }
        });

        // ì‹ ê·œ: ë©”ëª¨ ëª¨ë‹¬ ë‹«ê¸° ë¦¬ìŠ¤ë„ˆ
        document.getElementById('close-memo-modal-btn').addEventListener('click', () => closeModal('memo-modal'));
        document.getElementById('memo-modal').addEventListener('click', e => { if (e.target.id === 'memo-modal') closeModal('memo-modal'); });

        document.getElementById('exit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const journalId = document.getElementById('exit-journal-id').value;
            const journal = await getJournalById(journalId);
            const exitPriceValue = document.getElementById('exit-price').value;
            const price = exitPriceValue.includes("'") ? bondPriceToDecimal(exitPriceValue) : parseFloat(unformatNumber(exitPriceValue));
            const quantity = parseFloat(unformatNumber(document.getElementById('exit-quantity').value));
            const date = Timestamp.fromDate(new Date(document.getElementById('exit-date').value));
            const maxQuantity = parseFloat(document.getElementById('exit-quantity').dataset.max);

            if (isNaN(quantity) || quantity <= 0 || quantity > maxQuantity + 1e-9) {
                showToast(ì²­ì‚° ìˆ˜ëŸ‰/ê³„ì•½ ìˆ˜ëŠ” 0ë³´ë‹¤ í¬ê³  ${formatNumber(maxQuantity)} ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤., "error"); return;
            }
            
            const exitData = { price, quantity, date };
            const updatedExits = [...(journal.exits || []), exitData];
            await db.collection("users").doc(currentUser.uid).collection("journals").doc(journalId).update({ exits: updatedExits });
            showToast("ì²­ì‚° ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('exit-modal');
        });
        
        function renderJournalStats(journals) {
            const completed = journals.filter(j => {
                const isSpot = j.assetType === 'spot';
                const totalAmount = isSpot ? j.quantity : j.contracts;
                const exitedAmount = j.exits ? j.exits.reduce((s, e) => s + e.quantity, 0) : 0;
                return j.exits && j.exits.length > 0 && (totalAmount - exitedAmount <= 1e-9);
            });
            renderOverallStats(completed);
            renderPnlCompositionChart(completed);
            renderPnlTrendCharts(completed);
            renderWinRateCharts(completed);
        }

        function renderOverallStats(journals) {
            const winRateEl = document.getElementById('total-win-rate');
            const plRatioEl = document.getElementById('average-pl-ratio');
            if (journals.length === 0) { winRateEl.textContent = 'N/A'; plRatioEl.textContent = 'N/A'; return; }

            let winningTrades = 0;
            const plRatios = [];
            journals.forEach(j => {
                const totalPnl = j.exits.reduce((sum, exit) => sum + calculatePnl(j, exit), 0);
                if (totalPnl > 0) winningTrades++;

                j.exits.forEach(exit => {
                    const pnl = calculatePnl(j, { ...exit, quantity: 1 }); // PnL per one unit/contract
                    if (pnl > 0) {
                        const risk = Math.abs(calculatePnl(j, { price: j.stopLoss, quantity: 1}));
                        if (risk > 0) plRatios.push(pnl / risk);
                    } else if (pnl < 0) {
                        const loss = Math.abs(pnl);
                        const reward = Math.abs(calculatePnl(j, { price: j.targetPrice, quantity: 1 }));
                        if (loss > 0) plRatios.push(reward / loss);
                    }
                });
            });
            const winRate = (winningTrades / journals.length) * 100;
            winRateEl.textContent = ${winRate.toFixed(2)}%;
            winRateEl.className = text-4xl font-bold ${winRate >= 50 ? 'text-blue-500' : 'text-red-500'};

             if (journals.length > 0) {
                const Ratios = journals.map(j => {
                    const potentialReward = Math.abs(j.position === 'long' ? (j.targetPrice - j.entryPrice) : (j.entryPrice - j.targetPrice));
                    const potentialRisk = Math.abs(j.position === 'long' ? (j.entryPrice - j.stopLoss) : (j.stopLoss - j.entryPrice));
                    return potentialRisk > 0 ? (potentialReward / potentialRisk) : 0;
                }).filter(r => r > 0);
                
                if (Ratios.length > 0) {
                    const averagePlRatio = Ratios.reduce((sum, r) => sum + r, 0) / Ratios.length;
                    plRatioEl.textContent = ${averagePlRatio.toFixed(2)} : 1;
                    plRatioEl.className = text-4xl font-bold ${averagePlRatio >= 1 ? 'text-green-500' : 'text-yellow-500'};
                } else {
                    plRatioEl.textContent = 'N/A';
                }

            } else { plRatioEl.textContent = 'N/A'; }
        }

        function renderPnlCompositionChart(journals) {
            let totalProfit = 0; let totalLoss = 0;
            journals.forEach(j => {
                const pnl = j.exits.reduce((s, e) => s + calculatePnl(j, e), 0);
                const pnlInKRW = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                if(pnlInKRW > 0) totalProfit += pnlInKRW;
                else totalLoss += Math.abs(pnlInKRW);
            });
            createJournalChart('pnl-composition-chart', 'doughnut', ['ì´ ìˆ˜ìµ', 'ì´ ì†ì‹¤'], [totalProfit, totalLoss], 'ì†ìµ êµ¬ì„±');
        }

        function renderPnlTrendCharts(journals) {
            const monthlyPnl = {}; const quarterlyPnl = {};
            journals.forEach(j => {
                const date = j.date;
                const month = ${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')};
                const quarter = ${date.getFullYear()}-Q${Math.floor(date.getMonth() / 3) + 1};
                const pnl = j.exits.reduce((s, e) => s + calculatePnl(j,e), 0);
                const pnlInKRW = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                monthlyPnl[month] = (monthlyPnl[month] || 0) + pnlInKRW;
                quarterlyPnl[quarter] = (quarterlyPnl[quarter] || 0) + pnlInKRW;
            });
            
            const sortedMonthlyKeys = Object.keys(monthlyPnl).sort();
            const sortedMonthlyValues = sortedMonthlyKeys.map(key => monthlyPnl[key]);
            createJournalChart('monthly-pnl-chart', 'bar', sortedMonthlyKeys, sortedMonthlyValues, 'ì›”ë³„ ì†ìµ');
            renderJournalSummary('monthly-pnl-summary', sortedMonthlyKeys, sortedMonthlyValues);

            const sortedQuarterlyKeys = Object.keys(quarterlyPnl).sort();
            const sortedQuarterlyValues = sortedQuarterlyKeys.map(key => quarterlyPnl[key]);
            createJournalChart('quarterly-pnl-chart', 'bar', sortedQuarterlyKeys, sortedQuarterlyValues, 'ë¶„ê¸°ë³„ ì†ìµ');
            renderJournalSummary('quarterly-pnl-summary', sortedQuarterlyKeys, sortedQuarterlyValues);
        }
        
        function renderJournalSummary(elementId, labels, data) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            if (labels.length === 0) return;
            const summaryHtml = labels.map((label, index) => {
                const value = data[index] * (statsCurrency === 'USD' ? 1 / exchangeRate : 1);
                const colorClass = value >= 0 ? 'text-green-500' : 'text-red-500';
                return <span class="inline-block mx-2">${label}: <strong class="${colorClass}">${formatPrice(value, statsCurrency)}</strong></span>;
            }).join('');
            container.innerHTML = summaryHtml;
        }

        function renderWinRateCharts(journals) {
            const entryTagStats = {}, psychologyTagStats = {}, strategyStats = {}, positionStats = { 'long': { wins: 0, trades: 0 }, 'short': { wins: 0, trades: 0 }};
            journals.forEach(j => {
                const pnl = j.exits.reduce((s, e) => s + calculatePnl(j,e), 0);
                const isWin = pnl > 0;
                if (positionStats[j.position]) { positionStats[j.position].trades++; if (isWin) positionStats[j.position].wins++; }
                [j.entryTags, j.psychologyTags, [j.strategy]].forEach((tags, i) => {
                    const stats = [entryTagStats, psychologyTagStats, strategyStats][i];
                    (tags || []).forEach(tag => { if (!stats[tag]) stats[tag] = { wins: 0, trades: 0 }; stats[tag].trades++; if (isWin) stats[tag].wins++; });
                });
            });
            const createData = stats => ({ labels: Object.keys(stats), rates: Object.keys(stats).map(l => (stats[l].trades > 0 ? (stats[l].wins / stats[l].trades) * 100 : 0)) });
            const entryData = createData(entryTagStats), psychologyData = createData(psychologyTagStats), strategyData = createData(strategyStats), positionData = createData(positionStats);
            createJournalChart('entry-win-rate-chart', 'bar', entryData.labels, entryData.rates, 'ìŠ¹ë¥  (%)', true);
            createJournalChart('psychology-win-rate-chart', 'bar', psychologyData.labels, psychologyData.rates, 'ìŠ¹ë¥  (%)', true);
            createJournalChart('strategy-win-rate-chart', 'bar', strategyData.labels, strategyData.rates, 'ìŠ¹ë¥  (%)', true);
            createJournalChart('position-win-rate-chart', 'bar', positionData.labels, positionData.rates, 'ìŠ¹ë¥  (%)', true);
        }

        function createJournalChart(canvasId, type, labels, data, label, isWinRate = false) {
            if (charts[canvasId]) charts[canvasId].destroy();
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;

            const pnlMultiplier = statsCurrency === 'USD' ? 1 / exchangeRate : 1;
            const chartData = isWinRate ? data : data.map(d => d * pnlMultiplier);
            const isDark = document.documentElement.classList.contains('dark');
            
            const commonOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { display: type === 'doughnut', position: 'bottom' }, 
                    tooltip: { callbacks: { label: c => isWinRate ? ${c.label}: ${c.parsed.toFixed(2)}% : ${c.label}: ${formatPrice(c.raw, statsCurrency)} } } 
                }
            };

            if (type === 'doughnut') {
                 charts[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ 
                    label, data: chartData, 
                    backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                    borderColor: [isDark ? '#1E1E1E' : '#fff'], borderWidth: 4
                }]}, options: commonOptions });
            } else { // bar
                 charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label, data: chartData, backgroundColor: chartData.map(d => d >= (isWinRate ? 50 : 0) ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'), borderWidth: 1 }] }, 
                 options: { ...commonOptions, scales: { y: { beginAtZero: !isWinRate, ticks: { callback: v => isWinRate ? ${v.toFixed(0)}% : formatPrice(v, statsCurrency) } } } } });
            }
        }
        
        function resetForm() {
            journalForm.reset(); 
            document.getElementById('journal-id').value = '';
            document.querySelectorAll('#journal-main-content .toggle-btn.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('#journal-form .number-input').forEach(el => el.value = '');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // ì„ ë¬¼ ì •ë³´ í•„ë“œ ì´ˆê¸°í™” (ìˆ˜ì •ë¨)
            document.getElementById('futures-info-select').value = '';
            document.getElementById('tick-value').value = '';
            document.getElementById('tick-size').value = '';
            // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ë¹„ìš°ê¸°
            document.getElementById('commission-buy').value = '';
            document.getElementById('commission-sell').value = '';
            document.getElementById('delete-futures-info-btn').disabled = true; 
            
            document.querySelector('[data-group="asset-type"] .toggle-btn[data-value="spot"]').click();
            document.querySelector('[data-group="position"] .toggle-btn[data-value="long"]').classList.add('selected');
            document.querySelector('[data-group="strategy"] .toggle-btn[data-value="ë‹¨íƒ€"]').classList.add('selected');
            document.getElementById('form-currency-usd-btn').classList.add('selected');
            
            document.querySelectorAll('.entry-tags-container .tag.selected, .psychology-tags-container .tag.selected').forEach(t => t.classList.remove('selected'));
            
            document.querySelectorAll('.price-input').forEach(input => {
                input.removeEventListener('input', priceInputHandler);
                input.addEventListener('input', priceInputHandler);
            });
        }
        document.getElementById('clear-form-btn').addEventListener('click', resetForm);
        
        // =======================================================
        // ================== HOUSEHOLD LEDGER LOGIC =============
        // =======================================================

        async function initializeLedgerDefaults(userId) {
            const categoriesDocRef = db.collection("users").doc(userId).collection("ledgerData").doc("categories");
            const docSnap = await categoriesDocRef.get();
            if (!docSnap.exists) {
                await categoriesDocRef.set({
                    expense: ['ì‹ë¹„', 'êµí†µë¹„', 'ê³µê³¼ê¸ˆ', 'êµ¬ë…ë£Œ', 'ìê¸°ê°œë°œë¹„', 'ì˜¤ë½/ì—¬ê°€', 'ì„ ë¬¼'],
                    income: ['ì›”ê¸‰', 'ë¶€ìˆ˜ì…', 'ìš©ëˆ', 'ê¸ˆìœµì†Œë“']
                });
            }
        }

        function attachLedgerListeners(userId) {
            if (unsubscribeLedger) unsubscribeLedger();
            unsubscribeLedger = db.collection("users").doc(userId).collection("ledgerEntries").orderBy("date", "desc")
                .onSnapshot((snapshot) => {
                    localLedgerEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                    renderLedgerAnalysisView(); // í†µí•© í•¨ìˆ˜ í˜¸ì¶œ
                });

            if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
            unsubscribeLedgerCategories = db.collection("users").doc(userId).collection("ledgerData").doc("categories")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        localLedgerCategories = {
                            expense: data.expense || data.list || [], // Handle old format
                            income: data.income || []
                        };
                    } else {
                        localLedgerCategories = { expense: [], income: [] };
                    }
                    renderLedgerCategoryTags(localLedgerCategories.expense, 'expense');
                    renderLedgerCategoryTags(localLedgerCategories.income, 'income');
                });
        }
        
        function switchLedgerView(tabId) {
            document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.ledgerTab === tabId));
            ['ledger-form-view', 'ledger-analysis-view'].forEach(viewId => document.getElementById(viewId).classList.toggle('hidden', viewId !== tabId));
            
            if(tabId === 'ledger-analysis-view') renderLedgerAnalysisView();
            
            lucide.createIcons();
        }
        document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(btn => btn.addEventListener('click', () => switchLedgerView(btn.dataset.ledgerTab)));

        function renderLedgerCategoryTags(categories, type) {
            const container = document.getElementById(ledger-${type}-category-tags-container);
            container.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag bg-gray-200 text-gray-700 rounded-full text-sm inline-flex items-center';
                button.dataset.tag = cat;
                
                button.innerHTML = <span class="pl-3 pr-2 py-1">${cat}</span><span class="delete-tag-span pr-2 text-gray-500 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></span>;

                button.addEventListener('click', () => {
                    container.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
                    button.classList.add('selected');
                });
                button.querySelector('.delete-tag-span').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteLedgerCategory(cat, type);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
        }
        
        async function addLedgerCategory(type) {
            const input = document.getElementById(new-ledger-${type}-category);
            const newCategory = input.value.trim();
            if (newCategory && !localLedgerCategories[type].includes(newCategory)) {
                const updatedCategories = { ...localLedgerCategories };
                updatedCategories[type] = [...updatedCategories[type], newCategory].sort((a,b) => a.localeCompare(b));

                try {
                    await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").set(updatedCategories);
                    showToast('${newCategory}' ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.);
                    input.value = '';
                } catch(e) {
                    showToast("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹¤íŒ¨", "error");
                }
            } else if (localLedgerCategories[type].includes(newCategory)) {
                showToast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.", "error");
            }
        }
        document.getElementById('add-ledger-expense-category-btn').addEventListener('click', () => addLedgerCategory('expense'));
        document.getElementById('add-ledger-income-category-btn').addEventListener('click', () => addLedgerCategory('income'));

        
        function handleDeleteLedgerCategory(category, type) {
            const isCategoryInUse = localLedgerEntries.some(entry => entry.type === type && entry.category === category);
            if (isCategoryInUse) {
                showToast("ì‚¬ìš© ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error"); return;
            }
            showConfirmModal('${category}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?, async () => {
                const updatedCategories = { ...localLedgerCategories };
                updatedCategories[type] = updatedCategories[type].filter(c => c !== category);
                try {
                    await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").set(updatedCategories);
                    showToast('${category}' ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.);
                } catch(e) {
                     showToast("ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì‹¤íŒ¨", "error");
                }
            }, 'ì‚­ì œ');
        }

        document.getElementById('ledger-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('ledger-id').value;
            const type = document.querySelector('[data-group="ledger-type"] .toggle-btn.selected').dataset.value;
            const selectedCategoryTag = document.querySelector(#ledger-${type}-category-tags-container .tag.selected);
            const amount = parseFloat(unformatNumber(document.getElementById('ledger-amount').value));

            if(!selectedCategoryTag) { showToast("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error"); return; }
            if(isNaN(amount) || amount <= 0) { showToast("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error"); return; }

            const entryData = {
                type: type,
                date: Timestamp.fromDate(new Date(document.getElementById('ledger-date').value)),
                amount: amount,
                category: selectedCategoryTag.dataset.tag,
                memo: document.getElementById('ledger-memo').value.trim()
            };

            try {
                const collectionRef = db.collection("users").doc(currentUser.uid).collection("ledgerEntries");
                if (id) {
                    await collectionRef.doc(id).update(entryData);
                    showToast("ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    await collectionRef.add(entryData);
                    showToast("ë‚´ì—­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                resetLedgerForm();
                switchLedgerView('ledger-analysis-view');
            } catch (error) { showToast("ì €ì¥ ì‹¤íŒ¨.", "error"); }
        });
        
        function resetLedgerForm() {
            document.getElementById('ledger-form').reset();
            document.getElementById('ledger-id').value = '';
            document.getElementById('ledger-date').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('#ledger-form .tag.selected').forEach(t => t.classList.remove('selected'));
            document.querySelector('#ledger-form .toggle-btn[data-value="expense"]').click();
        }
        document.getElementById('clear-ledger-form-btn').addEventListener('click', resetLedgerForm);

        // [êµì²´] renderLedgerListView ì™€ renderLedgerStatsView ë¥¼ í†µí•©í•œ ìƒˆ í•¨ìˆ˜
        function renderLedgerAnalysisView() {
            // 1. í•„í„° ë° ê¸°ê°„ ì„¤ì •
            const filterType = document.getElementById('ledger-analysis-filter-type').value;
            const displayEl = document.getElementById('ledger-analysis-period-display');
            
            const { start, end, displayString } = getPeriod(ledgerAnalysisDate, filterType);
            displayEl.textContent = displayString;
            
            const entries = localLedgerEntries.filter(e => e.date >= start && e.date <= end);
            
            // 2. ë°ì´í„° ì§‘ê³„
            let totalIncome = 0, totalExpense = 0;
            const expenseByCategory = {};
            const incomeByCategory = {};

            entries.forEach(e => {
                const category = e.category || 'ë¯¸ë¶„ë¥˜';
                if (e.type === 'income') {
                    totalIncome += e.amount;
                    incomeByCategory[category] = (incomeByCategory[category] || 0) + e.amount;
                }
                else {
                    totalExpense += e.amount;
                    expenseByCategory[category] = (expenseByCategory[category] || 0) + e.amount;
                }
            });

            // 3. ê¸°ê°„ ë‚´ ìš”ì•½ ë Œë”ë§
            document.getElementById('ledger-total-income').textContent = formatPrice(totalIncome, 'KRW');
            document.getElementById('ledger-total-expense').textContent = formatPrice(totalExpense, 'KRW');
            const balance = totalIncome - totalExpense;
            const balanceEl = document.getElementById('ledger-balance');
            balanceEl.textContent = formatPrice(balance, 'KRW');
            balanceEl.className = text-3xl font-bold ${balance >= 0 ? 'text-blue-500' : 'text-red-500'};

            // 4. íŒŒì´ ì°¨íŠ¸ ë Œë”ë§
            document.getElementById('ledger-expense-chart-title').textContent = ${displayString} ì§€ì¶œ êµ¬ì„±;
            const sortedExpense = Object.entries(expenseByCategory).sort((a,b) => b[1] - a[1]);
            createLedgerChart('ledger-expense-chart', 'pie', 
                sortedExpense.map(c => c[0]), 
                [{ label: 'ì§€ì¶œ', data: sortedExpense.map(c => c[1]) }]
            );
            document.getElementById('ledger-income-chart-title').textContent = ${displayString} ìˆ˜ì… êµ¬ì„±;
            const sortedIncome = Object.entries(incomeByCategory).sort((a,b) => b[1] - a[1]);
            createLedgerChart('ledger-income-chart', 'pie', 
                sortedIncome.map(c => c[0]), 
                [{ label: 'ìˆ˜ì…', data: sortedIncome.map(c => c[1]) }]
            );

            // 5. ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½ ë Œë”ë§
            const expenseSummaryContainer = document.getElementById('ledger-category-summary');
            expenseSummaryContainer.innerHTML = '';
            if(Object.keys(expenseByCategory).length === 0){
                expenseSummaryContainer.innerHTML = <p class="text-gray-500 text-center text-sm">ì§€ì¶œ ë‚´ì—­ ì—†ìŒ</p>;
            } else {
                Object.entries(expenseByCategory).sort((a,b) => b[1] - a[1]).forEach(([category, total]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                    div.innerHTML = <span class="font-medium">${category}</span><span class="font-bold text-red-500">- ${formatPrice(total, 'KRW')}</span>;
                    div.onclick = () => {
                        document.querySelectorAll('#ledger-analysis-view #ledger-category-summary .selected').forEach(el => el.classList.remove('selected'));
                        document.querySelectorAll('#ledger-analysis-view #ledger-income-summary .selected').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        renderLedgerDetails(category, 'expense', entries);
                    };
                    expenseSummaryContainer.appendChild(div);
                });
            }
            const incomeSummaryContainer = document.getElementById('ledger-income-summary');
            incomeSummaryContainer.innerHTML = '';
            if(Object.keys(incomeByCategory).length === 0) {
                 incomeSummaryContainer.innerHTML = <p class="text-gray-500 text-center text-sm">ìˆ˜ì… ë‚´ì—­ ì—†ìŒ</p>;
            } else {
                Object.entries(incomeByCategory).sort((a,b) => b[1] - a[1]).forEach(([category, total]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                    div.innerHTML = <span class="font-medium">${category}</span><span class="font-bold text-green-500">+ ${formatPrice(total, 'KRW')}</span>;
                    div.onclick = () => {
                        document.querySelectorAll('#ledger-analysis-view #ledger-category-summary .selected').forEach(el => el.classList.remove('selected'));
                        document.querySelectorAll('#ledger-analysis-view #ledger-income-summary .selected').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        renderLedgerDetails(category, 'income', entries);
                    };
                    incomeSummaryContainer.appendChild(div);
                });
            }
            document.getElementById('ledger-entry-details').innerHTML = '';
            document.getElementById('ledger-detail-title').textContent = 'ë‚´ì—­ ì„ íƒ';

            // 6. ì¶”ì´ ì°¨íŠ¸ ë Œë”ë§
            let trendLabels, trendIncomeData, trendExpenseData;
            if(filterType === 'year') {
                document.getElementById('ledger-trend-chart-title').textContent = ${displayString} ì›”ë³„ ì¶”ì´;
                trendLabels = Array.from({length: 12}, (_, i) => ${i + 1}ì›”);
                const monthlyData = trendLabels.map(() => ({income: 0, expense: 0}));
                entries.forEach(e => {
                    const month = e.date.getMonth();
                    if (e.type === 'income') monthlyData[month].income += e.amount;
                    else monthlyData[month].expense += e.amount;
                });
                trendIncomeData = monthlyData.map(d => d.income);
                trendExpenseData = monthlyData.map(d => d.expense);
            } else { // month or quarter
                document.getElementById('ledger-trend-chart-title').textContent = ${displayString} ì¼ë³„ ì¶”ì´;
                const days = (end - start) / (1000 * 60 * 60 * 24);
                trendLabels = Array.from({length: Math.ceil(days) + 1}, (_, i) => {
                    const d = new Date(start);
                    d.setDate(d.getDate() + i);
                    return ${d.getMonth()+1}/${d.getDate()};
                });
                const dailyData = Object.fromEntries(trendLabels.map(l => [l, {income: 0, expense: 0}]));
                entries.forEach(e => {
                    const dayLabel = ${e.date.getMonth()+1}/${e.date.getDate()};
                    if(dailyData[dayLabel]) {
                        if (e.type === 'income') dailyData[dayLabel].income += e.amount;
                        else dailyData[dayLabel].expense += e.amount;
                    }
                });
                trendIncomeData = Object.values(dailyData).map(d => d.income);
                trendExpenseData = Object.values(dailyData).map(d => d.expense);
            }
            
            createLedgerChart('ledger-monthly-pnl-chart', 'bar', trendLabels,
                [{ label: 'ìˆ˜ì…', data: trendIncomeData, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                 { label: 'ì§€ì¶œ', data: trendExpenseData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }]
            );
        }
        
        function renderLedgerDetails(category, type, entries) {
            document.getElementById('ledger-detail-title').textContent = category;
            const detailsContainer = document.getElementById('ledger-entry-details');
            detailsContainer.innerHTML = '';

            const entriesToShow = entries.filter(e => e.type === type && (e.category || 'ë¯¸ë¶„ë¥˜') === category);

            if(entriesToShow.length === 0) {
                detailsContainer.innerHTML = <p class="text-gray-500 text-center">ìƒì„¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>;
                return;
            }

            entriesToShow.sort((a,b) => b.date - a.date)
                .forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-lg border border-gray-200 dark:border-[#4F4F4F] flex justify-between items-center bg-gray-50 dark:bg-[#1E1E1E]';
                    const amountClass = type === 'income' ? 'text-green-500' : 'text-red-500';
                    const sign = type === 'income' ? '+' : '-';
                    div.innerHTML = 
                        <div>
                            <p class="font-medium">${entry.date.toLocaleDateString()}</p>
                            <p class="text-sm text-gray-500">${entry.memo || (type === 'income' ? 'ìˆ˜ì…' : 'ë©”ëª¨ ì—†ìŒ')}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold ${amountClass}">${sign} ${formatPrice(entry.amount, 'KRW')}</span>
                            <div>
                                <button class="p-1 hover:text-blue-500 edit-ledger-btn" data-id="${entry.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button class="p-1 hover:text-red-500 delete-ledger-btn" data-id="${entry.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>;
                    detailsContainer.appendChild(div);
                });
            lucide.createIcons();
            document.querySelectorAll('.edit-ledger-btn').forEach(b => b.addEventListener('click', handleEditLedgerEntry));
            document.querySelectorAll('.delete-ledger-btn').forEach(b => b.addEventListener('click', handleDeleteLedgerEntry));
        }
        
        function handleEditLedgerEntry(e) {
            const id = e.currentTarget.dataset.id;
            const entry = localLedgerEntries.find(item => item.id === id);
            if (entry) {
                switchLedgerView('ledger-form-view');
                document.getElementById('ledger-id').value = entry.id;
                document.getElementById('ledger-date').value = entry.date.toISOString().split('T')[0];
                document.getElementById('ledger-amount').value = formatNumber(entry.amount);
                document.getElementById('ledger-memo').value = entry.memo;
                document.querySelector(.toggle-btn[data-value="${entry.type}"]).click();
                if(entry.category) {
                    document.querySelector(#ledger-${entry.type}-category-tags-container .tag[data-tag="${entry.category}"])?.click();
                }
            }
        }
        
        function handleDeleteLedgerEntry(e) {
            const id = e.currentTarget.dataset.id;
            showConfirmModal('ì •ë§ë¡œ ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                db.collection("users").doc(currentUser.uid).collection("ledgerEntries").doc(id).delete()
                  .then(() => showToast("ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."))
                  .catch(() => showToast("ì‚­ì œ ì‹¤íŒ¨", "error"));
            }, 'ì‚­ì œ');
        }

        function updateLedgerAnalysisDate(offset) {
            const filterType = document.getElementById('ledger-analysis-filter-type').value;
            if (filterType === 'month') ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth() + offset);
            else if (filterType === 'quarter') ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth() + offset * 3);
            else ledgerAnalysisDate.setFullYear(ledgerAnalysisDate.getFullYear() + offset);
            renderLedgerAnalysisView();
        }
        
        document.getElementById('ledger-analysis-prev-btn').addEventListener('click', () => updateLedgerAnalysisDate(-1));
        document.getElementById('ledger-analysis-next-btn').addEventListener('click', () => updateLedgerAnalysisDate(1));
        document.getElementById('ledger-analysis-filter-type').addEventListener('change', () => {
            ledgerAnalysisDate = new Date();
            renderLedgerAnalysisView();
        });
        
        function createLedgerChart(canvasId, type, labels, datasets) {
            if (charts[canvasId]) charts[canvasId].destroy();
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            const isDark = document.documentElement.classList.contains('dark');

            const defaultColors = [
              'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
              'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(40, 159, 64, 0.7)'
            ];

            const chartDatasets = datasets.map((ds, index) => ({
                ...ds,
                backgroundColor: ds.backgroundColor || (type === 'pie' ? defaultColors : defaultColors[index % defaultColors.length]),
                borderColor: isDark ? '#1E1E1E' : '#fff',
                borderWidth: type === 'pie' ? 2 : 1
            }));

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: { labels, datasets: chartDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: type !== 'bar', position: 'bottom' },
                        tooltip: { callbacks: { label: c => ${c.label}: ${formatPrice(c.raw, 'KRW')} } } 
                    },
                    scales: (type === 'bar') ? { y: { beginAtZero: true, ticks: { callback: v => formatPrice(v, 'KRW') } } } : {}
                }
            });
        }


        // ================== Global Helpers & Listeners ==================
        
        function getPeriod(date, filterType) {
            const year = date.getFullYear();
            const month = date.getMonth();
            let start, end, displayString;
            if (filterType === 'month') {
                displayString = ${year}ë…„ ${month + 1}ì›”;
                start = new Date(year, month, 1);
                end = new Date(year, month + 1, 0, 23, 59, 59);
            } else if (filterType === 'quarter') {
                const quarter = Math.floor(month / 3) + 1;
                displayString = ${year}ë…„ ${quarter}ë¶„ê¸°;
                start = new Date(year, (quarter - 1) * 3, 1);
                end = new Date(year, quarter * 3, 0, 23, 59, 59);
            } else { // year
                displayString = ${year}ë…„;
                start = new Date(year, 0, 1);
                end = new Date(year, 11, 31, 23, 59, 59);
            }
            return { start, end, displayString };
        }

        const unformatNumber = (value) => value ? value.toString().replace(/,/g, '') : '';
        const formatNumber = (value) => {
            if (value === null || value === undefined || value === '') return '';
            let stringValue = unformatNumber(value).toString();
            let parts = stringValue.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        };
        const formatPrice = (price, currency) => {
            if (isNaN(price) || price === null) return '';
            const options = { maximumFractionDigits: 6 };
            const num = parseFloat(price);
            if(currency === 'USD') return $${num.toLocaleString('en-US', options)};
            return â‚©${num.toLocaleString('en-US', {maximumFractionDigits: (num % 1 === 0) ? 0 : 6})};
        };
        
        const formatPriceDisplay = (price, isBond) => {
            if (price === null || price === undefined) return '';
            return isBond ? decimalToBondPrice(price) : formatNumber(price);
        }
        
        const formatDualCurrency = (pnlInKRW, originalCurrency) => {
            const pnlInUSD = pnlInKRW / exchangeRate;
            return originalCurrency === 'KRW' ? ${formatPrice(pnlInKRW, 'KRW')} (${formatPrice(pnlInUSD, 'USD')}) : ${formatPrice(pnlInUSD, 'USD')} (${formatPrice(pnlInKRW, 'KRW')});
        }
        
        function unformatPrice(value, isBond) {
             if (isBond) return bondPriceToDecimal(value);
             return parseFloat(unformatNumber(value));
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.remove('scale-95'); }, 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.firstElementChild.classList.add('scale-95'); modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }
        
        document.getElementById('close-modal-btn').addEventListener('click', () => closeModal('exit-modal'));
        document.getElementById('exit-modal').addEventListener('click', e => { if (e.target.id === 'exit-modal') closeModal('exit-modal'); });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.firstElementChild.textContent = message;
            toast.className = fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'};
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function showConfirmModal(message, callback, type = 'ì‚­ì œ') {
            document.getElementById('confirm-message').textContent = message;
            const okBtn = document.getElementById('confirm-ok-btn');
            okBtn.textContent = type;
            okBtn.className = text-white px-4 py-2 rounded-lg ${type === 'ì‚­ì œ' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'};
            confirmCallback = callback;
            openModal('confirm-modal');
        }
        document.getElementById('confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeModal('confirm-modal'); });
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal('confirm-modal'));

        const numberInputHandler = (e) => { e.target.value = formatNumber(e.target.value); };
        
        // **í†µí•©ëœ ê°€ê²© ì…ë ¥ í•¸ë“¤ëŸ¬ (ìˆ˜ì •ë¨)**
        const priceInputHandler = (e) => {
            let value = e.target.value;
            
            value = value.replace(/,/g, '');

            if (value.includes("'")) {
                value = value.replace(/[^0-9']/g, ''); 
                
                const apostrophes = (value.match(/'/g) || []).length;
                if (apostrophes > 2) {
                    value = value.substring(0, value.lastIndexOf("'")) + value.substring(value.lastIndexOf("'") + 1);
                }
                e.target.value = value;
                
            } else {
                let parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                e.target.value = parts.join('.');
            }
        };

        document.querySelectorAll('.number-input').forEach(input => {
            input.addEventListener('input', numberInputHandler);
        });
        document.querySelectorAll('.price-input').forEach(input => {
            input.addEventListener('input', priceInputHandler);
        });
        
        document.querySelectorAll('.exchange-rate-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const value = unformatNumber(e.target.value);
                const newRate = parseFloat(value);
                if (newRate > 0) {
                    exchangeRate = newRate;
                    document.querySelectorAll('.exchange-rate-input').forEach(otherInput => {
                        if (otherInput !== e.target) otherInput.value = formatNumber(value);
                    });
                    if(currentUser) renderJournalStats(localJournals);
                }
            });
        });

        document.addEventListener('click', function(event) {
            const button = event.target.closest('.toggle-btn');
            if (button) {
                const group = button.closest('.toggle-group');
                if (group) {
                    group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    if(group.dataset.group === 'stats-currency' && currentUser) {
                         statsCurrency = button.id.includes('usd') ? 'USD' : 'KRW';
                         renderJournalStats(localJournals);
                    }
                    if (group.dataset.group === 'ledger-type') {
                        const isExpense = button.dataset.value === 'expense';
                        document.getElementById('ledger-expense-category-section').classList.toggle('hidden', !isExpense);
                        document.getElementById('ledger-income-category-section').classList.toggle('hidden', isExpense);
                    }
                }
            }
        });
        
        window.addEventListener('DOMContentLoaded', () => {
            setTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            lucide.createIcons();
            switchJournalView('form-view');
            switchLedgerView('ledger-form-view');
            document.querySelectorAll('.exchange-rate-input').forEach(input => input.value = formatNumber(exchangeRate));
            resetForm();
        });

        function setTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            document.getElementById('sun-icon').style.display = theme === 'dark' ? 'block' : 'none';
            document.getElementById('moon-icon').style.display = theme === 'dark' ? 'none' : 'block';
            updateChartTheme();
        }

        function updateChartTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.borderColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            Chart.defaults.color = isDark ? '#d1d5db' : '#374151';
            if (currentUser) {
                renderJournalStats(localJournals);
                renderLedgerAnalysisView();
            }
        }
        document.getElementById('theme-toggle').addEventListener('click', () => setTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'));

    </script>
</body>
</html>

