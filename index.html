<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pancake Journal - Îß§Îß§ÏùºÏßÄ & Í∞ÄÍ≥ÑÎ∂Ä</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts: Kanit (Official Pancake Font) & Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pancake: {
                            cyan: '#1FC7D4',
                            purple: '#7645D9',
                            dark: '#08060B',
                            card: '#FFFFFF',
                            cardDark: '#27262C',
                            text: '#280D5F',
                            textSub: '#7A6EAA',
                            textDark: '#F4EEFF',
                            textSubDark: '#B8ADD2',
                            input: '#EEEAF4',
                            inputDark: '#372F47',
                            border: '#E7E3EB',
                            borderDark: '#383241',
                            success: '#31D0AA',
                            failure: '#ED4B9E',
                            warning: '#FFB237'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                        brand: ['Kanit', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Pancake Design System Overrides --- */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #EFF4F5; /* Light Theme Bg */
            color: #280D5F;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark body {
            background-color: #08060B; /* Dark Theme Bg */
            color: #F4EEFF;
        }

        /* Titles use Kanit */
        h1, h2, h3, .font-brand {
            font-family: 'Kanit', sans-serif;
        }

        /* Card Style - The "Pancake Panel" */
        .pc-card {
            background: #FFFFFF;
            border: 1px solid #E7E3EB;
            border-bottom: 3px solid #E7E3EB;
            border-radius: 24px;
            padding: 24px;
            transition: all 0.2s ease-in-out;
        }
        .dark .pc-card {
            background: #27262C;
            border-color: #383241;
            color: #F4EEFF;
        }

        /* Buttons - The "Pancake Button" */
        .pc-btn {
            font-family: 'Noto Sans KR', sans-serif; /* ÌïúÍ∏Ä Ìè∞Ìä∏Î°ú Î≥ÄÍ≤Ω */
            font-weight: 700;
            border-radius: 16px;
            padding: 10px 20px;
            transition: transform 0.1s, box-shadow 0.1s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0px 2px 0px rgba(0,0,0,0.1);
        }
        .pc-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .pc-btn-primary {
            background-color: #1FC7D4;
            color: white;
            box-shadow: 0px 4px 0px #139ea8;
        }
        .pc-btn-primary:active { box-shadow: 0px 0px 0px #139ea8; }
        
        .pc-btn-secondary {
            background-color: transparent;
            color: #1FC7D4;
            border: 2px solid #1FC7D4;
            box-shadow: none;
        }
        .pc-btn-secondary:hover { opacity: 0.7; }
        
        .pc-btn-purple {
            background-color: #7645D9;
            color: white;
            box-shadow: 0px 4px 0px #522f99;
        }
        .pc-btn-purple:active { box-shadow: 0px 0px 0px #522f99; }

        .pc-btn-danger {
            background-color: #ED4B9E;
            color: white;
            box-shadow: 0px 4px 0px #bd2975;
        }
        .pc-btn-danger:active { box-shadow: 0px 0px 0px #bd2975; }

        /* Inputs - Clean & Round */
        .pc-input {
            background-color: #EEEAF4;
            border: 1px solid #D7CAEC;
            border-radius: 16px;
            padding: 12px 16px;
            color: #280D5F;
            font-weight: 500;
            width: 100%;
            transition: box-shadow 0.2s;
        }
        .pc-input:focus {
            outline: none;
            box-shadow: 0px 0px 0px 4px rgba(118, 69, 217, 0.2);
            border-color: #7645D9;
        }
        .dark .pc-input {
            background-color: #372F47;
            border-color: #383241;
            color: #FFFFFF;
        }
        .dark .pc-input:focus {
            box-shadow: 0px 0px 0px 4px rgba(31, 199, 212, 0.2);
            border-color: #1FC7D4;
        }
        
        /* Select & Date Dark Mode Fixes */
        .dark select option { background-color: #372F47; color: white; }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* Segmented Control (Tabs) */
        .pc-tab-container {
            background-color: #EFF4F5;
            border-radius: 24px;
            padding: 4px;
            display: inline-flex;
        }
        .dark .pc-tab-container { background-color: #372F47; }
        
        .pc-tab {
            padding: 8px 24px;
            border-radius: 20px;
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            color: #7A6EAA;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .pc-tab { color: #B8ADD2; }
        
        .pc-tab.active {
            background-color: #7A6EAA;
            color: white;
        }
        .dark .pc-tab.active {
            background-color: #1FC7D4;
            color: #08060B;
        }

        /* Toggle Button Group */
        .pc-toggle-group {
            display: flex;
            background-color: #EEEAF4;
            border-radius: 16px;
            padding: 2px;
        }
        .dark .pc-toggle-group { background-color: #372F47; }
        
        .pc-toggle-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            color: #7A6EAA;
            transition: all 0.2s;
        }
        .dark .pc-toggle-btn { color: #B8ADD2; }
        
        .pc-toggle-btn.selected {
            background-color: #1FC7D4;
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .dark .pc-toggle-btn.selected {
            background-color: #1FC7D4;
            color: #08060B;
        }
        
        /* Tags */
        .tag { border-radius: 12px; transition: all 0.2s; font-weight: 600; font-size: 0.85rem; padding: 4px 10px; border: 2px solid transparent; cursor: pointer; }
        .tag-default { background-color: #EFF4F5; color: #7A6EAA; border: 1px solid #E7E3EB; }
        .dark .tag-default { background-color: #372F47; color: #B8ADD2; border-color: #4F4F4F; }
        .tag.selected-environment { background-color: #FFB237 !important; color: #280D5F !important; }
        .tag.selected-entry { background-color: #31D0AA !important; color: white !important; }
        .tag.selected-psychology { background-color: #7645D9 !important; color: white !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E7E3EB; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #372F47; }
        ::-webkit-scrollbar-thumb:hover { background: #1FC7D4; }

        /* Animation */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .mascot-bounce { animation: bounce-slow 3s infinite ease-in-out; }
    </style>

    <!-- Dark Mode Init -->
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="min-h-screen pb-20 selection:bg-pancake-cyan selection:text-white">

    <!-- 1. Login View -->
    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen px-4 relative overflow-hidden">
        <!-- Background Elements -->
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-pancake-cyan rounded-full mix-blend-multiply filter blur-[128px] opacity-20 dark:opacity-10 animate-blob"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-pancake-purple rounded-full mix-blend-multiply filter blur-[128px] opacity-20 dark:opacity-10 animate-blob animation-delay-2000"></div>

        <div class="z-10 text-center w-full max-w-sm">
            <div class="mb-8 mascot-bounce relative inline-block">
                <span class="text-8xl">üê∞</span>
                <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-20 h-4 bg-black opacity-10 rounded-[100%] blur-sm"></div>
            </div>
            
            <h1 class="text-4xl font-bold mb-2 text-pancake-text dark:text-white">Pancake Journal</h1>
            <p class="text-pancake-textSub dark:text-pancake-textSubDark mb-10 font-medium">Í∏∞Î°ùÏúºÎ°ú ÏÑ±Ïû•ÌïòÎäî Îã¨ÏΩ§Ìïú ÏäµÍ¥Ä</p>
            
            <div class="pc-card">
                <button id="login-btn" class="w-full pc-btn pc-btn-primary text-lg py-4">
                    <span class="mr-2 text-xl">ü•û</span> Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú ÏãúÏûë
                </button>
            </div>
        </div>
    </div>

    <!-- 2. App Container -->
    <div id="app-container" class="max-w-6xl mx-auto px-4 py-6 hidden">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <span class="text-3xl">üê∞</span>
                <div>
                    <h1 class="text-xl font-bold text-pancake-text dark:text-white leading-tight">ÎÇòÏùò Îß§Îß§ÏùºÏßÄ</h1>
                    <div id="auth-info" class="text-xs font-bold text-pancake-cyan"></div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-white dark:bg-pancake-cardDark p-1.5 rounded-full border border-pancake-border dark:border-pancake-borderDark shadow-sm">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-pancake-inputDark transition text-pancake-warning">
                    <i id="sun-icon" data-lucide="sun" class="w-5 h-5"></i>
                    <i id="moon-icon" data-lucide="moon" class="w-5 h-5 hidden"></i>
                </button>
                <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-pancake-inputDark transition text-pancake-failure">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Main Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="pc-tab-container shadow-sm">
                <button data-main-tab="journal-container" class="pc-tab active">Îß§Îß§ÏùºÏßÄ</button>
                <button data-main-tab="ledger-container" class="pc-tab">Í∞ÄÍ≥ÑÎ∂Ä</button>
            </div>
        </div>

        <!-- ================= JOURNAL SECTION ================= -->
        <div id="journal-container" class="space-y-6">
            <!-- Sub Navigation -->
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button data-tab="form-view" class="pc-btn pc-btn-primary text-sm flex-shrink-0"><i data-lucide="plus" class="w-4 h-4 mr-1"></i> ÏùºÏßÄ ÏûëÏÑ±</button>
                <button data-tab="list-view" class="pc-btn pc-btn-secondary text-sm flex-shrink-0 bg-white dark:bg-transparent"><i data-lucide="list" class="w-4 h-4 mr-1"></i> ÎÇ¥ ÏùºÏßÄ</button>
                <button data-tab="stats-view" class="pc-btn pc-btn-secondary text-sm flex-shrink-0 bg-white dark:bg-transparent"><i data-lucide="bar-chart-2" class="w-4 h-4 mr-1"></i> ÏÑ±Í≥º Î∂ÑÏÑù</button>
            </div>

            <!-- Content Area -->
            <main id="journal-main-content">
                
                <!-- 1. Journal Form (FUSION: Old Layout + New Design) -->
                <div id="form-view">
                    <form id="journal-form" class="pc-card space-y-8 relative">
                         <!-- Decorative Blob -->
                        <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-[#1FC7D4] rounded-full opacity-5 blur-3xl pointer-events-none"></div>

                        <input type="hidden" id="journal-id">
                        
                        <div class="space-y-6">
                            <h2 class="text-xl font-bold mb-4 border-b-2 border-pancake-border dark:border-pancake-borderDark pb-3 flex items-center text-pancake-text dark:text-white"><i data-lucide="clipboard-list" class="mr-2 text-pancake-cyan"></i>Í∏∞Î≥∏ Ï†ïÎ≥¥</h2>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="sm:col-span-2 space-y-2">
                                    <span class="block text-sm font-bold text-pancake-purple dark:text-pancake-textSubDark mb-1 pl-1">ÏûêÏÇ∞ Ïú†Ìòï</span>
                                    <div class="pc-toggle-group" data-group="asset-type">
                                        <button type="button" data-value="spot" class="pc-toggle-btn selected">ÌòÑÎ¨º</button>
                                        <button type="button" data-value="futures" class="pc-toggle-btn">ÏÑ†Î¨º</button>
                                    </div>
                                </div>

                                <div class="sm:col-span-2 space-y-2">
                                    <label for="ticker" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">Ï¢ÖÎ™© Ïù¥Î¶Ñ</label>
                                    <input type="text" id="ticker" placeholder="Ïòà: ÏÇºÏÑ±Ï†ÑÏûê, BTC" required class="pc-input text-base font-bold uppercase">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label for="date" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">ÎÇ†Ïßú</label>
                                    <input type="date" id="date" required class="pc-input">
                                </div>
                                
                                <div class="space-y-2">
                                    <span class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">Ìè¨ÏßÄÏÖò</span>
                                    <div class="pc-toggle-group" data-group="position">
                                        <button type="button" data-value="long" class="pc-toggle-btn selected text-pancake-success">üü¢ Î°±</button>
                                        <button type="button" data-value="short" class="pc-toggle-btn text-pancake-failure">üî¥ Ïàè</button>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <span class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">Îß§Îß§ Ï†ÑÎûµ</span>
                                    <div class="pc-toggle-group" data-group="strategy">
                                        <button type="button" data-value="Îã®ÌÉÄ" class="pc-toggle-btn selected">Îã®ÌÉÄ</button>
                                        <button type="button" data-value="Ïä§Ïúô" class="pc-toggle-btn">Ïä§Ïúô</button>
                                        <button type="button" data-value="Ïû•Í∏∞" class="pc-toggle-btn">Ïû•Í∏∞</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                <div id="spot-fields" class="space-y-2">
                                    <label for="quantity" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">ÏàòÎüâ</label>
                                    <input type="text" inputmode="numeric" id="quantity" placeholder="Ïòà: 100" class="number-input pc-input">
                                </div>

                                <div id="futures-contracts-field" class="hidden space-y-2">
                                    <label for="contracts" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">Í≥ÑÏïΩ Ïàò</label>
                                    <input type="text" inputmode="numeric" id="contracts" placeholder="Ïòà: 1" class="number-input pc-input">
                                </div>
                                
                                <div class="space-y-2">
                                    <span class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">ÏûÖÎ†• ÌÜµÌôî</span>
                                    <div class="pc-toggle-group" data-group="form-currency">
                                        <button type="button" id="form-currency-krw-btn" class="pc-toggle-btn">Ïõê (‚Ç©)</button>
                                        <button type="button" id="form-currency-usd-btn" class="pc-toggle-btn selected">Îã¨Îü¨ ($)</button>
                                    </div>
                                </div>

                                <div class="space-y-2"><label for="entry-price" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">ÏßÑÏûÖÍ∞Ä</label><input type="text" inputmode="decimal" id="entry-price" placeholder="0" required class="number-input pc-input"></div>
                                <div class="space-y-2"><label for="target-price" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">Î™©ÌëúÍ∞Ä</label><input type="text" inputmode="decimal" id="target-price" placeholder="0" required class="number-input pc-input border-pancake-success focus:border-pancake-success"></div>
                                <div class="sm:col-span-2 space-y-2"><label for="stop-loss" class="block text-sm font-bold text-pancake-text dark:text-white mb-1 pl-1">ÏÜêÏ†àÍ∞Ä</label><input type="text" inputmode="decimal" id="stop-loss" placeholder="0" required class="number-input pc-input border-pancake-failure focus:border-pancake-failure"></div>
                            </div>
                            
                            <div id="futures-fields" class="hidden sm:col-span-2 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                    <div class="sm:col-span-3 bg-pancake-input dark:bg-pancake-inputDark p-4 rounded-2xl border border-pancake-border dark:border-pancake-borderDark">
                                        <h3 class="text-base font-semibold mb-3 flex justify-between items-center text-pancake-text dark:text-white">
                                            <span>‚ö° ÏÑ†Î¨º Ï¢ÖÎ™© Ï†ïÎ≥¥ (Ìã±Í∞ÄÏπò/Îã®ÏúÑ)</span>
                                            <div class="flex gap-2">
                                                <button type="button" id="save-futures-info-btn" class="text-xs text-pancake-cyan font-bold hover:underline">Ï†ÄÏû•</button>
                                                <button type="button" id="delete-futures-info-btn" class="text-xs text-pancake-failure font-bold hover:underline" disabled>ÏÇ≠Ï†ú</button>
                                            </div>
                                        </h3>
                                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                                            <select id="futures-info-select" class="pc-input flex-grow p-3 text-base"></select>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label for="tick-value" class="block text-sm font-medium text-pancake-textSub dark:text-pancake-textSubDark mb-1">Ìã±Í∞ÄÏπò ($)</label><input type="text" inputmode="decimal" id="tick-value" placeholder="Ïòà: 1" class="number-input pc-input bg-white dark:bg-pancake-cardDark"></div>
                                            <div><label for="tick-size" class="block text-sm font-medium text-pancake-textSub dark:text-pancake-textSubDark mb-1">Ìã±Îã®ÏúÑ</label><input type="text" inputmode="decimal" id="tick-size" placeholder="Ïòà: 0.001" class="number-input pc-input bg-white dark:bg-pancake-cardDark"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-pancake-border dark:border-pancake-borderDark">
                            <h2 class="text-xl font-bold border-b-2 border-yellow-200 dark:border-yellow-700 pb-2 flex items-center text-pancake-text dark:text-white"><i data-lucide="cloud-sun" class="mr-3 text-pancake-warning"></i>ÌôòÍ≤Ω ÌÉúÍ∑∏</h2>
                            <div id="environment-tags-container" class="flex flex-wrap gap-2 mb-2 environment-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-environment-tag" placeholder="ÏßÅÏ†ë ÏûÖÎ†•" class="flex-grow pc-input"><button type="button" class="add-environment-tag-btn pc-btn bg-pancake-warning text-pancake-text px-6 hover:opacity-80 transition shadow-[0px_2px_0px_0px_#b3740e]">Ï∂îÍ∞Ä</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-pancake-border dark:border-pancake-borderDark">
                            <h2 class="text-xl font-bold border-b-2 border-green-200 dark:border-green-700 pb-2 flex items-center text-pancake-text dark:text-white"><i data-lucide="siren" class="mr-3 text-pancake-success"></i>ÏßÑÏûÖ Í∑ºÍ±∞</h2>
                            <div id="entry-tags-container" class="flex flex-wrap gap-2 mb-2 entry-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-entry-tag" placeholder="ÏßÅÏ†ë ÏûÖÎ†•" class="flex-grow pc-input"><button type="button" class="add-entry-tag-btn pc-btn bg-pancake-success text-white px-6 hover:opacity-80 transition shadow-[0px_2px_0px_0px_#1e7a63]">Ï∂îÍ∞Ä</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-pancake-border dark:border-pancake-borderDark">
                            <h2 class="text-xl font-bold border-b-2 border-purple-200 dark:border-purple-700 pb-2 flex items-center text-pancake-text dark:text-white"><i data-lucide="brain-circuit" class="mr-3 text-pancake-purple"></i>Ïã¨Î¶¨ ÏÉÅÌÉú</h2>
                            <div id="psychology-tags-container" class="flex flex-wrap gap-2 mb-2 psychology-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-psychology-tag" placeholder="ÏßÅÏ†ë ÏûÖÎ†•" class="flex-grow pc-input"><button type="button" class="add-psychology-tag-btn pc-btn bg-pancake-purple text-white px-6 hover:opacity-80 transition shadow-[0px_2px_0px_0px_#4c2c8c]">Ï∂îÍ∞Ä</button></div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6 border-t border-pancake-border dark:border-pancake-borderDark">
                            <button type="button" id="clear-form-btn" class="pc-btn bg-pancake-input dark:bg-pancake-inputDark text-pancake-textSub dark:text-pancake-textSubDark px-6 hover:opacity-80 transition">Ï¥àÍ∏∞Ìôî</button>
                            <button type="submit" class="pc-btn pc-btn-primary px-8 flex items-center text-lg"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>ÏùºÏßÄ Ï†ÄÏû•</button>
                        </div>
                    </form>
                </div>

                <!-- 2. List View -->
                <div id="list-view" class="hidden">
                     <div class="flex items-center justify-end mb-4">
                        <label class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark mr-2">ÌòÑÏû¨ ÌôòÏú® ($1 =)</label>
                        <input type="text" id="list-exchange-rate" value="1,380" class="exchange-rate-input pc-input w-24 text-right font-bold py-1">
                    </div>
                    <div id="journal-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- 3. Stats View (Enhanced) -->
                <div id="stats-view" class="hidden space-y-8">
                     <div class="pc-card p-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div class="pc-toggle-group" data-group="stats-currency">
                            <button id="stats-currency-krw-btn" class="pc-toggle-btn selected">Ïõê (KRW)</button>
                            <button id="stats-currency-usd-btn" class="pc-toggle-btn">Îã¨Îü¨ (USD)</button>
                        </div>
                         <div class="flex items-center gap-2">
                            <span class="text-sm font-bold">ÌôòÏú®:</span>
                            <input type="text" id="stats-exchange-rate" value="1,380" class="exchange-rate-input pc-input w-24 text-center font-bold py-1">
                         </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="pc-card text-center py-6 border-b-4 border-pancake-cyan">
                            <h4 class="text-pancake-textSub dark:text-pancake-textSubDark font-bold text-sm mb-1">Ï¥ù ÏäπÎ•†</h4>
                            <p id="total-win-rate" class="text-3xl font-brand font-bold text-pancake-cyan">0%</p>
                        </div>
                        <div class="pc-card text-center py-6 border-b-4 border-pancake-success">
                            <h4 class="text-pancake-textSub dark:text-pancake-textSubDark font-bold text-sm mb-1">ÌèâÍ∑† ÏÜêÏùµÎπÑ</h4>
                            <p id="average-pl-ratio" class="text-3xl font-brand font-bold text-pancake-success">0.0</p>
                        </div>
                        <div class="pc-card text-center py-6 border-b-4 border-pancake-warning">
                            <h4 class="text-pancake-textSub dark:text-pancake-textSubDark font-bold text-sm mb-1">Ï¥ù Ïã§ÌòÑ ÏÜêÏùµ</h4>
                            <p id="total-realized-pnl" class="text-3xl font-brand font-bold text-pancake-warning">0</p>
                        </div>
                    </div>
                    
                    <!-- NEW: Tag Based Win Rates -->
                    <div class="pc-card">
                        <h3 class="text-lg font-bold mb-4 text-pancake-text dark:text-white">üè∑Ô∏è ÌÉúÍ∑∏Î≥Ñ ÏäπÎ•† Î∂ÑÏÑù</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="text-sm font-bold text-pancake-warning mb-2 text-center">ÌôòÍ≤Ω ÌÉúÍ∑∏ ÏäπÎ•†</h4>
                                <div id="env-tag-stats" class="space-y-2"></div>
                            </div>
                            <div class="border-t md:border-t-0 md:border-l border-pancake-border dark:border-pancake-borderDark pt-4 md:pt-0 md:pl-6">
                                <h4 class="text-sm font-bold text-pancake-success mb-2 text-center">ÏßÑÏûÖ Í∑ºÍ±∞ ÏäπÎ•†</h4>
                                <div id="entry-tag-stats" class="space-y-2"></div>
                            </div>
                            <div class="border-t md:border-t-0 md:border-l border-pancake-border dark:border-pancake-borderDark pt-4 md:pt-0 md:pl-6">
                                <h4 class="text-sm font-bold text-pancake-purple mb-2 text-center">Ïã¨Î¶¨ ÏÉÅÌÉú ÏäπÎ•†</h4>
                                <div id="psy-tag-stats" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="pc-card lg:col-span-1 min-h-[300px]">
                            <h3 class="font-bold mb-4">ÏÜêÏùµ Íµ¨ÏÑ±</h3>
                            <div class="h-64 relative w-full"><canvas id="pnl-composition-chart"></canvas></div>
                        </div>
                        <div class="pc-card lg:col-span-2 min-h-[300px]">
                            <h3 class="font-bold mb-4">ÏõîÎ≥Ñ ÏÜêÏùµ Ï∂îÏù¥</h3>
                            <div class="h-64 relative w-full"><canvas id="monthly-pnl-chart"></canvas></div>
                            <div id="monthly-pnl-summary" class="mt-4 text-xs font-mono text-center opacity-70"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- ================= LEDGER SECTION ================= -->
        <div id="ledger-container" class="hidden space-y-6">
            <div class="flex justify-center gap-2 mb-6">
                <button data-ledger-tab="ledger-form-view" class="pc-btn pc-btn-primary text-sm w-32">ÎÇ¥Ïó≠ ÏûÖÎ†•</button>
                <button data-ledger-tab="ledger-analysis-view" class="pc-btn pc-btn-secondary text-sm w-32 bg-white dark:bg-transparent">ÌÜµÍ≥Ñ Î∞è Î∂ÑÏÑù</button>
            </div>

            <main id="ledger-main-content">
                <!-- Ledger Form -->
                <div id="ledger-form-view" class="max-w-2xl mx-auto">
                    <form id="ledger-form" class="pc-card space-y-6">
                        <input type="hidden" id="ledger-id">
                        
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold">ÏÉàÎ°úÏö¥ Í±∞Îûò</h2>
                            <div class="pc-toggle-group w-40" data-group="ledger-type">
                                <button type="button" data-value="expense" class="pc-toggle-btn selected text-pancake-failure">ÏßÄÏ∂ú</button>
                                <button type="button" data-value="income" class="pc-toggle-btn text-pancake-success">ÏàòÏûÖ</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark ml-1 mb-1 block">ÎÇ†Ïßú</label>
                                <input type="date" id="ledger-date" class="pc-input" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark ml-1 mb-1 block">Í∏àÏï°</label>
                                <input type="text" id="ledger-amount" placeholder="0" class="pc-input number-input font-bold text-right" required>
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="bg-pancake-input dark:bg-pancake-inputDark rounded-xl p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold">Ïπ¥ÌÖåÍ≥†Î¶¨ (ÎåÄÎ∂ÑÎ•ò)</span>
                                <div class="flex gap-1">
                                    <input type="text" id="new-ledger-major-category" class="pc-input py-1 px-2 text-xs w-24 bg-white dark:bg-pancake-cardDark" placeholder="Ï∂îÍ∞Ä...">
                                    <button type="button" id="add-ledger-major-category-btn" class="bg-pancake-purple text-white rounded px-2 font-bold">+</button>
                                </div>
                            </div>
                            <div id="ledger-major-category-container" class="flex flex-wrap gap-2 mb-4"></div>

                            <div id="ledger-minor-category-wrapper" class="hidden border-t border-dashed border-gray-300 dark:border-gray-600 pt-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark"><span id="selected-major-name"></span> > ÏÜåÎ∂ÑÎ•ò</span>
                                    <div class="flex gap-1">
                                        <input type="text" id="new-ledger-minor-category" class="pc-input py-1 px-2 text-xs w-24 bg-white dark:bg-pancake-cardDark" placeholder="Ï∂îÍ∞Ä...">
                                        <button type="button" id="add-ledger-minor-category-btn" class="bg-pancake-cyan text-white rounded px-2 font-bold">+</button>
                                    </div>
                                </div>
                                <div id="ledger-minor-category-container" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark ml-1 mb-1 block">Î©îÎ™®</label>
                            <input type="text" id="ledger-memo" class="pc-input" placeholder="ÎÇ¥Ïö© ÏûÖÎ†•...">
                        </div>

                        <div class="pt-2 flex gap-3">
                            <button type="button" id="clear-ledger-form-btn" class="pc-btn pc-btn-secondary flex-1">Ï¥àÍ∏∞Ìôî</button>
                            <button type="submit" class="pc-btn pc-btn-primary flex-[2]">Ï†ÄÏû•ÌïòÍ∏∞</button>
                        </div>
                    </form>
                </div>

                <!-- Ledger Analysis -->
                <div id="ledger-analysis-view" class="hidden space-y-6">
                    <div class="pc-card p-4 flex flex-wrap justify-between items-center gap-4">
                         <div class="flex items-center gap-2">
                            <button id="ledger-analysis-prev-btn" class="p-2 hover:bg-pancake-input dark:hover:bg-pancake-inputDark rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span id="ledger-analysis-period-display" class="font-bold text-xl min-w-[120px] text-center"></span>
                            <button id="ledger-analysis-next-btn" class="p-2 hover:bg-pancake-input dark:hover:bg-pancake-inputDark rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <select id="ledger-analysis-filter-type" class="pc-input w-auto font-bold cursor-pointer">
                            <option value="month">ÏõîÎ≥Ñ Î≥¥Í∏∞</option>
                            <option value="quarter">Î∂ÑÍ∏∞Î≥Ñ Î≥¥Í∏∞</option>
                            <option value="year">Ïó∞ÎèÑÎ≥Ñ Î≥¥Í∏∞</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="pc-card p-4 text-center border-l-4 border-pancake-success">
                            <span class="text-xs font-bold text-pancake-success">ÏàòÏûÖ</span>
                            <p id="ledger-total-income" class="text-xl font-bold">0</p>
                        </div>
                        <div class="pc-card p-4 text-center border-l-4 border-pancake-failure">
                            <span class="text-xs font-bold text-pancake-failure">ÏßÄÏ∂ú</span>
                            <p id="ledger-total-expense" class="text-xl font-bold">0</p>
                        </div>
                        <div class="pc-card p-4 text-center border-l-4 border-pancake-cyan">
                            <span class="text-xs font-bold text-pancake-cyan">Ìï©Í≥Ñ (ÏûîÏï°)</span>
                            <p id="ledger-balance" class="text-xl font-bold">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="pc-card h-[300px]">
                            <h3 class="font-bold mb-2">ÏõîÎ≥Ñ Ï∂îÏù¥</h3>
                            <div class="relative h-56 w-full"><canvas id="ledger-monthly-pnl-chart"></canvas></div>
                        </div>
                        <div class="pc-card h-[300px]">
                            <h3 class="font-bold mb-2">ÏßÄÏ∂ú Íµ¨ÏÑ±</h3>
                            <div class="relative h-56 w-full"><canvas id="ledger-expense-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="pc-card p-4 lg:col-span-1 space-y-4">
                            <h3 class="font-bold">Top Ïπ¥ÌÖåÍ≥†Î¶¨</h3>
                            <div><span class="text-xs font-bold text-pancake-failure">ÏßÄÏ∂ú Top 5</span><div id="ledger-category-summary" class="mt-2 space-y-1"></div></div>
                            <div><span class="text-xs font-bold text-pancake-success">ÏàòÏûÖ Top 5</span><div id="ledger-income-summary" class="mt-2 space-y-1"></div></div>
                        </div>
                        <div class="pc-card p-4 lg:col-span-2">
                             <div class="flex justify-between items-center mb-4">
                                <h3 id="ledger-detail-title" class="font-bold">Ï†ÑÏ≤¥ ÎÇ¥Ïó≠</h3>
                            </div>
                            <div id="ledger-entry-details" class="space-y-2 max-h-[500px] overflow-y-auto pr-1"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Backdrop for all modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-pancake-dark bg-opacity-80 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>

    <!-- 1. Exit Modal -->
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden pointer-events-none">
        <div class="pc-card w-full max-w-sm m-4 pointer-events-auto shadow-2xl transform scale-95 transition-all opacity-0">
            <h2 class="text-xl font-bold mb-4">Ìè¨ÏßÄÏÖò Ï¢ÖÎ£å (Ï≤≠ÏÇ∞)</h2>
            <form id="exit-form" class="space-y-4">
                <input type="hidden" id="exit-journal-id">
                <div>
                    <label class="text-xs font-bold ml-1">ÎÇ†Ïßú</label>
                    <input type="date" id="exit-date" class="pc-input" required>
                </div>
                <div>
                    <label class="text-xs font-bold ml-1">Ï≤≠ÏÇ∞Í∞Ä</label>
                    <input type="text" id="exit-price" class="pc-input number-input" required>
                </div>
                <div>
                    <label class="text-xs font-bold ml-1" id="exit-quantity-label">ÏàòÎüâ</label>
                    <input type="text" id="exit-quantity" class="pc-input number-input" required>
                    <p class="text-xs text-right mt-1 opacity-70">ÎÇ®ÏùÄ ÏàòÎüâ: <span id="remaining-quantity" class="font-bold"></span></p>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal('exit-modal')" class="pc-btn pc-btn-secondary">Ï∑®ÏÜå</button>
                    <button type="submit" class="pc-btn pc-btn-primary">Ï†ÄÏû•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Memo Modal -->
    <div id="memo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden pointer-events-none">
        <div class="pc-card w-full max-w-md m-4 pointer-events-auto shadow-2xl transform scale-95 transition-all opacity-0">
            <h2 class="text-xl font-bold mb-4">Îß§Îß§ Î≥µÍ∏∞ Î©îÎ™®</h2>
            <form id="memo-form">
                <input type="hidden" id="memo-journal-id">
                <textarea id="memo-content" rows="6" class="pc-input resize-none" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('memo-modal')" class="pc-btn pc-btn-secondary">Îã´Í∏∞</button>
                    <button type="submit" class="pc-btn pc-btn-primary">Ï†ÄÏû•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden pointer-events-none">
        <div class="pc-card w-full max-w-xs m-4 text-center pointer-events-auto shadow-2xl transform scale-95 transition-all opacity-0">
            <div class="text-4xl mb-3">ü§î</div>
            <h2 class="text-lg font-bold mb-2">ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</h2>
            <p id="confirm-message" class="text-sm opacity-80 mb-6"></p>
            <div class="flex justify-center gap-2">
                <button type="button" onclick="closeModal('confirm-modal')" class="pc-btn pc-btn-secondary">Ï∑®ÏÜå</button>
                <button type="button" id="confirm-ok-btn" class="pc-btn pc-btn-danger">ÌôïÏù∏</button>
            </div>
        </div>
    </div>
    
    <!-- 4. Tag Edit Modal -->
    <div id="tag-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden pointer-events-none">
        <div class="pc-card w-full max-w-md m-4 pointer-events-auto shadow-2xl transform scale-95 transition-all opacity-0">
             <h2 class="text-xl font-bold mb-4">ÌÉúÍ∑∏ ÏàòÏ†ï</h2>
             <form id="tag-edit-form">
                 <input type="hidden" id="tag-edit-journal-id">
                 <div class="space-y-4">
                     <div><h3 class="text-xs font-bold text-pancake-warning mb-2">ÌôòÍ≤Ω ÌÉúÍ∑∏</h3><div id="tag-edit-environment-tags" class="flex flex-wrap gap-2"></div></div>
                     <div><h3 class="text-xs font-bold text-pancake-success mb-2">ÏßÑÏûÖ Í∑ºÍ±∞</h3><div id="tag-edit-entry-tags" class="flex flex-wrap gap-2"></div></div>
                     <div><h3 class="text-xs font-bold text-pancake-purple mb-2">Ïã¨Î¶¨ ÏÉÅÌÉú</h3><div id="tag-edit-psychology-tags" class="flex flex-wrap gap-2"></div></div>
                 </div>
                 <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal('tag-edit-modal')" class="pc-btn pc-btn-secondary">Ï∑®ÏÜå</button>
                    <button type="submit" class="pc-btn pc-btn-primary">Ï†ÄÏû•</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-pancake-cardDark text-white px-6 py-3 rounded-full shadow-xl translate-y-20 opacity-0 transition-all duration-300 font-bold z-[60] flex items-center border border-pancake-cyan pointer-events-none">
        <span class="mr-2 text-xl">ü•û</span><p id="toast-message" class="text-sm"></p>
    </div>

    <!-- Scripts -->
    <script>
        // --- Firebase Config (Existing) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDZm5AazCafB0Sb2gd0llv9e3GAhE-nKBw",
          authDomain: "sakurazima-mai-0u0.firebaseapp.com",
          projectId: "sakurazima-mai-0u0",
          storageBucket: "sakurazima-mai-0u0.appspot.com",
          messagingSenderId: "697666115735",
          appId: "1:697666115735:web:7380a588822f771dc071d2",
          measurementId: "G-TZQ9GVFWV5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const Timestamp = firebase.firestore.Timestamp;

        // --- App State ---
        let currentUser = null;
        let charts = {};
        let confirmCallback = null;
        
        let unsubscribeJournals = null, unsubscribeTags = null;
        let localJournals = [], localTags = { environment: [], entry: [], psychology: [] }; 
        let localFuturesInfo = {}; 
        let unsubscribeFuturesInfo = null;
        let statsCurrency = 'KRW', exchangeRate = 1380;
        
        let unsubscribeLedger = null, unsubscribeLedgerCategories = null;
        let localLedgerEntries = [];
        let localLedgerCategories = { expense: {}, income: {} }; 
        let selectedMajorCategory = null; 
        let ledgerAnalysisDate = new Date();

        // --- UI Logic ---
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(e => showToast("Î°úÍ∑∏Ïù∏ Ïã§Ìå®: " + e.message, "error")));
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('auth-info').textContent = user.email; 
                initializeAppFunctionality();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeJournals) unsubscribeJournals();
                if (unsubscribeTags) unsubscribeTags();
                if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
                if (unsubscribeLedger) unsubscribeLedger();
                if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
                Object.values(charts).forEach(c => c && c.destroy());
                charts = {};
            }
            lucide.createIcons();
        });
        
        // --- Initialization ---
        async function initializeAppFunctionality() {
            if (!currentUser) return;
            const userId = currentUser.uid;
            
            // Default Data Checks
            const tagsRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            const tagsSnap = await tagsRef.get();
            if(!tagsSnap.exists) await tagsRef.set({ environment: ['Í∞úÏû• ÏßÅÌõÑ', 'Î≥ÄÎèôÏÑ± ÌôïÎåÄ', 'FOMC'], entry: ['Ï†ïÎ∞∞Ïó¥', 'ÏßÄÏßÄÏÑ†', 'Í≥ºÎß§ÎèÑ'], psychology: ['ÎáåÎèôÎß§Îß§', 'Î≥µÏàòÏã¨', 'Ï∞®Î∂ÑÌï®'] });
            
            const futuresRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            const futuresSnap = await futuresRef.get();
            if(!futuresSnap.exists) await futuresRef.set({'BTC': {tickValue:1, tickSize:0.1}, 'ETH': {tickValue:1, tickSize:0.01}});
            
            const ledgerRef = db.collection("users").doc(userId).collection("ledgerData").doc("categories");
            const ledgerSnap = await ledgerRef.get();
            if(!ledgerSnap.exists) await ledgerRef.set({ expense: {'ÏãùÎπÑ':[], 'ÍµêÌÜµÎπÑ':[]}, income: {'ÏõîÍ∏â':[]} });

            attachJournalListeners(userId);
            attachLedgerListeners(userId);
            resetForm();
            resetLedgerForm();
        }

        function attachJournalListeners(userId) {
            if(unsubscribeJournals) unsubscribeJournals();
            unsubscribeJournals = db.collection("users").doc(userId).collection("journals").orderBy("date", "desc")
                .onSnapshot(snap => {
                    localJournals = snap.docs.map(d => ({id: d.id, ...d.data(), date: d.data().date.toDate()}));
                    renderJournals(localJournals);
                    renderJournalStats(localJournals);
                });

            if(unsubscribeTags) unsubscribeTags();
            unsubscribeTags = db.collection("users").doc(userId).collection("journalTags").doc("all")
                .onSnapshot(doc => {
                    if(doc.exists) {
                        localTags = doc.data();
                        renderJournalTags(localTags.environment, 'environment-tags-container', 'environment');
                        renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
                        renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
                        renderJournalStats(localJournals); // Re-render stats when tags change
                    }
                });

            if(unsubscribeFuturesInfo) unsubscribeFuturesInfo();
            unsubscribeFuturesInfo = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo")
                .onSnapshot(doc => { localFuturesInfo = doc.exists ? doc.data() : {}; renderFuturesInfoSelect(); });
        }
        
        function attachLedgerListeners(userId) {
            if(unsubscribeLedger) unsubscribeLedger();
            unsubscribeLedger = db.collection("users").doc(userId).collection("ledgerEntries").orderBy("date", "desc")
                .onSnapshot(snap => {
                    localLedgerEntries = snap.docs.map(d => ({id: d.id, ...d.data(), date: d.data().date.toDate()}));
                    renderLedgerAnalysisView();
                });
            
            if(unsubscribeLedgerCategories) unsubscribeLedgerCategories();
            unsubscribeLedgerCategories = db.collection("users").doc(userId).collection("ledgerData").doc("categories")
                .onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        localLedgerCategories = Array.isArray(d.expense) ? {expense:{}, income:{}} : d; // Simple migration
                    }
                    const activeType = document.querySelector('[data-group="ledger-type"] .selected').dataset.value;
                    renderLedgerMajorCategories(activeType);
                });
        }

        // --- View Switching ---
        document.querySelectorAll('[data-main-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pc-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const t = btn.dataset.mainTab;
                document.getElementById('journal-container').classList.toggle('hidden', t !== 'journal-container');
                document.getElementById('ledger-container').classList.toggle('hidden', t !== 'ledger-container');
                if(t === 'journal-container') renderJournalStats(localJournals);
                if(t === 'ledger-container') renderLedgerAnalysisView();
            });
        });

        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const t = btn.dataset.tab;
                document.querySelectorAll('#journal-container [data-tab]').forEach(b => {
                     b.classList.remove('pc-btn-primary'); b.classList.add('pc-btn-secondary');
                     b.style.backgroundColor = ''; b.style.color = '';
                });
                btn.classList.remove('pc-btn-secondary'); btn.classList.add('pc-btn-primary');
                
                ['form-view', 'list-view', 'stats-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== t));
                if(t === 'stats-view') renderJournalStats(localJournals);
            });
        });
        
        document.querySelectorAll('[data-ledger-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const t = btn.dataset.ledgerTab;
                 document.querySelectorAll('#ledger-container [data-ledger-tab]').forEach(b => {
                     b.classList.remove('pc-btn-primary'); b.classList.add('pc-btn-secondary');
                });
                btn.classList.remove('pc-btn-secondary'); btn.classList.add('pc-btn-primary');
                ['ledger-form-view', 'ledger-analysis-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== t));
                if(t === 'ledger-analysis-view') renderLedgerAnalysisView();
            });
        });

        // --- Journal Logic ---
        // Asset Type Toggle
        document.querySelectorAll('[data-group="asset-type"] button').forEach(btn => {
            btn.addEventListener('click', () => {
                const isSpot = btn.dataset.value === 'spot';
                document.getElementById('spot-fields').classList.toggle('hidden', !isSpot);
                document.getElementById('futures-contracts-field').classList.toggle('hidden', isSpot);
                document.getElementById('futures-fields').classList.toggle('hidden', isSpot);
                
                // Required toggle logic
                document.getElementById('quantity').required = isSpot;
                document.getElementById('contracts').required = !isSpot;
            });
        });
        
        // Futures Info Select
        function renderFuturesInfoSelect() {
            const sel = document.getElementById('futures-info-select');
            sel.innerHTML = '<option value="">Ï¢ÖÎ™© ÏÑ†ÌÉù</option>';
            Object.keys(localFuturesInfo).sort().forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.text = k; sel.add(opt);
            });
            sel.onchange = (e) => {
                const info = localFuturesInfo[e.target.value];
                const ticker = document.getElementById('ticker');
                if(info) {
                    ticker.value = e.target.value;
                    document.getElementById('tick-value').value = formatNumber(info.tickValue);
                    document.getElementById('tick-size').value = formatNumber(info.tickSize);
                    document.getElementById('delete-futures-info-btn').disabled = false;
                }
            };
        }
        document.getElementById('save-futures-info-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.toUpperCase();
            if(!ticker) return showToast("Ï¢ÖÎ™©Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî", "error");
            const v = parseFloat(unformatNumber(document.getElementById('tick-value').value));
            const s = parseFloat(unformatNumber(document.getElementById('tick-size').value));
            if(!v || !s) return showToast("Ìã±Í∞ÄÏπò/Îã®ÏúÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî", "error");
            await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").update({[ticker]:{tickValue:v, tickSize:s}});
            showToast("Ï†ïÎ≥¥ Ï†ÄÏû•Îê®");
        });

        // Rendering Journals
        function calculatePnl(j, exit) {
            const diff = j.position === 'long' ? (exit.price - j.entryPrice) : (j.entryPrice - exit.price);
            if(j.assetType === 'futures') return (diff / j.tickSize) * j.tickValue * exit.quantity;
            return diff * exit.quantity;
        }

        function renderJournals(list) {
            const container = document.getElementById('journal-list'); container.innerHTML = '';
            if(!list.length) { container.innerHTML = '<div class="col-span-full text-center py-10 opacity-50 font-bold">ÏûëÏÑ±Îêú ÏùºÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§ ü•û</div>'; return; }
            
            list.forEach(j => {
                const isSpot = j.assetType === 'spot';
                const totalQ = isSpot ? j.quantity : (j.contracts || 0);
                const exitedQ = (j.exits || []).reduce((a,b) => a + b.quantity, 0);
                const isClosed = Math.abs(totalQ - exitedQ) < 1e-9;
                
                let pnl = 0; (j.exits||[]).forEach(e => pnl += calculatePnl(j, e));
                const pnlKrw = j.currency === 'USD' ? pnl * exchangeRate : pnl;
                
                const card = document.createElement('div');
                card.className = `pc-card p-4 relative overflow-hidden border-l-4 ${isClosed ? (pnlKrw >= 0 ? 'border-l-pancake-success' : 'border-l-pancake-failure') : 'border-l-pancake-warning'}`;
                
                const tags = [...(j.environmentTags||[]), ...(j.entryTags||[]), ...(j.psychologyTags||[])].slice(0,5);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold text-gray-400">${j.date.toLocaleDateString()}</span>
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-bold">${j.ticker}</h3>
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full ${j.position==='long'?'bg-green-100 text-green-700':'bg-pink-100 text-pink-700'}">${j.position.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            ${!isClosed ? `<button class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-pancake-cyan exit-btn" data-id="${j.id}" title="Ï≤≠ÏÇ∞"><i data-lucide="log-out" class="w-4 h-4"></i></button>`:''}
                            <button class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-400 edit-btn" data-id="${j.id}" title="ÏàòÏ†ï"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-pancake-failure delete-btn" data-id="${j.id}" title="ÏÇ≠Ï†ú"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 text-sm gap-y-1 mb-3">
                        <div class="text-gray-500 dark:text-gray-400">ÏßÑÏûÖ: <span class="font-bold text-pancake-text dark:text-white">${formatPrice(j.entryPrice, j.currency)}</span></div>
                        <div class="text-gray-500 dark:text-gray-400">ÏàòÎüâ: <span class="font-bold text-pancake-text dark:text-white">${formatNumber(totalQ)}</span></div>
                        ${(j.exits||[]).length ? `<div class="col-span-2 mt-1 font-bold ${pnlKrw>=0?'text-pancake-success':'text-pancake-failure'}">ÏÜêÏùµ: ${formatDualCurrency(pnlKrw, j.currency)}</div>` : ''}
                    </div>

                    <div class="flex flex-wrap gap-1 mb-3">
                        ${tags.map(t => `<span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">#${t}</span>`).join('')}
                    </div>

                    <div class="flex justify-between border-t border-gray-100 dark:border-gray-700 pt-2">
                        <button class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark hover:text-pancake-cyan flex items-center gap-1 memo-btn" data-id="${j.id}">
                            <i data-lucide="message-square" class="w-3 h-3 ${j.memo?'text-pancake-cyan':''}"></i> Î©îÎ™®
                        </button>
                        <button class="text-xs font-bold text-pancake-textSub dark:text-pancake-textSubDark hover:text-pancake-purple flex items-center gap-1 tag-btn" data-id="${j.id}">
                            <i data-lucide="tag" class="w-3 h-3"></i> ÌÉúÍ∑∏
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
            
            document.querySelectorAll('.exit-btn').forEach(b => b.addEventListener('click', e => openExitModal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', e => loadJournalToForm(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e => confirmDelete(e.currentTarget.dataset.id, 'journal')));
            document.querySelectorAll('.memo-btn').forEach(b => b.addEventListener('click', e => openMemoModal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.tag-btn').forEach(b => b.addEventListener('click', e => openTagModal(e.currentTarget.dataset.id)));
        }

        // --- Ledger Logic ---
        function renderLedgerMajorCategories(type) {
            const container = document.getElementById('ledger-major-category-container'); container.innerHTML = '';
            const cats = Object.keys(localLedgerCategories[type]||{}).sort();
            cats.forEach(c => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `px-3 py-1.5 rounded-xl text-xs font-bold transition border border-transparent ${selectedMajorCategory===c ? 'bg-pancake-purple text-white shadow-md' : 'bg-white dark:bg-pancake-dark text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700'}`;
                btn.innerHTML = c;
                btn.onclick = () => {
                    selectedMajorCategory = (selectedMajorCategory===c) ? null : c;
                    renderLedgerMajorCategories(type);
                    if(selectedMajorCategory) renderLedgerMinorCategories(type, c);
                    else document.getElementById('ledger-minor-category-wrapper').classList.add('hidden');
                };
                container.appendChild(btn);
            });
        }
        
        function renderLedgerMinorCategories(type, major) {
             const wrapper = document.getElementById('ledger-minor-category-wrapper');
             wrapper.classList.remove('hidden');
             document.getElementById('selected-major-name').textContent = major;
             const container = document.getElementById('ledger-minor-category-container'); container.innerHTML = '';
             (localLedgerCategories[type][major]||[]).forEach(sub => {
                 const btn = document.createElement('button');
                 btn.type = 'button';
                 btn.className = `px-3 py-1 rounded-lg text-xs font-medium border transition bg-white dark:bg-pancake-dark text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:border-pancake-cyan`;
                 btn.textContent = sub;
                 btn.onclick = () => {
                     document.querySelectorAll('#ledger-minor-category-container button').forEach(b=>b.classList.remove('border-pancake-cyan', 'text-pancake-cyan', 'selected-minor'));
                     btn.classList.add('border-pancake-cyan', 'text-pancake-cyan', 'selected-minor');
                 };
                 container.appendChild(btn);
             });
        }
        
        document.getElementById('add-ledger-major-category-btn').addEventListener('click', async () => {
             const type = document.querySelector('[data-group="ledger-type"] .selected').dataset.value;
             const val = document.getElementById('new-ledger-major-category').value.trim();
             if(val && !localLedgerCategories[type][val]) {
                 localLedgerCategories[type][val] = [];
                 await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").set(localLedgerCategories);
                 document.getElementById('new-ledger-major-category').value = '';
             }
        });
        
        document.getElementById('add-ledger-minor-category-btn').addEventListener('click', async () => {
             const type = document.querySelector('[data-group="ledger-type"] .selected').dataset.value;
             const val = document.getElementById('new-ledger-minor-category').value.trim();
             if(val && selectedMajorCategory) {
                 localLedgerCategories[type][selectedMajorCategory].push(val);
                 await db.collection("users").doc(currentUser.uid).collection("ledgerData").doc("categories").set(localLedgerCategories);
                 document.getElementById('new-ledger-minor-category').value = '';
                 renderLedgerMinorCategories(type, selectedMajorCategory);
             }
        });
        
        // Ledger List & Analysis
        function renderLedgerAnalysisView() {
            // Simplified Filter Logic
            const filter = document.getElementById('ledger-analysis-filter-type').value;
            const d = ledgerAnalysisDate; 
            let start, end, label;
            
            if(filter === 'month') {
                start = new Date(d.getFullYear(), d.getMonth(), 1); end = new Date(d.getFullYear(), d.getMonth()+1, 0, 23, 59, 59);
                label = `${d.getFullYear()}ÎÖÑ ${d.getMonth()+1}Ïõî`;
            } else if (filter === 'year') {
                start = new Date(d.getFullYear(), 0, 1); end = new Date(d.getFullYear(), 11, 31, 23, 59, 59);
                label = `${d.getFullYear()}ÎÖÑ`;
            } else { // Quarter
                 const q = Math.floor(d.getMonth()/3);
                 start = new Date(d.getFullYear(), q*3, 1); end = new Date(d.getFullYear(), (q+1)*3, 0, 23, 59, 59);
                 label = `${d.getFullYear()}ÎÖÑ ${q+1}Î∂ÑÍ∏∞`;
            }
            document.getElementById('ledger-analysis-period-display').textContent = label;
            
            const entries = localLedgerEntries.filter(e => e.date >= start && e.date <= end);
            
            // Calc Totals
            let inc = 0, exp = 0;
            const expCat = {}, incCat = {};
            entries.forEach(e => {
                if(e.type === 'income') { inc += e.amount; incCat[e.category] = (incCat[e.category]||0) + e.amount; }
                else { exp += e.amount; expCat[e.category] = (expCat[e.category]||0) + e.amount; }
            });
            
            document.getElementById('ledger-total-income').textContent = formatPrice(inc, 'KRW');
            document.getElementById('ledger-total-expense').textContent = formatPrice(exp, 'KRW');
            document.getElementById('ledger-balance').textContent = formatPrice(inc - exp, 'KRW');
            
            // List
            const listEl = document.getElementById('ledger-entry-details'); listEl.innerHTML = '';
            if(entries.length === 0) listEl.innerHTML = '<p class="text-center text-gray-400 py-4">ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';

            entries.sort((a,b)=>b.date-a.date).forEach(e => {
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-pancake-dark rounded-xl transition cursor-pointer group';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg ${e.type==='income'?'bg-green-100':'bg-pink-100'}">${e.type==='income'?'üí∞':'üí∏'}</div>
                        <div>
                            <div class="font-bold text-sm text-pancake-text dark:text-white">${e.category} <span class="text-xs font-normal opacity-70">${e.subCategory||''}</span></div>
                            <div class="text-xs text-gray-500">${e.date.toLocaleDateString()} ${e.memo?'- '+e.memo:''}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${e.type==='income'?'text-pancake-success':'text-pancake-failure'}">${e.type==='income'?'+':'-'} ${formatPrice(e.amount, 'KRW')}</div>
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                            <i data-lucide="edit-2" class="w-3 h-3 text-gray-400 cursor-pointer" onclick="editLedger('${e.id}')"></i>
                            <i data-lucide="trash-2" class="w-3 h-3 text-pancake-failure cursor-pointer" onclick="deleteLedger('${e.id}')"></i>
                        </div>
                    </div>
                `;
                listEl.appendChild(row);
            });
            lucide.createIcons();
            
            // Charts (Simplified)
            updateLedgerCharts(entries, expCat, incCat);
            
            // Summary Lists
            const renderSum = (elId, obj) => {
                const el = document.getElementById(elId); el.innerHTML = '';
                Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([k,v]) => {
                    el.innerHTML += `<div class="flex justify-between text-xs"><span class="opacity-80">${k}</span><span class="font-bold">${formatPrice(v,'KRW')}</span></div>`;
                });
            };
            renderSum('ledger-category-summary', expCat);
            renderSum('ledger-income-summary', incCat);
        }

        function updateLedgerCharts(entries, expCat, incCat) {
             const chartColor = document.documentElement.classList.contains('dark') ? '#B8ADD2' : '#7A6EAA';
             // Bar Chart (Trend)
             const ctx1 = document.getElementById('ledger-monthly-pnl-chart').getContext('2d');
             if(charts['l1']) charts['l1'].destroy();
             const days = {}; entries.forEach(e => {
                 const k = e.date.getDate();
                 if(!days[k]) days[k] = {i:0, e:0};
                 if(e.type==='income') days[k].i += e.amount; else days[k].e += e.amount;
             });
             const labels = Object.keys(days).sort((a,b)=>a-b);
             charts['l1'] = new Chart(ctx1, {
                 type: 'bar',
                 data: {
                     labels,
                     datasets: [
                         {label:'ÏàòÏûÖ', data:labels.map(l=>days[l].i), backgroundColor:'#31D0AA', borderRadius:4},
                         {label:'ÏßÄÏ∂ú', data:labels.map(l=>days[l].e), backgroundColor:'#ED4B9E', borderRadius:4}
                     ]
                 },
                 options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}, ticks:{color:chartColor}}, y:{display:false}}, plugins:{legend:{display:false}}}
             });

             // Doughnut (Expense)
             const ctx2 = document.getElementById('ledger-expense-chart').getContext('2d');
             if(charts['l2']) charts['l2'].destroy();
             const eLabels = Object.keys(expCat);
             charts['l2'] = new Chart(ctx2, {
                 type: 'doughnut',
                 data: { labels: eLabels, datasets: [{data: Object.values(expCat), backgroundColor: ['#ED4B9E', '#FFB237', '#7645D9', '#1FC7D4'], borderWidth:0}] },
                 options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10, font:{size:10}, color:chartColor}}}}
             });
        }
        
        document.getElementById('ledger-analysis-prev-btn').addEventListener('click', () => { ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth()-1); renderLedgerAnalysisView(); });
        document.getElementById('ledger-analysis-next-btn').addEventListener('click', () => { ledgerAnalysisDate.setMonth(ledgerAnalysisDate.getMonth()+1); renderLedgerAnalysisView(); });
        
        // Ledger Actions
        window.deleteLedger = (id) => confirmDelete(id, 'ledger');
        window.editLedger = (id) => {
             const e = localLedgerEntries.find(x => x.id === id);
             if(!e) return;
             document.querySelector(`[data-ledger-tab="ledger-form-view"]`).click();
             document.getElementById('ledger-id').value = e.id;
             document.getElementById('ledger-date').value = e.date.toISOString().split('T')[0];
             document.getElementById('ledger-amount').value = formatNumber(e.amount);
             document.getElementById('ledger-memo').value = e.memo || '';
             document.querySelector(`[data-group="ledger-type"] button[data-value="${e.type}"]`).click();
        };
        
        document.getElementById('ledger-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('ledger-id').value;
            const type = document.querySelector('[data-group="ledger-type"] .selected').dataset.value;
            const amount = parseFloat(unformatNumber(document.getElementById('ledger-amount').value));
            const sub = document.querySelector('#ledger-minor-category-container .selected-minor')?.textContent;
            
            if(!selectedMajorCategory) return showToast("Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî", "error");
            
            const data = {
                type, date: Timestamp.fromDate(new Date(document.getElementById('ledger-date').value)),
                amount, category: selectedMajorCategory, subCategory: sub,
                memo: document.getElementById('ledger-memo').value
            };
            
            if(id) await db.collection("users").doc(currentUser.uid).collection("ledgerEntries").doc(id).update(data);
            else await db.collection("users").doc(currentUser.uid).collection("ledgerEntries").add(data);
            showToast("Ï†ÄÏû• ÏôÑÎ£å!");
            resetLedgerForm();
        });

        // --- Common Helpers ---
        function resetForm() {
            document.getElementById('journal-form').reset();
            document.getElementById('journal-id').value = '';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.querySelector('[data-group="asset-type"] button[data-value="spot"]').click();
            document.querySelector('[data-group="position"] button[data-value="long"]').click();
            document.querySelector('#form-currency-usd-btn').click();
            ['environment', 'entry', 'psychology'].forEach(t => document.getElementById(`${t}-tags-container`).innerHTML = '');
            // Restore tags
            renderJournalTags(localTags.environment, 'environment-tags-container', 'environment');
            renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
            renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
        }
        
        function resetLedgerForm() {
            document.getElementById('ledger-form').reset();
            document.getElementById('ledger-id').value = '';
            document.getElementById('ledger-date').value = new Date().toISOString().split('T')[0];
            selectedMajorCategory = null;
            renderLedgerMajorCategories('expense'); // Default
            document.getElementById('ledger-minor-category-wrapper').classList.add('hidden');
        }
        
        function renderJournalTags(tags, id, type) {
            const el = document.getElementById(id); el.innerHTML = '';
            (tags||[]).forEach(t => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'tag tag-default';
                btn.textContent = t;
                btn.onclick = () => {
                    const selectedClass = type === 'environment' ? 'selected-environment' : (type === 'entry' ? 'selected-entry' : 'selected-psychology');
                    btn.classList.toggle('tag-default');
                    btn.classList.toggle(selectedClass);
                };
                el.appendChild(btn);
            });
        }
        
        // --- Modals ---
        function openModal(id) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-backdrop').classList.remove('opacity-0'), 10);
            const m = document.getElementById(id); m.classList.remove('hidden');
            setTimeout(() => { m.firstElementChild.classList.remove('scale-95', 'opacity-0'); m.firstElementChild.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        window.closeModal = (id) => {
            const m = document.getElementById(id);
            m.firstElementChild.classList.remove('scale-100', 'opacity-100'); m.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { m.classList.add('hidden'); checkBackdrop(); }, 200);
        };
        function checkBackdrop() {
            if(document.querySelectorAll('.fixed.z-50:not(.hidden)').length === 0) {
                 const bd = document.getElementById('modal-backdrop');
                 bd.classList.add('opacity-0'); setTimeout(() => bd.classList.add('hidden'), 200);
            }
        }
        
        // --- Specific Modal Logics ---
        function openExitModal(id) {
             const j = localJournals.find(x=>x.id===id); if(!j) return;
             document.getElementById('exit-journal-id').value = id;
             const total = j.assetType==='spot' ? j.quantity : j.contracts;
             const exited = (j.exits||[]).reduce((a,b)=>a+b.quantity,0);
             document.getElementById('remaining-quantity').textContent = formatNumber(total - exited);
             document.getElementById('exit-date').value = new Date().toISOString().split('T')[0];
             openModal('exit-modal');
        }
        document.getElementById('exit-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const id = document.getElementById('exit-journal-id').value;
            const p = parseFloat(unformatNumber(document.getElementById('exit-price').value));
            const q = parseFloat(unformatNumber(document.getElementById('exit-quantity').value));
            const d = Timestamp.fromDate(new Date(document.getElementById('exit-date').value));
            const j = localJournals.find(x=>x.id===id);
            await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).update({ exits: [...(j.exits||[]), {price:p, quantity:q, date:d}] });
            closeModal('exit-modal'); showToast("Ï≤≠ÏÇ∞ Í∏∞Î°ù Ï†ÄÏû•Îê®");
        });
        
        function loadJournalToForm(id) {
            const j = localJournals.find(x=>x.id===id); if(!j) return;
            document.querySelector('[data-tab="form-view"]').click();
            document.getElementById('journal-id').value = j.id;
            document.getElementById('ticker').value = j.ticker;
            document.getElementById('date').value = j.date.toISOString().split('T')[0];
            document.getElementById('entry-price').value = formatNumber(j.entryPrice);
            document.getElementById('stop-loss').value = formatNumber(j.stopLoss);
            document.getElementById('target-price').value = formatNumber(j.targetPrice);
            
            // Toggle groups
            ['asset-type', 'position', 'strategy', 'form-currency'].forEach(grp => {
                let val = j.assetType; // default
                if(grp === 'position') val = j.position;
                if(grp === 'strategy') val = j.strategy;
                if(grp === 'form-currency') val = j.currency === 'USD' ? 'usd' : 'krw'; // map
                if(grp === 'asset-type') val = j.assetType;
                
                const btn = document.querySelector(`[data-group="${grp}"] button[data-value="${val}"]`) || 
                            document.querySelector(`[data-group="${grp}"] button[id*="${val}"]`);
                if(btn) btn.click();
            });
            
            if(j.assetType === 'spot') document.getElementById('quantity').value = formatNumber(j.quantity);
            else document.getElementById('contracts').value = formatNumber(j.contracts);
            
            // Restore Tags (Visual)
            const restoreTags = (tags, containerId, type) => {
                const container = document.getElementById(containerId);
                const selectedClass = type === 'environment' ? 'selected-environment' : (type === 'entry' ? 'selected-entry' : 'selected-psychology');
                Array.from(container.children).forEach(btn => {
                    if (tags.includes(btn.textContent)) {
                        btn.classList.remove('tag-default');
                        btn.classList.add(selectedClass);
                    } else {
                        btn.classList.add('tag-default');
                        btn.classList.remove(selectedClass);
                    }
                });
            };
            restoreTags(j.environmentTags||[], 'environment-tags-container', 'environment');
            restoreTags(j.entryTags||[], 'entry-tags-container', 'entry');
            restoreTags(j.psychologyTags||[], 'psychology-tags-container', 'psychology');

            showToast("ÏàòÏ†ï Î™®ÎìúÎ°ú Î∂àÎü¨Ïò¥");
        }
        
        // Add Journal Tag Helpers
        async function addJournalTag(type, val) {
             const key = type === 'environment' ? 'environment' : (type === 'entry' ? 'entry' : 'psychology');
             if(!localTags[key].includes(val)) {
                 localTags[key].push(val);
                 await db.collection("users").doc(currentUser.uid).collection("journalTags").doc("all").set(localTags);
                 renderJournalTags(localTags[key], `${key}-tags-container`, key);
             }
        }
        document.querySelector('.add-environment-tag-btn').addEventListener('click', () => { const v = document.getElementById('new-environment-tag').value; if(v) addJournalTag('environment', v); });
        document.querySelector('.add-entry-tag-btn').addEventListener('click', () => { const v = document.getElementById('new-entry-tag').value; if(v) addJournalTag('entry', v); });
        document.querySelector('.add-psychology-tag-btn').addEventListener('click', () => { const v = document.getElementById('new-psychology-tag').value; if(v) addJournalTag('psychology', v); });
        
        // Journal Submit Logic (Updated for Fusion Form)
        document.getElementById('journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('journal-id').value;
            const assetType = document.querySelector('[data-group="asset-type"] .selected').dataset.value;
            const position = document.querySelector('[data-group="position"] .selected').dataset.value;
            const strategy = document.querySelector('[data-group="strategy"] .selected').dataset.value;
            const isUsd = document.querySelector('[data-group="form-currency"] .selected').id.includes('usd');
            
            // Get Tags
            const getTags = (id, cls) => Array.from(document.querySelectorAll(`#${id} .${cls}`)).map(b => b.textContent);
            const envTags = getTags('environment-tags-container', 'selected-environment');
            const entryTags = getTags('entry-tags-container', 'selected-entry');
            const psyTags = getTags('psychology-tags-container', 'selected-psychology');

            const data = {
                ticker: document.getElementById('ticker').value.toUpperCase(),
                date: Timestamp.fromDate(new Date(document.getElementById('date').value)),
                assetType, position, strategy,
                currency: isUsd ? 'USD' : 'KRW',
                entryPrice: parseFloat(unformatNumber(document.getElementById('entry-price').value)),
                targetPrice: parseFloat(unformatNumber(document.getElementById('target-price').value)),
                stopLoss: parseFloat(unformatNumber(document.getElementById('stop-loss').value)),
                environmentTags: envTags, entryTags: entryTags, psychologyTags: psyTags
            };
            
            if(assetType === 'spot') data.quantity = parseFloat(unformatNumber(document.getElementById('quantity').value));
            else {
                data.contracts = parseFloat(unformatNumber(document.getElementById('contracts').value));
                data.tickValue = parseFloat(unformatNumber(document.getElementById('tick-value').value));
                data.tickSize = parseFloat(unformatNumber(document.getElementById('tick-size').value));
            }
            
            if(id) {
                const old = localJournals.find(x=>x.id===id);
                await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).update({...data, exits: old.exits||[]});
            } else {
                await db.collection("users").doc(currentUser.uid).collection("journals").add({...data, exits: []});
            }
            showToast("ÏùºÏßÄ Ï†ÄÏû• ÏôÑÎ£å!");
            resetForm();
        });

        function confirmDelete(id, type) {
            showConfirmModal("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", async () => {
                const col = type === 'journal' ? 'journals' : 'ledgerEntries';
                await db.collection("users").doc(currentUser.uid).collection(col).doc(id).delete();
                showToast("ÏÇ≠Ï†ú ÏôÑÎ£å");
            });
        }
        function showConfirmModal(msg, cb) {
            document.getElementById('confirm-message').textContent = msg;
            document.getElementById('confirm-ok-btn').onclick = () => { cb(); closeModal('confirm-modal'); };
            openModal('confirm-modal');
        }

        // --- Utils ---
        const unformatNumber = v => v?v.toString().replace(/,/g,''):'';
        const formatNumber = v => v==null?'':unformatNumber(v).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');
        const formatPrice = (v, c) => c==='USD' ? `$${parseFloat(v).toLocaleString(undefined,{maximumFractionDigits:2})}` : `‚Ç©${parseFloat(v).toLocaleString()}`;
        const formatDualCurrency = (krw, cur) => cur==='KRW' ? `${formatPrice(krw,'KRW')} (${formatPrice(krw/exchangeRate,'USD')})` : `${formatPrice(krw/exchangeRate,'USD')} (${formatPrice(krw,'KRW')})`;
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.lastElementChild.textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        
        // --- Init Listeners ---
        document.querySelectorAll('.number-input').forEach(i => i.addEventListener('input', e => e.target.value = formatNumber(e.target.value)));
        
        // Toggle Logic
        document.addEventListener('click', e => {
            const btn = e.target.closest('.pc-toggle-btn');
            if(btn) {
                btn.parentElement.querySelectorAll('.pc-toggle-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                if(btn.parentElement.dataset.group === 'ledger-type') renderLedgerMajorCategories(btn.dataset.value);
            }
        });
        
        // --- Enhanced Stats Logic (Fixed & Tag Based) ---
        function renderJournalStats(list) {
             const completed = list.filter(j => {
                 const total = j.assetType==='spot' ? j.quantity : j.contracts;
                 const exited = (j.exits||[]).reduce((a,b)=>a+b.quantity,0);
                 return (j.exits||[]).length > 0 && Math.abs(total-exited) < 1e-9;
             });

             // 1. Basic Stats
             const wins = completed.filter(j => (j.exits||[]).reduce((a,b)=>a+calculatePnl(j,b),0) > 0).length;
             document.getElementById('total-win-rate').textContent = completed.length ? `${((wins/completed.length)*100).toFixed(0)}%` : '0%';
             
             let totalPnl = 0;
             completed.forEach(j => {
                 let p = 0; (j.exits||[]).forEach(e => p += calculatePnl(j, e));
                 totalPnl += (j.currency==='USD' ? p*exchangeRate : p);
             });
             // Convert PnL to Selected Stats Currency
             const isStatsUsd = document.querySelector('[data-group="stats-currency"] .selected').id.includes('usd');
             const displayPnl = isStatsUsd ? totalPnl/exchangeRate : totalPnl;
             document.getElementById('total-realized-pnl').textContent = formatPrice(displayPnl, isStatsUsd?'USD':'KRW');

             // 2. Tag Stats Helpers
             const calcTagWinRate = (tagList, tagTypeKey) => {
                 let html = '';
                 tagList.forEach(tag => {
                     const relevant = completed.filter(j => (j[tagTypeKey]||[]).includes(tag));
                     if(relevant.length > 0) {
                         const w = relevant.filter(j => (j.exits||[]).reduce((a,b)=>a+calculatePnl(j,b),0) > 0).length;
                         const rate = ((w/relevant.length)*100).toFixed(0);
                         let color = rate >= 50 ? 'text-pancake-success' : 'text-pancake-failure';
                         html += `<div class="flex justify-between text-xs px-2 py-1 bg-gray-50 dark:bg-pancake-inputDark rounded"><span class="font-medium">${tag} (${relevant.length})</span><span class="font-bold ${color}">${rate}%</span></div>`;
                     }
                 });
                 return html || '<p class="text-xs text-center opacity-50">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</p>';
             };
             
             document.getElementById('env-tag-stats').innerHTML = calcTagWinRate(localTags.environment, 'environmentTags');
             document.getElementById('entry-tag-stats').innerHTML = calcTagWinRate(localTags.entry, 'entryTags');
             document.getElementById('psy-tag-stats').innerHTML = calcTagWinRate(localTags.psychology, 'psychologyTags');

             // 3. Charts
             updateJournalCharts(completed, isStatsUsd);
        }

        function updateJournalCharts(completed, isUsd) {
             const chartColor = document.documentElement.classList.contains('dark') ? '#B8ADD2' : '#7A6EAA';
             const pnlMult = isUsd ? 1/exchangeRate : 1;

             // PnL Composition
             let winSum = 0, loseSum = 0;
             completed.forEach(j => {
                 let p = 0; (j.exits||[]).forEach(e => p += calculatePnl(j,e));
                 const val = (j.currency==='USD' ? p*exchangeRate : p) * pnlMult;
                 if(val > 0) winSum += val; else loseSum += Math.abs(val);
             });
             
             const ctx1 = document.getElementById('pnl-composition-chart').getContext('2d');
             if(charts['j1']) charts['j1'].destroy();
             charts['j1'] = new Chart(ctx1, {
                 type: 'doughnut',
                 data: { labels: ['ÏàòÏùµ', 'ÏÜêÏã§'], datasets: [{ data: [winSum, loseSum], backgroundColor: ['#31D0AA', '#ED4B9E'], borderWidth: 0 }] },
                 options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'right', labels: { color: chartColor, boxWidth: 10 } } } }
             });

             // Monthly Trend (Fixed: Dynamic Month)
             const ctx2 = document.getElementById('monthly-pnl-chart').getContext('2d');
             if(charts['j2']) charts['j2'].destroy();
             
             const months = {};
             completed.forEach(j => {
                 const m = `${j.date.getFullYear()}-${String(j.date.getMonth()+1).padStart(2,'0')}`;
                 let p = 0; (j.exits||[]).forEach(e => p += calculatePnl(j,e));
                 const val = (j.currency==='USD' ? p*exchangeRate : p) * pnlMult;
                 months[m] = (months[m]||0) + val;
             });
             
             const sortedMonths = Object.keys(months).sort();
             charts['j2'] = new Chart(ctx2, {
                 type: 'bar',
                 data: { 
                     labels: sortedMonths, 
                     datasets: [{ 
                         label: 'ÏÜêÏùµ', 
                         data: sortedMonths.map(m => months[m]), 
                         backgroundColor: sortedMonths.map(m => months[m] >= 0 ? '#31D0AA' : '#ED4B9E'),
                         borderRadius: 4
                     }] 
                 },
                 options: { 
                     responsive:true, maintainAspectRatio:false, 
                     scales: { x: { ticks: { color: chartColor }, grid: { display: false } }, y: { ticks: { color: chartColor }, grid: { color: document.documentElement.classList.contains('dark')?'#333':'#eee' } } },
                     plugins: { legend: { display: false } }
                 }
             });
             
             // Summary Text
             const sumHtml = sortedMonths.map(m => `<span class="mx-2">${m}: <span class="${months[m]>=0?'text-pancake-success':'text-pancake-failure'} font-bold">${formatPrice(months[m], isUsd?'USD':'KRW')}</span></span>`).join('');
             document.getElementById('monthly-pnl-summary').innerHTML = sumHtml || 'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.';
        }
        
        // Listener for Stats Currency Toggle
        document.querySelectorAll('[data-group="stats-currency"] button').forEach(b => {
            b.addEventListener('click', () => {
                setTimeout(() => renderJournalStats(localJournals), 50); // wait for toggle class update
            });
        });

        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('sun-icon').classList.toggle('hidden');
            document.getElementById('moon-icon').classList.toggle('hidden');
            if(currentUser) {
                renderJournalStats(localJournals);
                renderLedgerAnalysisView();
            }
        });
        
        // Modal Tag Edit Form open helper
        function openTagModal(id) {
            const j = localJournals.find(x=>x.id===id); if(!j) return;
            document.getElementById('tag-edit-journal-id').value = id;
            const createTagBtn = (t, type, selected) => {
                const b = document.createElement('button'); b.type='button';
                b.className = `tag ${selected?'selected-'+type:'tag-default'}`; b.textContent = t;
                b.onclick = () => { b.classList.toggle('tag-default'); b.classList.toggle('selected-'+type); };
                return b;
            };
            const fill = (cid, type, current) => {
                const c = document.getElementById(cid); c.innerHTML='';
                localTags[type].forEach(t => c.appendChild(createTagBtn(t, type, current.includes(t))));
            };
            fill('tag-edit-environment-tags', 'environment', j.environmentTags||[]);
            fill('tag-edit-entry-tags', 'entry', j.entryTags||[]);
            fill('tag-edit-psychology-tags', 'psychology', j.psychologyTags||[]);
            openModal('tag-edit-modal');
        }
        document.getElementById('tag-edit-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const id = document.getElementById('tag-edit-journal-id').value;
            const getT = (cid, type) => Array.from(document.querySelectorAll(`#${cid} .selected-${type}`)).map(b=>b.textContent);
            await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).update({
                environmentTags: getT('tag-edit-environment-tags', 'environment'),
                entryTags: getT('tag-edit-entry-tags', 'entry'),
                psychologyTags: getT('tag-edit-psychology-tags', 'psychology')
            });
            closeModal('tag-edit-modal'); showToast("ÌÉúÍ∑∏ ÏàòÏ†ïÎê®");
        });
        
        // Memo Modal helper
        function openMemoModal(id) {
            const j = localJournals.find(x=>x.id===id); if(!j) return;
            document.getElementById('memo-journal-id').value = id;
            document.getElementById('memo-content').value = j.memo || '';
            openModal('memo-modal');
        }
        document.getElementById('memo-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const id = document.getElementById('memo-journal-id').value;
            await db.collection("users").doc(currentUser.uid).collection("journals").doc(id).update({ memo: document.getElementById('memo-content').value });
            closeModal('memo-modal'); showToast("Î©îÎ™® Ï†ÄÏû•Îê®");
        });

    </script>
</body>
</html>
