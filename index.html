<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매매일지 & 가계부</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-color 0.3s ease;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { background-color: #4a90e2; color: white; font-weight: 700; }
        .tag { transition: all 0.2s ease; cursor: pointer; position: relative;} /* position: relative 추가 */
        .tag.selected { background-color: #4a90e2; color: white; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        .toggle-group { display: flex; border-radius: 0.75rem; padding: 0.25rem; background-color: #e5e7eb; }
        .toggle-btn { flex: 1; padding: 0.5rem 0; border-radius: 0.5rem; border: none; background-color: transparent; font-weight: 500; transition: all 0.2s ease-in-out; cursor: pointer; }
        .toggle-btn.selected { background-color: white; color: #3b82f6; font-weight: 700; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        .tag.selected .delete-tag-span { color: white; }
        .tag.selected .delete-tag-span:hover { color: #fecaca; }

        /* Updated Dark Mode Styles */
        .dark body { background-color: #121212; color: #E0E0E0; }
        .dark h1, .dark h2, .dark h3 { color: #FFFFFF; }
        .dark p, .dark label, .dark span, .dark strong { color: #E0E0E0; }
        .dark header p, .dark .text-gray-500, .dark .main-tab-btn { color: #BDBDBD; }
        .dark .main-tab-btn.active { color: #3b82f6; border-color: #3b82f6;}
        .dark #auth-info { color: #828282; }
        .dark #theme-toggle:hover, .dark #logout-btn:hover { background-color: #2d2d2d; }
        .dark nav, .dark form, .dark .bg-white { background-color: #1E1E1E; }
        .dark .tab-btn { color: #E0E0E0; }
        .dark .tab-btn.active { background-color: #3b82f6; color: white; }
        .dark input, .dark .toggle-group, .dark select, .dark textarea { background-color: #2d2d2d; border-color: #4F4F4F; color: #E0E0E0; }
        .dark input::placeholder, .dark textarea::placeholder { color: #828282; }
        .dark .toggle-btn { color: #BDBDBD; }
        .dark .toggle-btn.selected { background-color: #4F4F4F; color: #FFFFFF; font-weight: 700; box-shadow: none; }
        .dark .tag.selected { background-color: #3b82f6; color: #ffffff; }
        .dark .entry-tags-container .tag.selected { background-color: #16a34a; }
        .dark .psychology-tags-container .tag.selected { background-color: #9333ea; }
        .dark .environment-tags-container .tag.selected { background-color: #f59e0b; } /* 새로운 환경 태그 색상 */
        .dark .border-blue-200 { border-color: #3b82f6; }
        .dark .border-green-200 { border-color: #16a34a; }
        .dark .border-purple-200 { border-color: #9333ea; }
        .dark .border-yellow-200 { border-color: #f59e0b; }
        .dark .bg-blue-50 { background-color: #2d2d2d; border-color: #4F4F4F; }
        .dark .text-blue-800 { color: #E0E0E0; }
        .dark .bg-gray-200 { background-color: #333333; }
        .dark .text-gray-700 { color: #E0E0E0; }
        .dark .text-gray-600 { color: #BDBDBD; }
        .dark .text-gray-800 { color: #FFFFFF; }
        .dark .bg-green-100 { background-color: rgba(22, 163, 74, 0.2); }
        .dark .text-green-800 { color: #4ade80; }
        .dark .bg-purple-100 { background-color: rgba(147, 51, 234, 0.2); }
        .dark .text-purple-800 { color: #c084fc; }
        .dark .bg-yellow-100 { background-color: rgba(245, 158, 11, 0.2); }
        .dark .text-yellow-800 { color: #facc15; }
        .dark .border-gray-200 { border-color: #4F4F4F; }
        .dark .bg-gray-50 { background-color: #2d2d2d; }
        .dark .hover\:bg-gray-100:hover { background-color: #2d2d2d; }
        .dark .bg-gray-300 { background-color: #4F4F4F; }
        .dark .hover\:bg-gray-400:hover { background-color: #666666; }
        .dark #ledger-category-summary > div:hover, .dark #ledger-income-summary > div:hover { background-color: #2d2d2d; }
        .dark .bg-gray-50 { background-color: #2d2d2d; }
        .dark .bg-gray-50 .text-gray-700 { color: #E0E0E0; }
        .dark .bg-gray-50 .text-gray-500 { color: #BDBDBD; }
        
        /* Category selection highlight */
        #ledger-category-summary > div.selected, #ledger-income-summary > div.selected { background-color: #dbeafe; /* blue-100 */ }
        .dark #ledger-category-summary > div.selected, .dark #ledger-income-summary > div.selected { background-color: #2563eb; /* blue-600 */ }

        /* Quick-Edit Tag & Memo */
        .quick-edit-btn { transition: all 0.2s; }
        .quick-edit-btn:hover { transform: scale(1.05); }

        /* Time Tag Overlay Style */
        .time-tag-overlay {
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 0.6rem;
            line-height: 1;
            padding: 2px 4px;
            border-radius: 4px;
            background-color: #10b981; /* Green 500 */
            color: white;
            font-weight: 600;
            z-index: 10;
        }

    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="login-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">나의 매매일지 & 가계부 📝</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">당신의 모든 기록을 통해 성장하세요!</p>
            <button id="login-btn" class="bg-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center justify-center">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Google 계정으로 로그인
            </button>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 hidden">
        
        <header class="mb-6 relative flex items-center justify-center">
            <div class="text-center px-16 sm:px-20">
                <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">나의 기록 관리</h1>
                <p class="text-center text-gray-500">매매일지 & 가계부</p>
                <div id="auth-info" class="text-center text-xs mt-2"></div>
            </div>
            <div class="absolute top-0 right-0 flex items-center h-full space-x-2">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i id="sun-icon" data-lucide="sun" class="h-6 w-6"></i><i id="moon-icon" data-lucide="moon" class="h-6 w-6"></i></button>
                <button id="logout-btn" title="로그아웃" class="text-sm font-semibold hover:text-red-500 transition-colors p-2 rounded-md hover:bg-gray-200"><i data-lucide="log-out" class="h-5 w-5"></i></button>
            </div>
        </header>

        <div class="border-b-2 border-gray-200 dark:border-gray-700 mb-8">
            <nav class="-mb-0.5 flex justify-center space-x-6">
                <button data-main-tab="journal-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600 active"><i data-lucide="book-marked" class="w-5 h-5"></i>매매일지</button>
                <button data-main-tab="ledger-container" class="main-tab-btn py-4 px-1 inline-flex items-center gap-2 text-base whitespace-nowrap text-gray-500 hover:text-blue-600"><i data-lucide="piggy-bank" class="w-5 h-5"></i>가계부</button>
            </nav>
        </div>

        <div id="journal-container">
            <nav class="flex justify-center bg-white rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2 dark:bg-[#1E1E1E]">
                <button data-tab="form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="plus-circle" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>일지 작성</button>
                <button data-tab="list-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="book-open" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>내 일지</button>
                <button data-tab="stats-view" class="tab-btn text-gray-600 w-full md:w-auto px-3 sm:px-4 md:px-6 py-3 rounded-lg text-sm md:text-base"><i data-lucide="bar-chart-2" class="inline-block w-4 h-4 sm:w-5 sm:h-5 mr-1 md:mr-2"></i>성과 분석</button>
            </nav>
            <main id="journal-main-content">
                <div id="form-view">
                    <form id="journal-form" class="bg-white dark:bg-[#1E1E1E] p-6 md:p-8 rounded-2xl shadow-lg space-y-6 md:space-y-8">
                        <input type="hidden" id="journal-id">
                        
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold mb-4 border-b-2 border-blue-200 pb-2 flex items-center"><i data-lucide="clipboard-list" class="mr-3 text-blue-500"></i>기본 정보</h2>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="sm:col-span-2 space-y-3">
                                    <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">자산 유형</span>
                                    <div class="toggle-group text-gray-600" data-group="asset-type"><button type="button" data-value="spot" class="toggle-btn selected">현물</button><button type="button" data-value="futures" class="toggle-btn">선물</button></div>
                                </div>

                                <div class="sm:col-span-2 space-y-3">
                                    <label for="ticker" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">종목 이름</label>
                                    <input type="text" id="ticker" placeholder="예: 삼성전자, NG" required class="w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d] text-base">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">날짜</label><input type="date" id="date" required class="w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                                
                                <div><span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">포지션</span>
                                    <div class="toggle-group text-gray-600" data-group="position"><button type="button" data-value="long" class="toggle-btn selected">🟢 롱</button><button type="button" data-value="short" class="toggle-btn">🔴 숏</button></div>
                                </div>
                                
                                <div><span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">매매 전략</span>
                                    <div class="toggle-group text-gray-600" data-group="strategy"><button type="button" data-value="단타" class="toggle-btn selected">단타</button><button type="button" data-value="스윙" class="toggle-btn">스윙</button><button type="button" data-value="장기" class="toggle-btn">장기</button></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                <div id="spot-fields" class="space-y-3">
                                    <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">수량</label>
                                    <input type="text" inputmode="numeric" id="quantity" placeholder="예: 100" class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]">
                                </div>

                                <div id="futures-contracts-field" class="hidden space-y-3">
                                    <label for="contracts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">계약 수</label>
                                    <input type="text" inputmode="numeric" id="contracts" placeholder="예: 1" class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]">
                                </div>
                                
                                <div class="space-y-3">
                                    <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">입력 통화</span>
                                    <div class="toggle-group text-gray-600" data-group="form-currency"><button type="button" id="form-currency-krw-btn" class="toggle-btn">원 (₩)</button><button type="button" id="form-currency-usd-btn" class="toggle-btn selected">달러 ($)</button></div>
                                </div>

                                <div><label for="entry-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">진입가</label><input type="text" inputmode="decimal" id="entry-price" placeholder="예: 10,000" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                                <div><label for="target-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">목표가</label><input type="text" inputmode="decimal" id="target-price" placeholder="예: 11,000" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                                <div class="sm:col-span-2"><label for="stop-loss" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">손절가</label><input type="text" inputmode="decimal" id="stop-loss" placeholder="예: 9,500" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                            </div>
                            
                            <div id="futures-fields" class="hidden sm:col-span-2 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                    <div class="sm:col-span-3 bg-gray-50 dark:bg-[#2d2d2d] p-4 rounded-xl border border-gray-200 dark:border-[#4F4F4F]">
                                        <h3 class="text-base font-semibold mb-3 flex justify-between items-center">
                                            선물 종목 정보 관리 (틱가치/단위)
                                            <button type="button" id="delete-futures-info-btn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-xs flex items-center disabled:opacity-50 disabled:cursor-not-allowed" title="선택된 종목 정보를 삭제합니다. (매매일지에서 사용 중이면 삭제 불가)">
                                                <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i> 삭제
                                            </button>
                                        </h3>
                                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                                            <select id="futures-info-select" class="flex-grow p-3 border border-gray-300 dark:border-[#4F4F4F] rounded-lg bg-white dark:bg-[#1E1E1E] text-base">
                                                <option value="">- 종목 선택 (틱가치/단위 불러오기) -</option>
                                            </select>
                                            <button type="button" id="save-futures-info-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition text-sm">정보 저장</button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label for="tick-value" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">틱가치 ($)</label><input type="text" inputmode="decimal" id="tick-value" placeholder="예: 1" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]"></div>
                                            <div><label for="tick-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">틱단위</label><input type="text" inputmode="decimal" id="tick-size" placeholder="예: 0.001" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#1E1E1E]"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h2 class="text-2xl font-bold border-b-2 border-yellow-200 pb-2 flex items-center"><i data-lucide="cloud-sun" class="mr-3 text-yellow-500"></i>환경 태그</h2>
                            <div id="environment-tags-container" class="flex flex-wrap gap-2 mb-2 environment-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-environment-tag" placeholder="새로운 태그 추가" class="flex-grow p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"><button type="button" class="add-environment-tag-btn bg-yellow-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-600 transition">추가</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h2 class="text-2xl font-bold border-b-2 border-green-200 pb-2 flex items-center"><i data-lucide="siren" class="mr-3 text-green-500"></i>진입 근거</h2>
                            <div id="entry-tags-container" class="flex flex-wrap gap-2 mb-2 entry-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-entry-tag" placeholder="새로운 태그 추가" class="flex-grow p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"><button type="button" class="add-entry-tag-btn bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition">추가</button></div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h2 class="text-2xl font-bold border-b-2 border-purple-200 pb-2 flex items-center"><i data-lucide="brain-circuit" class="mr-3 text-purple-500"></i>심리 상태</h2>
                            <div id="psychology-tags-container" class="flex flex-wrap gap-2 mb-2 psychology-tags-container"></div>
                            <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-psychology-tag" placeholder="새로운 태그 추가" class="flex-grow p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"><button type="button" class="add-psychology-tag-btn bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-600 transition">추가</button></div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" id="clear-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">새로 작성</button>
                            <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>일지 저장</button>
                        </div>
                    </form>
                </div>
                <div id="list-view" class="hidden">
                    <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-2xl shadow-lg mb-6 flex flex-wrap items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2"><label for="list-exchange-rate" class="font-medium text-sm text-gray-600 dark:text-gray-300">환율:</label><input type="text" inputmode="numeric" id="list-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white dark:bg-[#2d2d2d] rounded-lg text-center"></div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm p-4 rounded-xl mb-6 flex items-center gap-3 dark:bg-[#2d2d2d] dark:border-[#4F4F4F] dark:text-gray-300"><i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i><p>일지 우측의 <i data-lucide="log-out" class="inline-block w-4 h-4 mx-1"></i>(청산), <i data-lucide="edit" class="inline-block w-4 h-4 mx-1"></i>(수정), <i data-lucide="trash-2" class="inline-block w-4 h-4 mx-1"></i>(삭제) 아이콘으로 관리하세요.</p></div>
                    <div id="journal-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                <div id="stats-view" class="hidden space-y-8">
                    <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-2xl shadow-lg mb-6 flex flex-col sm:flex-row items-center justify-center gap-x-6 gap-y-4">
                        <div class="flex items-center space-x-2"><label for="stats-exchange-rate" class="font-medium text-sm text-gray-600 dark:text-gray-300">환율:</label><input type="text" inputmode="numeric" id="stats-exchange-rate" value="1,380" class="exchange-rate-input number-input w-28 p-2 border border-gray-300 bg-white dark:bg-[#2d2d2d] rounded-lg text-center"></div>
                        <div class="toggle-group text-gray-600 w-full sm:w-auto" data-group="stats-currency"><button id="stats-currency-krw-btn" class="toggle-btn selected">원 (₩)</button><button id="stats-currency-usd-btn" class="toggle-btn">달러 ($)</button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center space-y-2"><h3 class="text-xl font-bold mb-1">총 승률</h3><p id="total-win-rate" class="text-4xl font-extrabold text-blue-500">N/A</p><p id="win-rate-context" class="text-sm text-gray-500 dark:text-gray-400 min-h-[20px]"></p></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center space-y-2"><h3 class="text-xl font-bold mb-1">평균 손익비</h3><p id="average-pl-ratio" class="text-4xl font-extrabold text-green-500">N/A</p><p id="pl-ratio-context" class="text-sm text-gray-500 dark:text-gray-400 min-h-[20px]"></p></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center space-y-2"><h3 class="text-xl font-bold mb-1">총 실현 손익</h3><p id="total-realized-pnl" class="text-4xl font-extrabold text-gray-500">N/A</p><p id="pnl-context" class="text-sm text-gray-500 dark:text-gray-400 min-h-[20px]"></p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg lg:col-span-1"><h3 class="text-xl font-bold mb-4">총 손익 구성</h3><div class="chart-container"><canvas id="pnl-composition-chart"></canvas></div></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg lg:col-span-2"><h3 class="text-xl font-bold mb-4">월별 손익</h3><div class="chart-container"><canvas id="monthly-pnl-chart"></canvas></div><div id="monthly-pnl-summary" class="mt-4 text-sm text-center"></div></div>
                    </div>
                    <div class="grid grid-cols-1"><div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">분기별 손익</h3><div class="chart-container"><canvas id="quarterly-pnl-chart"></canvas></div><div id="quarterly-pnl-summary" class="mt-4 text-sm text-center"></div></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">환경 태그별 승률</h3><div class="chart-container"><canvas id="environment-win-rate-chart"></canvas></div></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">진입 근거별 승률</h3><div class="chart-container"><canvas id="entry-win-rate-chart"></canvas></div></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">심리 상태별 승률</h3><div class="chart-container"><canvas id="psychology-win-rate-chart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1"><div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">매매 전략별 승률 및 롱/숏 포지션 승률</h3><div class="chart-container"><canvas id="strategy-position-win-rate-chart"></canvas></div></div></div>
                </div>
            </main>
        </div>

        <div id="ledger-container" class="hidden">
            <nav class="flex justify-center bg-white dark:bg-[#1E1E1E] rounded-xl shadow-md p-2 mb-8 space-x-1 sm:space-x-2">
                <button data-ledger-tab="ledger-form-view" class="tab-btn text-gray-600 active w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="plus-circle" class="inline-block w-5 h-5 mr-2"></i>내역 입력</button>
                <button data-ledger-tab="ledger-list-view" class="tab-btn text-gray-600 w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="list" class="inline-block w-5 h-5 mr-2"></i>상세 내역</button>
                <button data-ledger-tab="ledger-stats-view" class="tab-btn text-gray-600 w-full md:w-auto px-4 md:px-6 py-3 rounded-lg"><i data-lucide="pie-chart" class="inline-block w-5 h-5 mr-2"></i>통계 분석</button>
            </nav>
            <main id="ledger-main-content">
                <div id="ledger-form-view">
                    <form id="ledger-form" class="bg-white dark:bg-[#1E1E1E] p-6 md:p-8 rounded-2xl shadow-lg space-y-6 md:space-y-8">
                        <input type="hidden" id="ledger-id">
                        
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold mb-4 flex items-center border-b-2 border-blue-200 pb-2"><i data-lucide="edit-3" class="mr-3 text-blue-500"></i>가계부 내역 입력</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                <div class="sm:col-span-2 space-y-3">
                                    <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">내역 유형</span>
                                    <div class="toggle-group text-gray-600" data-group="ledger-type"><button type="button" data-value="expense" class="toggle-btn selected">💸 지출</button><button type="button" data-value="income" class="toggle-btn">💰 수입</button></div>
                                </div>

                                <div><label for="ledger-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">날짜</label><input type="date" id="ledger-date" required class="w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                                <div><label for="ledger-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">금액</label><input type="text" inputmode="numeric" id="ledger-amount" placeholder="금액 입력" required class="number-input w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                            </div>
                                
                            <div class="sm:col-span-2 space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700" id="ledger-expense-category-section">
                                <h3 class="text-xl font-bold mb-2">지출 카테고리</h3>
                                <div id="ledger-expense-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-ledger-expense-category" placeholder="새로운 지출 카테고리 추가" class="flex-grow p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"><button type="button" id="add-ledger-expense-category-btn" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition">추가</button></div>
                            </div>

                            <div class="sm:col-span-2 hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700" id="ledger-income-category-section">
                                <h3 class="text-xl font-bold mb-2">수입 카테고리</h3>
                                <div id="ledger-income-category-tags-container" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex flex-col sm:flex-row gap-3"><input type="text" id="new-ledger-income-category" placeholder="새로운 수입 카테고리 추가" class="flex-grow p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"><button type="button" id="add-ledger-income-category-btn" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition">추가</button></div>
                            </div>

                            <div class="sm:col-span-2 pt-4 border-t border-gray-200 dark:border-gray-700"><label for="ledger-memo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">메모</label><input type="text" id="ledger-memo" placeholder="메모 내용 (선택)" class="w-full p-3 border border-gray-300 rounded-lg bg-white dark:bg-[#2d2d2d]"></div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" id="clear-ledger-form-btn" class="bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 transition">새로 작성</button><button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition"><i data-lucide="save" class="inline-block w-5 h-5 mr-2"></i>내역 저장</button>
                        </div>
                    </form>
                </div>
                <div id="ledger-list-view" class="hidden space-y-6">
                    <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-2xl shadow-lg flex flex-wrap items-center justify-center gap-4">
                        <select id="ledger-list-filter-type" class="p-2 border border-gray-300 rounded-lg dark:bg-[#2d2d2d] dark:border-[#4F4F4F]"><option value="month">월별</option><option value="quarter">분기별</option><option value="year">연도별</option></select>
                        <div class="flex items-center gap-2">
                            <button id="ledger-list-prev-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-[#2d2d2d]"><i data-lucide="chevron-left"></i></button>
                            <span id="ledger-list-period-display" class="font-bold text-lg w-40 text-center"></span>
                            <button id="ledger-list-next-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-[#2d2d2d]"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg space-y-4">
                            <div>
                                <h3 class="text-xl font-bold mb-4">카테고리별 지출</h3>
                                <div id="ledger-category-summary" class="space-y-2"></div>
                            </div>
                             <div class="border-t pt-4 dark:border-gray-700">
                                <h3 class="text-xl font-bold mb-4">카테고리별 수입</h3>
                                <div id="ledger-income-summary" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">상세 내역: <span id="ledger-detail-title">내역 선택</span></h3>
                            <div id="ledger-entry-details" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
                <div id="ledger-stats-view" class="hidden space-y-8">
                    <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-2xl shadow-lg flex flex-wrap items-center justify-center gap-4">
                        <select id="ledger-stats-filter-type" class="p-2 border border-gray-300 rounded-lg dark:bg-[#2d2d2d] dark:border-[#4F4F4F]"><option value="month">월별</option><option value="quarter">분기별</option><option value="year">연도별</option></select>
                        <div class="flex items-center gap-2">
                            <button id="ledger-stats-prev-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-[#2d2d2d]"><i data-lucide="chevron-left"></i></button>
                            <span id="ledger-stats-period-display" class="font-bold text-lg w-40 text-center"></span>
                            <button id="ledger-stats-next-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-[#2d2d2d]"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2 text-green-500">기간 내 수입</h3><p id="ledger-total-income" class="text-3xl font-bold">₩0</p></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2 text-red-500">기간 내 지출</h3><p id="ledger-total-expense" class="text-3xl font-bold">₩0</p></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg text-center"><h3 class="text-lg font-bold mb-2">합계</h3><p id="ledger-balance" class="text-3xl font-bold">₩0</p></div>
                    </div>
                    <div class="grid grid-cols-1"><div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 id="ledger-trend-chart-title" class="text-xl font-bold mb-4">수입/지출 추이</h3><div class="chart-container"><canvas id="ledger-monthly-pnl-chart"></canvas></div></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 id="ledger-expense-chart-title" class="text-xl font-bold mb-4">카테고리별 지출</h3><div class="chart-container"><canvas id="ledger-expense-chart"></canvas></div></div>
                        <div class="bg-white dark:bg-[#1E1E1E] p-6 rounded-2xl shadow-lg"><h3 id="ledger-income-chart-title" class="text-xl font-bold mb-4">카테고리별 수입</h3><div class="chart-container"><canvas id="ledger-income-chart"></canvas></div></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-md modal-content transform scale-95"><h2 class="text-2xl font-bold mb-6">청산 기록</h2><form id="exit-form"><input type="hidden" id="exit-journal-id"><div class="space-y-4"><div><label for="exit-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">청산 날짜</label><input type="date" id="exit-date" required class="mt-1 w-full p-3 border border-gray-300 bg-white dark:bg-[#2d2d2d] rounded-lg"></div><div><label for="exit-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">청산가</label><input type="text" inputmode="decimal" id="exit-price" required class="number-input mt-1 w-full p-3 border border-gray-300 bg-white dark:bg-[#2d2d2d] rounded-lg"></div><div><label for="exit-quantity" id="exit-quantity-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">청산 수량</label><input type="text" inputmode="numeric" id="exit-quantity" required class="number-input mt-1 w-full p-3 border border-gray-300 bg-white dark:bg-[#2d2d2d] rounded-lg"><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">남은 수량: <span id="remaining-quantity"></span></p></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="close-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400">취소</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">청산 추가</button></div></form></div></div>
    
    <div id="memo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-xl modal-content transform scale-95"><h2 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="book-open-text" class="mr-3 text-blue-500"></i> 매매 복기 및 소감</h2><form id="memo-form"><input type="hidden" id="memo-journal-id"><div class="space-y-4"><div><label for="memo-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">복기 내용 (당시 소감, 감정 등)</label><textarea id="memo-content" rows="8" class="mt-1 w-full p-3 border border-gray-300 dark:border-[#4F4F4F] bg-white dark:bg-[#2d2d2d] rounded-lg resize-none text-base" placeholder="매매를 복기하며 느낀 소감이나 당시 감정, 차트 분석 내용 등을 자유롭게 기록하세요."></textarea></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="close-memo-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400">취소</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">메모 저장</button></div></form></div></div>
    
    <div id="tag-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-xl modal-content transform scale-95"><h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="tag" class="mr-3 text-purple-500"></i> 태그 수정</h2><form id="tag-edit-form"><input type="hidden" id="tag-edit-journal-id"><div class="space-y-6"><div id="tag-edit-environment-container"><h3 class="text-xl font-bold mb-3 border-b border-yellow-200 dark:border-yellow-700 pb-2 flex items-center text-yellow-600"><i data-lucide="cloud-sun" class="mr-2 w-5 h-5"></i> 환경 태그</h3><div id="tag-edit-environment-tags" class="flex flex-wrap gap-2"></div></div><div id="tag-edit-entry-container"><h3 class="text-xl font-bold mb-3 border-b border-green-200 dark:border-green-700 pb-2 flex items-center text-green-600"><i data-lucide="siren" class="mr-2 w-5 h-5"></i> 진입 근거</h3><div id="tag-edit-entry-tags" class="flex flex-wrap gap-2"></div></div><div id="tag-edit-psychology-container"><h3 class="text-xl font-bold mb-3 border-b border-purple-200 dark:border-purple-700 pb-2 flex items-center text-purple-600"><i data-lucide="brain-circuit" class="mr-2 w-5 h-5"></i> 심리 상태</h3><div id="tag-edit-psychology-tags" class="flex flex-wrap gap-2"></div></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="close-tag-edit-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400">취소</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">태그 저장</button></div></form></div></div>
    
    <div id="time-tag-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0">
        <div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <h2 class="text-2xl font-bold mb-4 flex items-center">시간봉 선택</h2>
            <p id="time-tag-context" class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300"></p>
            <form id="time-tag-form">
                <input type="hidden" id="time-tag-journal-id">
                <input type="hidden" id="time-tag-name">
                <div id="time-tag-options-container" class="flex flex-wrap gap-2 mb-6">
                    </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="close-time-tag-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400">취소</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">저장 및 선택</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop opacity-0"><div class="bg-white dark:bg-[#1E1E1E] p-8 rounded-2xl shadow-2xl w-full max-w-sm modal-content transform scale-95"><h2 id="confirm-title" class="text-xl font-bold mb-4">확인</h2><p id="confirm-message" class="text-gray-600 dark:text-gray-300 mb-6"></p><div class="flex justify-end space-x-3"><button type="button" id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 font-semibold">취소</button><button type="button" id="confirm-ok-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold">확인</button></div></div></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"><p id="toast-message"></p></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDZm5AazCafB0Sb2gd0llv9e3GAhE-nKBw",
          authDomain: "sakurazima-mai-0u0.firebaseapp.com",
          projectId: "sakurazima-mai-0u0",
          storageBucket: "sakurazima-mai-0u0.appspot.com",
          messagingSenderId: "697666115735",
          appId: "1:697666115735:web:7380a588822f771dc071d2",
          measurementId: "G-TZQ9GVFWV5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const Timestamp = firebase.firestore.Timestamp;

        let currentUser = null;
        let charts = {};
        let confirmCallback = null;
        
        // Trading Journal State
        let unsubscribeJournals = null, unsubscribeTags = null;
        let localJournals = [], localTags = { environment: [], entry: [], psychology: [], time: [] }; 
        let localFuturesInfo = {}; 
        let unsubscribeFuturesInfo = null;
        let statsCurrency = 'KRW', exchangeRate = 1380;
        
        // Household Ledger State
        let unsubscribeLedger = null, unsubscribeLedgerCategories = null;
        let localLedgerEntries = [];
        let localLedgerCategories = { expense: [], income: [] };
        let ledgerListDate = new Date();
        let ledgerStatsDate = new Date();

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // ================== Authentication ==================
        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(error => showToast("로그인 실패: " + error.message, "error")));
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('auth-info').textContent = `${user.displayName}님 환영합니다!`;
                initializeAppFunctionality();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeJournals) unsubscribeJournals();
                if (unsubscribeTags) unsubscribeTags();
                if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
                if (unsubscribeLedger) unsubscribeLedger();
                if (unsubscribeLedgerCategories) unsubscribeLedgerCategories();
                Object.values(charts).forEach(chart => { if(chart) chart.destroy(); });
                charts = {};
            }
            lucide.createIcons();
        });

        async function initializeAppFunctionality() {
            if (!currentUser) return;
            const userId = currentUser.uid;

            await initializeJournalDefaults(userId);
            await initializeFuturesInfoDefaults(userId);
            attachJournalListeners(userId);
            resetForm();

            await initializeLedgerDefaults(userId);
            attachLedgerListeners(userId);
            resetLedgerForm();
        }

        // ================== Main Tab Switching Logic ==================
        document.querySelectorAll('.main-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.mainTab;
                document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('journal-container').classList.toggle('hidden', targetId !== 'journal-container');
                document.getElementById('ledger-container').classList.toggle('hidden', targetId !== 'ledger-container');
                
                if (targetId === 'ledger-container' && currentUser) {
                     renderLedgerListView();
                     renderLedgerStatsView();
                } else if (targetId === 'journal-container' && currentUser) {
                    renderJournalStats(localJournals);
                }
            });
        });
        
        // =======================================================
        // ================== TRADING JOURNAL LOGIC ==============
        // =======================================================
        
        const journalForm = document.getElementById('journal-form');
        const journalList = document.getElementById('journal-list');

        async function initializeJournalDefaults(userId) {
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            const tagsDocSnap = await tagsDocRef.get();
            if (!tagsDocSnap.exists) {
                await tagsDocRef.set({
                    environment: ['개장 직후', '종가 부근', '변동성 확대', 'FOMC'], 
                    entry: ['정배열 돌파', '낙주 매매', '채널 하단', 'OB', '4H', '연속저점', '주추세'],
                    psychology: ['FOMO', '확신', '매매중독', '두려움', '사후정당화', '배팅'],
                    time: ['1분봉', '5분봉', '15분봉', '1시간봉', '4시간봉', '일봉', '주봉'] // 타임 태그 기본값 추가
                });
            }
        }
        
        async function initializeFuturesInfoDefaults(userId) {
            const docRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            const docSnap = await docRef.get();
            if (!docSnap.exists) {
                // 예시 데이터
                await docRef.set({
                    'ES': { tickValue: 5.0, tickSize: 0.25 },
                    'NG': { tickValue: 10.0, tickSize: 0.001 },
                    'MGC': { tickValue: 1.0, tickSize: 0.1 }
                });
            }
        }

        function attachJournalListeners(userId) {
            if (unsubscribeJournals) unsubscribeJournals();
            const journalsQuery = db.collection("users").doc(userId).collection("journals").orderBy("date", "desc");
            unsubscribeJournals = journalsQuery.onSnapshot((snapshot) => {
                localJournals = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    date: doc.data().date.toDate(),
                    // entryTags를 객체 배열로 통일: { tag: string, timeTags: string[] }
                    entryTags: doc.data().entryTags?.map(tag => typeof tag === 'string' ? { tag, timeTags: [] } : tag) || []
                }));
                renderJournals(localJournals);
                renderJournalStats(localJournals);
            }, (error) => console.error("Error fetching journals:", error));

            if (unsubscribeTags) unsubscribeTags();
            const tagsDocRef = db.collection("users").doc(userId).collection("journalTags").doc("all");
            unsubscribeTags = tagsDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    localTags = doc.data();
                    renderJournalTags(localTags.environment, 'environment-tags-container', 'environment'); 
                    renderJournalTags(localTags.entry, 'entry-tags-container', 'entry');
                    renderJournalTags(localTags.psychology, 'psychology-tags-container', 'psychology');
                }
            }, (error) => console.error("Error fetching tags:", error));
            
            // 선물 종목 정보 리스너
            if (unsubscribeFuturesInfo) unsubscribeFuturesInfo();
            const futuresDocRef = db.collection("users").doc(userId).collection("journalData").doc("futuresInfo");
            unsubscribeFuturesInfo = futuresDocRef.onSnapshot((doc) => {
                localFuturesInfo = doc.exists ? doc.data() : {};
                renderFuturesInfoSelect();
            }, (error) => console.error("Error fetching futures info:", error));
        }
        
        function switchJournalView(tabId) {
            document.querySelectorAll('#journal-container [data-tab]').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            ['form-view', 'list-view', 'stats-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== tabId));
            lucide.createIcons();
            if(tabId === 'stats-view' && currentUser) {
                renderJournalStats(localJournals);
            }
        }
        document.querySelectorAll('#journal-container [data-tab]').forEach(b => b.addEventListener('click', () => switchJournalView(b.dataset.tab)));
        
        // Asset type toggle (수량/계약수 필드 토글 로직)
        document.querySelectorAll('[data-group="asset-type"] .toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const isSpot = btn.dataset.value === 'spot';
                
                document.getElementById('spot-fields').classList.toggle('hidden', !isSpot);
                document.getElementById('futures-contracts-field').classList.toggle('hidden', isSpot);
                document.getElementById('futures-fields').classList.toggle('hidden', isSpot);
                
                const quantityInput = document.getElementById('quantity');
                const contractsInput = document.getElementById('contracts');
                const tickValueInput = document.getElementById('tick-value');
                const tickSizeInput = document.getElementById('tick-size');
                
                // Required 속성 설정
                quantityInput.required = isSpot;
                contractsInput.required = !isSpot;
                tickValueInput.required = !isSpot;
                tickSizeInput.required = !isSpot;

                if (!isSpot) { // 선물 타입 선택 시
                     const currentTicker = document.getElementById('ticker').value.trim().toUpperCase();
                     if (localFuturesInfo[currentTicker]) {
                        contractsInput.value = contractsInput.value || 1; 
                        document.getElementById('futures-info-select').value = currentTicker;
                        tickValueInput.value = formatNumber(localFuturesInfo[currentTicker].tickValue);
                        tickSizeInput.value = formatNumber(localFuturesInfo[currentTicker].tickSize);
                        document.getElementById('delete-futures-info-btn').disabled = false;
                     } else {
                        contractsInput.value = '';
                        document.getElementById('futures-info-select').value = '';
                        tickValueInput.value = '';
                        tickSizeInput.value = '';
                        document.getElementById('delete-futures-info-btn').disabled = true;
                     }
                     quantityInput.value = ''; // 현물 수량 필드 값 초기화

                } else { // 현물 타입 선택 시
                     document.getElementById('futures-info-select').value = '';
                     tickValueInput.value = '';
                     tickSizeInput.value = '';
                     document.getElementById('delete-futures-info-btn').disabled = true;
                     contractsInput.value = ''; // 계약 수 필드 값 초기화
                }
            });
        });
        
        // 선물 정보 Select 박스 렌더링 및 리스너
        function renderFuturesInfoSelect() {
            const select = document.getElementById('futures-info-select');
            const tickerInput = document.getElementById('ticker');
            const deleteBtn = document.getElementById('delete-futures-info-btn');
            const contractsInput = document.getElementById('contracts');
            const tickValueInput = document.getElementById('tick-value');
            const tickSizeInput = document.getElementById('tick-size');
            
            deleteBtn.disabled = true; 
            
            select.innerHTML = '<option value="">- 종목 선택 (틱가치/단위 불러오기) -</option>';
            
            const currentTicker = tickerInput.value.trim().toUpperCase();

            Object.entries(localFuturesInfo).sort((a,b) => a[0].localeCompare(b[0])).forEach(([ticker, info]) => {
                const option = document.createElement('option');
                option.value = ticker;
                option.textContent = `${ticker} (가치: ${formatNumber(info.tickValue)}, 단위: ${formatNumber(info.tickSize)})`;
                select.appendChild(option);
                
                if (ticker === currentTicker && !document.getElementById('futures-fields').classList.contains('hidden')) {
                    select.value = ticker;
                    deleteBtn.disabled = false;
                }
            });
            
            select.onchange = (e) => {
                const selectedTicker = e.target.value;
                const info = localFuturesInfo[selectedTicker];
                
                deleteBtn.disabled = !selectedTicker;

                if (info) {
                    tickerInput.value = selectedTicker;
                    tickValueInput.value = formatNumber(info.tickValue);
                    tickSizeInput.value = formatNumber(info.tickSize);
                    contractsInput.value = contractsInput.value || 1; // 계약수 없으면 1로 자동 채움
                    showToast(`종목 '${selectedTicker}' 정보가 채워졌습니다.`);
                } else {
                    tickValueInput.value = '';
                    tickSizeInput.value = '';
                }
            };
            
            tickerInput.oninput = () => {
                const newTicker = tickerInput.value.trim().toUpperCase();
                const isFutures = !document.getElementById('futures-fields').classList.contains('hidden');
                
                deleteBtn.disabled = !localFuturesInfo[newTicker];

                if (isFutures && localFuturesInfo[newTicker]) {
                    select.value = newTicker;
                    tickValueInput.value = formatNumber(localFuturesInfo[newTicker].tickValue);
                    tickSizeInput.value = formatNumber(localFuturesInfo[newTicker].tickSize);
                } else if (isFutures) {
                     select.value = '';
                }
            }
        }
        
        // 선물 정보 저장 버튼 리스너
        document.getElementById('save-futures-info-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const tickValueInput = document.getElementById('tick-value');
            const tickSizeInput = document.getElementById('tick-size');
            
            const tickValue = parseFloat(unformatNumber(tickValueInput.value));
            const tickSize = parseFloat(unformatNumber(tickSizeInput.value));

            if (!ticker || isNaN(tickValue) || tickValue <= 0 || isNaN(tickSize) || tickSize <= 0) {
                showToast("종목 이름, 틱가치, 틱단위를 올바르게 입력해주세요.", "error");
                return;
            }

            const currentInfo = localFuturesInfo[ticker];
            const isUpdating = currentInfo;
            const message = isUpdating ? `'${ticker}' 종목 정보를 업데이트하시겠습니까?` : `'${ticker}' 종목 정보를 저장하시겠습니까?`;
            const action = isUpdating ? '업데이트' : '저장';

            showConfirmModal(message, async () => {
                try {
                    const updatedInfo = {
                        ...localFuturesInfo,
                        [ticker]: { tickValue, tickSize }
                    };
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    
                    showToast(`선물 종목 정보가 ${action}되었습니다.`);
                    tickValueInput.value = formatNumber(tickValue);
                    tickSizeInput.value = formatNumber(tickSize);
                    document.getElementById('futures-info-select').value = ticker; 
                    document.getElementById('delete-futures-info-btn').disabled = false;
                } catch(e) {
                    showToast(`정보 ${action} 실패: ${e.message}`, "error");
                }
            }, action);
        });
        
        document.getElementById('delete-futures-info-btn').addEventListener('click', handleDeleteFuturesInfo);

        async function handleDeleteFuturesInfo() {
            const ticker = document.getElementById('futures-info-select').value;

            if (!ticker) {
                showToast("삭제할 종목을 선택해주세요.", "error");
                return;
            }

            const isUsedInJournal = localJournals.some(journal => 
                journal.assetType === 'futures' && 
                journal.ticker.toUpperCase() === ticker.toUpperCase()
            );

            if (isUsedInJournal) {
                showToast(`'${ticker}' 종목은 현재 매매일지에 사용 중이므로 삭제할 수 없습니다.`, "error");
                return;
            }

            showConfirmModal(`선물 종목 '${ticker}'의 저장된 틱가치/틱단위 정보를 삭제하시겠습니까?`, async () => {
                try {
                    const updatedInfo = { ...localFuturesInfo };
                    delete updatedInfo[ticker];
                    
                    await db.collection("users").doc(currentUser.uid).collection("journalData").doc("futuresInfo").set(updatedInfo);
                    
                    showToast(`선물 종목 '${ticker}' 정보가 삭제되었습니다.`);
                    document.getElementById('futures-info-select').value = '';
                    document.getElementById('delete-futures-info-btn').disabled = true;
                    document.getElementById('tick-value').value = '';
                    document.getElementById('tick-size').value = '';
                } catch(e) {
                    showToast(`삭제 실패: ${e.message}`, "error");
                }
            }, '삭제');
        }


        function calculatePnl(journal, exit) {
            const priceDiff = journal.position === 'long' ? (exit.price - journal.entryPrice) : (journal.entryPrice - exit.price);
            const exitQuantity = exit.quantity;

            if (journal.assetType === 'futures') {
                if (!journal.tickSize || !journal.tickValue) return 0;
                return (priceDiff / journal.tickSize) * journal.tickValue * exitQuantity;
            } else { // spot
                return priceDiff * exitQuantity;
            }
        }

        function renderJournals(journals) {
            journalList.innerHTML = '';
            if (journals.length === 0) {
                journalList.innerHTML = `<div class="bg-white dark:bg-[#1E1E1E] col-span-full text-center text-gray-500 dark:text-gray-400 p-10 rounded-2xl shadow-md"><i data-lucide="folder-x" class="mx-auto w-16 h-16 text-gray-400 dark:text-gray-600 mb-4"></i><p class="text-xl">작성된 매매일지가 없습니다.</p></div>`;
                lucide.createIcons(); return;
            }

            journals.forEach(journal => {
                const isSpot = journal.assetType === 'spot';
                const totalAmount = isSpot ? journal.quantity : (journal.contracts || 0); 
                const exitedAmount = journal.exits ? journal.exits.reduce((sum, exit) => sum + exit.quantity, 0) : 0;
                const isClosed = (totalAmount - exitedAmount) <= 1e-9;
                
                let totalPnl = 0;
                if (journal.exits && journal.exits.length > 0) {
                     totalPnl = journal.exits.reduce((sum, exit) => sum + calculatePnl(journal, exit), 0);
                }
                const totalPnlInKRW = journal.currency === 'USD' ? totalPnl * exchangeRate : totalPnl;
                const pnlClass = totalPnlInKRW > 0 ? 'text-green-500' : totalPnlInKRW < 0 ? 'text-red-500' : 'text-gray-500';
                
                const borderColor = isClosed ? (totalPnlInKRW > 0 ? 'border-green-500' : 'border-red-500') : 'border-yellow-500';
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-[#1E1E1E] p-5 rounded-xl shadow-md border-l-4 ${borderColor} flex flex-col justify-between`;
                
                let holdingPeriodDays = 0;
                if (journal.exits && journal.exits.length > 0) {
                    const lastExitDate = new Date(Math.max(...journal.exits.map(e => (e.date.toDate ? e.date.toDate() : new Date(e.date)).getTime())));
                    const entryDate = journal.date;
                    const diffTime = Math.abs(lastExitDate - entryDate);
                    holdingPeriodDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                }
                
                let dateDisplay = journal.date.toLocaleDateString();
                if (holdingPeriodDays > 0) {
                    dateDisplay += ` <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(${holdingPeriodDays}일)</span>`;
                }

                // Quick Edit 버튼 및 아이콘
                const memoIndicator = journal.memo ? `<i data-lucide="message-square" class="w-4 h-4 text-blue-500 quick-edit-btn"></i>` : `<i data-lucide="message-square" class="w-4 h-4 text-gray-400 hover:text-blue-500 quick-edit-btn"></i>`;
                const tagEditIcon = `<i data-lucide="tags" class="w-4 h-4 text-gray-400 hover:text-purple-500 quick-edit-btn"></i>`;


                const exitsHtml = journal.exits && journal.exits.length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 space-y-1 text-xs">
                        <h5 class="font-semibold mb-1 text-gray-600 dark:text-gray-400">청산 내역</h5>
                        ${journal.exits.map(exit => {
                            const exitPnl = calculatePnl(journal, exit);
                            const exitPnlClass = exitPnl > 0 ? 'text-green-500' : exitPnl < 0 ? 'text-red-500' : 'text-gray-500';
                            const exitDate = exit.date.toDate ? exit.date.toDate() : new Date(exit.date);
                            const amountLabel = isSpot ? '주' : '계약';
                            return `<div class="flex justify-between items-center p-1 rounded"><span>${exitDate.toLocaleDateString()} @ ${formatPrice(exit.price, journal.currency)} (${formatNumber(exit.quantity)} ${amountLabel})</span><span class="${exitPnlClass} font-medium">${formatPrice(exitPnl, journal.currency)}</span></div>`
                        }).join('')}
                    </div>` : '';
                
                const amountLabel = isSpot ? '수량' : '계약';
                const futuresInfoHtml = !isSpot ? 
                    `<p class="text-xs text-gray-400 dark:text-gray-500 mt-1"><strong>틱가치/단위:</strong> ${formatPrice(journal.tickValue, journal.currency)} / ${formatNumber(journal.tickSize)}</p>` : '';
                
                // 태그 렌더링 (환경, 진입, 심리)
                const renderTags = (tags, maxCount, baseClass, textColor, isEntry = false) => {
                    // entryTags 객체 배열 통일
                    const tagsArray = tags.map(t => typeof t === 'string' ? { tag: t, timeTags: [] } : t); 
                    const visibleTags = tagsArray.slice(0, maxCount);
                    const hiddenTags = tagsArray.slice(maxCount);
                    const hiddenTagsCount = hiddenTags.length;
                    
                    let tagHtml = `<div class="flex flex-wrap gap-2">`;
                    
                    // 보이는 태그 렌더링
                    tagHtml += visibleTags.map(item => {
                        const timeTagOverlay = isEntry && item.timeTags && item.timeTags.length > 0 ? 
                            `<span class="time-tag-overlay" title="시간봉: ${item.timeTags.join(', ')}">${item.timeTags[0]}</span>` : '';
                        
                        return `<span class="${baseClass} ${textColor} text-xs font-medium px-2.5 py-0.5 rounded-full relative">${timeTagOverlay}${item.tag}</span>`;
                    }).join('');

                    if (hiddenTagsCount > 0) {
                        // 요청 3: +n 대신 모든 태그 표시
                        const allTagsText = tagsArray.map(t => t.tag + (isEntry && t.timeTags.length > 0 ? ` (${t.timeTags.join(',')})` : '')).join(', ');
                        tagHtml += `<span title="${allTagsText}" class="text-xs font-medium text-gray-500 dark:text-gray-400 px-2.5 py-0.5 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full select-none">+${hiddenTagsCount}개 보기</span>`;
                    }
                    tagHtml += `</div>`;
                    return tagHtml;
                };
                
                // 데이터 정제 (Environment, Psychology 태그가 문자열 배열임을 가정)
                const environmentTags = journal.environmentTags?.filter(t => typeof t === 'string') || [];
                const psychologyTags = journal.psychologyTags?.filter(t => typeof t === 'string') || [];

                const environmentTagHtml = renderTags(environmentTags, 4, 'bg-yellow-100 dark:bg-yellow-900', 'text-yellow-800 dark:text-yellow-300');
                const entryTagHtml = renderTags(journal.entryTags, 4, 'bg-green-100 dark:bg-green-900', 'text-green-800 dark:text-green-300', true); 
                const psyTagHtml = renderTags(psychologyTags, 4, 'bg-purple-100 dark:bg-purple-900', 'text-purple-800 dark:text-purple-300');


                card.innerHTML = `
                    <div> <div class="flex justify-between items-start mb-3 border-b border-gray-100 dark:border-gray-800 pb-2">
                            <div>
                                <p class="font-bold text-lg text-gray-800 dark:text-gray-200">${dateDisplay}</p>
                                <div class="flex items-center space-x-2">
                                    <p class="font-extrabold text-xl text-gray-800 dark:text-white">${journal.ticker} <span class="text-xs font-medium text-gray-400 align-top">${isSpot ? '현물' : '선물'}</span></p>
                                    <span class="text-base font-bold ${journal.position === 'long' ? 'text-green-500' : 'text-red-500'}">${journal.position === 'long' ? '🟢 롱' : '🔴 숏'}</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 ml-1">${journal.strategy}</span>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                 ${!isClosed ? `<button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full exit-btn" data-id="${journal.id}" title="청산 기록"><i data-lucide="log-out" class="w-5 h-5 text-blue-500"></i></button>` : ''}
                                <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full edit-btn" data-id="${journal.id}" title="전체 수정"><i data-lucide="edit" class="w-5 h-5 text-gray-500"></i></button>
                                <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full delete-btn" data-id="${journal.id}" title="삭제"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-4">
                            <p><strong>진입:</strong> ${formatPrice(journal.entryPrice, journal.currency)} / <strong>${amountLabel}:</strong> ${formatNumber(totalAmount)}</p>
                            <p><strong>목표/손절:</strong> ${formatPrice(journal.targetPrice, journal.currency)} / ${formatPrice(journal.stopLoss, journal.currency)}</p>
                            ${futuresInfoHtml}
                            ${journal.exits && journal.exits.length > 0 ? `<p class="font-extrabold text-xl pt-2 ${pnlClass}"><strong>총 실현 손익:</strong> ${formatDualCurrency(totalPnlInKRW, journal.currency)}</p>` : ''}
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div><h4 class="font-semibold text-xs text-gray-500 dark:text-gray-400 mb-1">환경 태그</h4>${environmentTagHtml}</div>
                            <div><h4 class="font-semibold text-xs text-gray-500 dark:text-gray-400 mb-1">진입 근거</h4>${entryTagHtml}</div>
                            <div><h4 class="font-semibold text-xs text-gray-500 dark:text-gray-400 mb-1">심리 상태</h4>${psyTagHtml}</div>
                        </div>
                        
                        ${exitsHtml}
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-700 mt-auto">
                        <button class="flex items-center text-sm font-semibold gap-2 memo-btn text-gray-600 dark:text-gray-300 hover:text-blue-500" data-id="${journal.id}" title="매매 복기 및 소감 작성/수정">
                            ${memoIndicator}
                            <span>${journal.memo ? '메모 확인/수정' : '메모 작성'}</span>
                        </button>
                        <button class="flex items-center text-sm font-semibold gap-2 tag-edit-btn text-gray-600 dark:text-gray-300 hover:text-purple-500" data-id="${journal.id}" title="태그 추가/제거">
                            ${tagEditIcon}
                            <span>태그 수정</span>
                        </button>
                    </div>
                `;
                journalList.appendChild(card);
            });
            lucide.createIcons();
            addJournalListEventListeners();
        }

        async function handleOpenTagEditModal(e) {
            const journalId = e.currentTarget.dataset.id;
            // 로컬 저널에서 복사본을 가져와서 수정합니다.
            const journalData = JSON.parse(JSON.stringify(localJournals.find(j => j.id === journalId)));

            if (journalData) {
                document.getElementById('tag-edit-journal-id').value = journalId;
                
                // 태그 목록 렌더링 함수 호출
                renderTagEditOptions('tag-edit-environment-tags', 'environment', journalData.environmentTags || []); 
                renderTagEditOptions('tag-edit-entry-tags', 'entry', journalData.entryTags || []);
                renderTagEditOptions('tag-edit-psychology-tags', 'psychology', journalData.psychologyTags || []);

                openModal('tag-edit-modal');
            }
        }
        
        function renderTagEditOptions(containerId, type, selectedTags) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const availableTags = localTags[type] || [];
            
            let baseColor;
            if (type === 'environment') { baseColor = 'bg-yellow-500'; }
            else if (type === 'entry') { baseColor = 'bg-green-500'; }
            else { baseColor = 'bg-purple-500'; }


            availableTags.forEach(tag => {
                const isEntry = type === 'entry';
                // entry 태그의 경우 selectedTags는 객체 배열이므로 tagName만 추출
                const isSelected = isEntry ? selectedTags.some(t => t.tag === tag) : selectedTags.includes(tag);
                const tagData = isEntry ? selectedTags.find(t => t.tag === tag) : { tag, timeTags: [] };

                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.tag = tag;
                // fullTag 데이터셋을 추가하여 시간봉 정보 저장
                if (isEntry) {
                    button.dataset.fullTag = JSON.stringify(tagData);
                }
                
                button.className = `tag text-sm inline-flex items-center rounded-full px-3 py-1 font-medium transition-colors ${
                    isSelected 
                        ? `${baseColor} text-white selected`
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-[#4F4F4F] dark:text-gray-200 dark:hover:bg-[#666]'
                }`;

                button.textContent = tag;
                
                // entry 태그는 타임 모달 로직 (요청 1)
                if (isEntry) {
                     button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // 폼에 사용할 현재 상태 저장
                        document.getElementById('time-tag-journal-id').value = document.getElementById('tag-edit-journal-id').value;
                        document.getElementById('time-tag-name').value = tag;
                        
                        // 현재 태그에 저장된 시간봉 정보 로드
                        const currentTagObj = JSON.parse(e.currentTarget.dataset.fullTag);
                        const selectedTimes = currentTagObj?.timeTags || [];
                        
                        openTimeTagModal(tag, selectedTimes, true); // isEditMode = true
                    });
                } else {
                    // 일반 태그 토글 로직 (버튼 작동 복구)
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // 토글 로직: 선택된 상태라면 해제, 아니라면 선택
                        const isCurrentlySelected = e.currentTarget.classList.contains('selected');
                        if (isCurrentlySelected) {
                            e.currentTarget.classList.remove(`${baseColor}`, 'text-white', 'selected');
                            e.currentTarget.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-[#4F4F4F]', 'dark:text-gray-200', 'dark:hover:bg-[#666]');
                        } else {
                            e.currentTarget.classList.add(`${baseColor}`, 'text-white', 'selected');
                            e.currentTarget.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-[#4F4F4F]', 'dark:text-gray-200', 'dark:hover:bg-[#666]');
                        }
                    });
                }

                container.appendChild(button);
            });

            if (availableTags.length === 0) {
                 container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">등록된 태그가 없습니다. '일지 작성' 탭에서 태그를 추가해 주세요.</p>`;
            }
        }
        
        // 타임 태그 모달 열기 및 렌더링
        function openTimeTagModal(tagName, selectedTimes = [], isEditMode = false) {
            document.getElementById('time-tag-context').textContent = `'${tagName}'에 사용된 시간봉을 선택해주세요. (다중 선택 가능)`;
            const container = document.getElementById('time-tag-options-container');
            container.innerHTML = '';
            
            // isEditMode 상태를 저장하여 모달 내에서 토글 로직을 다르게 처리할 수 있도록 함
            document.getElementById('time-tag-modal').dataset.isEditMode = isEditMode;

            (localTags.time || []).forEach(timeTag => {
                const isSelected = selectedTimes.includes(timeTag);
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.timeTag = timeTag;
                
                button.className = `tag text-sm inline-flex items-center rounded-full px-3 py-1 font-medium transition-colors 
                                   ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-[#4F4F4F] dark:text-gray-200 dark:hover:bg-[#666]'}`;
                button.textContent = timeTag;
                
                // 다중 선택 가능 토글 로직
                button.addEventListener('click', () => {
                    button.classList.toggle('bg-blue-500');
                    button.classList.toggle('text-white');
                    button.classList.toggle('bg-gray-200');
                    button.classList.toggle('text-gray-700');
                    button.classList.toggle('dark:bg-[#4F4F4F]');
                    button.classList.toggle('dark:text-gray-200');
                });
                container.appendChild(button);
            });
            
            openModal('time-tag-modal');
        }
        
        // 타임 태그 모달 닫기
        document.getElementById('close-time-tag-modal-btn').addEventListener('click', () => closeModal('time-tag-modal'));
        
        // 타임 태그 저장 로직 (일지 작성 폼 및 수정 모달 모두 처리)
        document.getElementById('time-tag-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const tagName = document.getElementById('time-tag-name').value;
            const selectedTimeTags = Array.from(document.querySelectorAll('#time-tag-options-container button.bg-blue-500')).map(btn => btn.dataset.timeTag);
            
            if (selectedTimeTags.length === 0) {
                showToast("최소 1개의 시간봉을 선택해야 합니다.", "error");
                return;
            }
            
            const newTagObj = { tag: tagName, timeTags: selectedTimeTags };
            const isEditMode = document.getElementById('time-tag-modal').dataset.isEditMode === 'true';

            let tagContainerId = isEditMode ? '#tag-edit-entry-tags' : '.entry-tags-container';
            let currentTagButton = document.querySelector(`${tagContainerId} .tag[data-tag="${tagName}"]`);
            
            if (currentTagButton) {
                // 1. 선택 상태로 변경
                currentTagButton.classList.add('selected', 'bg-green-500', 'text-white');
                currentTagButton.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-[#4F4F4F]', 'dark:text-gray-200', 'dark:hover:bg-[#666]');

                // 2. dataset 업데이트
                currentTagButton.dataset.fullTag = JSON.stringify(newTagObj);
                
                // 3. 오버레이 업데이트
                let overlay = currentTagButton.querySelector('.time-tag-overlay');
                if (!overlay) {
                    overlay = document.createElement('span');
                    overlay.className = 'time-tag-overlay';
                    currentTagButton.appendChild(overlay);
                }
                overlay.textContent = selectedTimeTags[0];
                overlay.title = `시간봉: ${selectedTimeTags.join(', ')}`;
            }
            
            closeModal('time-tag-modal');
            showToast(`'${tagName}'에 시간봉 정보가 저장되었습니다.`);
        });
        
        // 태그 버튼 클릭 이벤트 재정의 (버튼 작동 복구)
        function addJournalTagEventListeners(containerId, isEntry = false) {
             const container = document.getElementById(containerId);
             container.querySelectorAll('.tag').forEach(button => {
                 const tag = button.dataset.tag;
                 let baseColor;
                 if (containerId.includes('environment')) { baseColor = 'bg-yellow-500'; }
                 else if (containerId.includes('entry')) { baseColor = 'bg-green-500'; }
                 else { baseColor = 'bg-purple-500'; }
                 
                 if (isEntry) {
                     // 진입 근거 태그는 타임 태그 모달 열기
                     button.addEventListener('click', (e) => {
                         e.stopPropagation();
                         document.getElementById('time-tag-journal-id').value = document.getElementById('journal-id').value;
                         document.getElementById('time-tag-name').value = tag;
                         
                         // 현재 저장된 시간봉 정보 로드
                         const currentTagObj = button.dataset.fullTag ? JSON.parse(button.dataset.fullTag) : { tag, timeTags: [] };
                         openTimeTagModal(tag, currentTagObj.timeTags);
                     });
                 } else {
                     // 환경, 심리 태그는 단순 토글 로직 (버튼 작동 복구)
                     button.addEventListener('click', (e) => {
                         e.stopPropagation();
                         const isCurrentlySelected = e.currentTarget.classList.contains('selected');
                         if (isCurrentlySelected) {
                             e.currentTarget.classList.remove('selected', `${baseColor}`, 'text-white');
                             e.currentTarget.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-[#4F4F4F]', 'dark:text-gray-200', 'dark:hover:bg-[#666]');
                         } else {
                             e.currentTarget.classList.add('selected', `${baseColor}`, 'text-white');
                             e.currentTarget.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-[#4F4F4F]', 'dark:text-gray-200', 'dark:hover:bg-[#666]');
                         }
                     });
                 }
             });
        }
        
        // 렌더링 후 이벤트 리스너 재부착
        function renderJournalTags(tags, containerId, type) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if(!tags) return;
            const isEntry = type === 'entry';
            let baseColor;
            if (type === 'environment') { baseColor = 'bg-yellow-500'; }
            else if (type === 'entry') { baseColor = 'bg-green-500'; }
            else { baseColor = 'bg-purple-500'; }

            tags.forEach(tag => {
                const button = document.createElement('button');
                button.type = 'button';
                
                button.className = 'tag bg-gray-200 text-gray-700 rounded-full text-sm inline-flex items-center dark:bg-[#4F4F4F] dark:text-gray-200';
                button.dataset.tag = tag;
                
                button.innerHTML = `<span class="pl-3 pr-2 py-1">${tag}</span><span class="delete-tag-span pr-2 text-gray-500 dark:text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></span>`;

                button.querySelector('.delete-tag-span').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteJournalTag(tag, type);
                });
                container.appendChild(button);
            });
            lucide.createIcons();
            // 이벤트 리스너 재부착
            addJournalTagEventListeners(containerId, isEntry); 
        }

        // ... (나머지 함수는 그대로 유지) ...
        
    </script>
</body>
</html>
